<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KnappShot - AI Photo Editor</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Space+Grotesk:wght@500;700&display=swap" rel="stylesheet">
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }

        /* Theme Variables */
        :root {
            /* Backgrounds */
            --bg-primary: #0a0a0f;
            --bg-secondary: rgba(255,255,255,0.02);
            --bg-tertiary: rgba(0,0,0,0.4);
            --bg-overlay: rgba(0,0,0,0.3);
            --bg-card: rgba(255,255,255,0.03);
            --bg-modal: linear-gradient(135deg, #1a1a2e 0%, #0f0f1a 100%);

            /* Text */
            --text-primary: #fff;
            --text-secondary: #9ca3af;
            --text-tertiary: #6b7280;
            --text-muted: #4b5563;
            --text-highlight: #d1d5db;

            /* Borders */
            --border-subtle: rgba(255,255,255,0.05);
            --border-light: rgba(255,255,255,0.08);
            --border-medium: rgba(255,255,255,0.1);
            --border-accent: rgba(255,255,255,0.15);

            /* Accent colors */
            --color-purple: #7c3aed;
            --color-pink: #ec4899;
            --color-amber: #f59e0b;
            --color-green: #10b981;
            --color-green-dark: #059669;
            --color-red: #ef4444;
            --color-cyan: #06b6d4;

            /* Derived colors */
            --color-purple-light: #c4b5fd;
            --color-pink-light: #f9a8d4;
            --color-green-light: #86efac;
            --color-red-light: #fca5a5;
        }

        [data-theme="light"] {
            --bg-primary: #f5f5f7;
            --bg-secondary: rgba(0,0,0,0.02);
            --bg-tertiary: rgba(255,255,255,0.9);
            --bg-overlay: rgba(255,255,255,0.8);
            --bg-card: rgba(0,0,0,0.02);
            --bg-modal: linear-gradient(135deg, #ffffff 0%, #f0f0f5 100%);

            --text-primary: #1a1a1a;
            --text-secondary: #4b5563;
            --text-tertiary: #6b7280;
            --text-muted: #9ca3af;
            --text-highlight: #374151;

            --border-subtle: rgba(0,0,0,0.05);
            --border-light: rgba(0,0,0,0.08);
            --border-medium: rgba(0,0,0,0.12);
            --border-accent: rgba(0,0,0,0.15);

            /* Darker greens for better visibility in light mode */
            --color-green: #047857;
            --color-green-dark: #065f46;
            --color-green-light: #059669;

            /* Darker purples and pinks for better visibility */
            --color-purple-light: #7c3aed;
            --color-pink-light: #db2777;

            /* Darker red for better visibility */
            --color-red-light: #dc2626;
        }

        /* Light mode product tag overrides */
        [data-theme="light"] .product-tag.golden {
            background: rgba(245, 158, 11, 0.2);
            color: #b45309;
        }

        [data-theme="light"] .product-tag.forbidden {
            background: rgba(239, 68, 68, 0.15);
            color: #dc2626;
        }

        /* Light mode gallery overlay text - keep light text on dark overlay */
        [data-theme="light"] .gallery-item-overlay {
            background: linear-gradient(transparent 40%, rgba(0,0,0,0.85));
        }
        [data-theme="light"] .gallery-item-prompt {
            color: #ffffff;
        }
        [data-theme="light"] .gallery-item-date {
            color: rgba(255,255,255,0.7);
        }

        /* Light mode collection styling */
        [data-theme="light"] .collection-chip {
            background: rgba(0,0,0,0.05);
            border-color: rgba(0,0,0,0.1);
            color: #374151;
        }
        [data-theme="light"] .collection-chip:hover {
            background: rgba(0,0,0,0.08);
            color: #1f2937;
        }
        [data-theme="light"] .collection-chip .collection-count {
            background: rgba(0,0,0,0.1);
            color: #4b5563;
        }
        [data-theme="light"] .collection-chip.active {
            background: linear-gradient(135deg, #7c3aed, #2563eb);
            border-color: transparent;
            color: #fff;
            box-shadow: 0 2px 8px rgba(124, 58, 237, 0.3);
        }
        [data-theme="light"] .collection-chip.active .collection-count {
            background: rgba(255,255,255,0.3);
            color: #fff;
        }
        [data-theme="light"] .collections-bar {
            background: rgba(0,0,0,0.03);
            border-color: rgba(0,0,0,0.08);
        }
        [data-theme="light"] .add-collection-btn {
            background: rgba(0,0,0,0.03);
            border-color: rgba(0,0,0,0.15);
            color: #6b7280;
        }
        [data-theme="light"] .add-collection-btn:hover {
            background: rgba(124,58,237,0.1);
        }

        /* Light mode collection modal styling */
        [data-theme="light"] .collection-modal-content {
            background: #ffffff;
            border-color: rgba(0,0,0,0.1);
        }
        [data-theme="light"] .collection-input {
            background: #f9fafb;
            border-color: rgba(0,0,0,0.15);
            color: #1f2937;
        }
        [data-theme="light"] .collection-input::placeholder {
            color: #9ca3af;
        }
        [data-theme="light"] .collection-modal-btn.cancel {
            background: #f3f4f6;
            color: #374151;
        }
        [data-theme="light"] .collection-modal-btn.cancel:hover {
            background: #e5e7eb;
            color: #1f2937;
        }
        [data-theme="light"] .existing-collection-item {
            background: #f9fafb;
        }
        [data-theme="light"] .existing-collection-actions button {
            border-color: rgba(0,0,0,0.1);
            color: #6b7280;
        }
        [data-theme="light"] .existing-collection-actions button:hover {
            background: #f3f4f6;
            color: #374151;
        }
        [data-theme="light"] .collections-label {
            color: #4b5563;
        }
        [data-theme="light"] .gallery-header h3 {
            color: #1f2937;
        }
        [data-theme="light"] .move-collection-option {
            color: #374151;
        }
        [data-theme="light"] .move-collection-option:hover {
            background: rgba(124, 58, 237, 0.1);
            color: #7c3aed;
        }

        /* Light mode tutorial styling */
        [data-theme="light"] .tutorial-btn {
            background: linear-gradient(135deg, #7c3aed, #2563eb);
            color: #fff;
        }
        [data-theme="light"] .tutorial-btn:hover {
            box-shadow: 0 4px 15px rgba(124, 58, 237, 0.4);
        }
        [data-theme="light"] .tutorial-tooltip {
            background: #ffffff;
            border-color: rgba(0,0,0,0.1);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);
        }
        [data-theme="light"] .tutorial-tooltip-arrow {
            background: #ffffff;
            border-color: rgba(0,0,0,0.1);
        }
        [data-theme="light"] .tutorial-step-dot {
            background: #e5e7eb;
        }
        [data-theme="light"] .tutorial-step-dot.completed {
            background: #10b981;
        }
        [data-theme="light"] .tutorial-start-content {
            background: #ffffff;
            border-color: rgba(0,0,0,0.1);
        }
        [data-theme="light"] .tutorial-start-btn.secondary {
            background: #f3f4f6;
            color: #374151;
        }
        [data-theme="light"] .tutorial-start-btn.secondary:hover {
            background: #e5e7eb;
        }
        [data-theme="light"] .tutorial-start-btn.primary,
        [data-theme="light"] .tutorial-next-btn {
            background: linear-gradient(135deg, #7c3aed, #2563eb) !important;
            color: #ffffff !important;
            border: none;
            box-shadow: 0 2px 8px rgba(124, 58, 237, 0.3);
        }
        [data-theme="light"] .tutorial-start-btn.primary:hover,
        [data-theme="light"] .tutorial-next-btn:hover {
            box-shadow: 0 4px 15px rgba(124, 58, 237, 0.4);
        }
        [data-theme="light"] .tutorial-prev-btn {
            background: #f3f4f6;
            color: #374151;
        }
        [data-theme="light"] .tutorial-prev-btn:hover {
            background: #e5e7eb;
        }
        [data-theme="light"] .tutorial-skip-btn {
            color: #6b7280;
        }
        [data-theme="light"] .tutorial-skip-btn:hover {
            background: #f3f4f6;
            color: #374151;
        }

        /* Light mode editor model select and mega output */
        [data-theme="light"] .prompt-model-select select {
            background: #ffffff;
            border-color: rgba(0,0,0,0.15);
            color: #1f2937;
        }
        [data-theme="light"] .editor-mega-output {
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.08) 0%, rgba(124, 58, 237, 0.08) 100%);
            border-color: rgba(245, 158, 11, 0.25);
        }
        [data-theme="light"] .editor-mega-output-actions button {
            background: #ffffff;
            border-color: rgba(0,0,0,0.15);
            color: #374151;
        }
        [data-theme="light"] .editor-mega-section p,
        [data-theme="light"] .editor-mega-section li {
            color: #4b5563;
        }

        /* Light mode mobile menu */
        [data-theme="light"] .mobile-menu-btn {
            background: #ffffff;
            border-color: rgba(0,0,0,0.15);
        }
        [data-theme="light"] .hamburger-icon span {
            background: #374151;
        }
        [data-theme="light"] .mobile-menu {
            background: #ffffff;
            border-color: rgba(0,0,0,0.1);
        }
        [data-theme="light"] .mobile-menu-close {
            background: #f3f4f6;
            color: #6b7280;
        }
        [data-theme="light"] .mobile-menu-item {
            background: #f3f4f6;
            color: #1f2937;
        }
        [data-theme="light"] .mobile-menu-item:hover {
            background: #e5e7eb;
        }
        [data-theme="light"] .mobile-menu-user {
            background: #f3f4f6;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-primary);
            min-height: 100vh;
            color: var(--text-primary);
            padding: 20px;
            overflow-x: hidden;
            transition: background 0.3s ease, color 0.3s ease;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background:
                radial-gradient(ellipse at 20% 20%, rgba(120, 0, 255, 0.15) 0%, transparent 50%),
                radial-gradient(ellipse at 80% 80%, rgba(255, 0, 128, 0.15) 0%, transparent 50%),
                radial-gradient(ellipse at 50% 50%, rgba(0, 200, 255, 0.08) 0%, transparent 60%);
            pointer-events: none;
            z-index: -1;
            animation: bgPulse 15s ease-in-out infinite;
        }

        @keyframes bgPulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }

        .container { max-width: 1200px; margin: 0 auto; }

        /* Header */
        .header { text-align: center; margin-bottom: 30px; }
        .logo { display: inline-flex; align-items: center; gap: 12px; margin-bottom: 8px; }
        .logo-icon {
            width: 48px; height: 48px;
            background: linear-gradient(135deg, #7c3aed, #ec4899, #f59e0b);
            border-radius: 14px;
            display: flex; align-items: center; justify-content: center;
            font-size: 24px; font-weight: 700; color: #fff;
            box-shadow: 0 8px 32px rgba(124, 58, 237, 0.4);
            animation: logoGlow 3s ease-in-out infinite;
        }
        @keyframes logoGlow {
            0%, 100% { box-shadow: 0 8px 32px rgba(124, 58, 237, 0.4); }
            50% { box-shadow: 0 8px 48px rgba(236, 72, 153, 0.5); }
        }
        h1 {
            font-family: 'Space Grotesk', sans-serif;
            font-size: 2.5rem; font-weight: 700;
            background: linear-gradient(135deg, #fff 0%, #c4b5fd 50%, #f9a8d4 100%);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .tagline { color: var(--text-tertiary); font-size: 0.9rem; margin-top: 6px; }

        /* Welcome Banner */
        .welcome-banner {
            background: linear-gradient(135deg, rgba(6, 182, 212, 0.15) 0%, rgba(124, 58, 237, 0.15) 100%);
            border: 1px solid rgba(6, 182, 212, 0.3);
            border-radius: 14px;
            padding: 16px 20px;
            margin-bottom: 20px;
            display: none;
        }
        .welcome-banner.show { display: block; }
        .welcome-content {
            display: flex;
            align-items: center;
            gap: 14px;
            flex-wrap: wrap;
        }
        .welcome-icon { font-size: 1.8rem; }
        .welcome-text { flex: 1; min-width: 200px; }
        .welcome-text strong { color: var(--text-primary); font-size: 1rem; display: block; margin-bottom: 2px; }
        .welcome-text p { color: var(--text-secondary); font-size: 0.85rem; margin: 0; }
        .welcome-btn {
            padding: 10px 20px;
            background: linear-gradient(135deg, var(--color-cyan), var(--color-purple));
            color: #fff;
            font-size: 0.85rem;
            font-weight: 600;
            text-decoration: none;
            border-radius: 8px;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .welcome-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 16px rgba(6, 182, 212, 0.4); }
        .welcome-dismiss {
            width: 28px; height: 28px;
            border: none; border-radius: 6px;
            background: rgba(255,255,255,0.1);
            color: var(--text-secondary);
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .welcome-dismiss:hover { background: rgba(255,255,255,0.2); color: var(--text-primary); }

        /* Tabs */
        .tabs {
            display: flex; gap: 8px; margin-bottom: 24px;
            background: var(--bg-secondary);
            padding: 8px; border-radius: 16px;
            border: 1px solid var(--border-subtle);
        }
        .tab {
            flex: 1; padding: 12px 20px;
            border: none; border-radius: 10px;
            background: transparent; color: var(--text-secondary);
            font-size: 0.9rem; font-weight: 600; font-family: inherit;
            cursor: pointer; transition: all 0.25s ease;
        }
        .tab:hover { color: var(--text-primary); background: var(--border-subtle); }
        .tab.active {
            background: linear-gradient(135deg, rgba(124,58,237,0.3) 0%, rgba(236,72,153,0.3) 100%);
            color: var(--text-primary);
        }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* Config Section */
        .config-section {
            background: linear-gradient(135deg, var(--bg-card) 0%, var(--bg-secondary) 100%);
            border: 1px solid var(--border-subtle);
            border-radius: 20px; padding: 20px; margin-bottom: 20px;
        }
        .config-section h2 {
            font-size: 0.75rem; font-weight: 600;
            text-transform: uppercase; letter-spacing: 0.1em;
            margin-bottom: 14px; color: var(--text-secondary);
        }
        .config-row { display: flex; gap: 14px; flex-wrap: wrap; }
        .config-field { flex: 1; min-width: 240px; }
        .config-field label { display: block; margin-bottom: 6px; font-size: 0.85rem; font-weight: 500; color: var(--text-highlight); }
        .config-field input, .config-field select {
            width: 100%; padding: 12px 16px;
            border: 1px solid var(--border-light);
            border-radius: 10px; background: var(--bg-tertiary);
            color: var(--text-primary); font-size: 0.9rem; font-family: inherit;
            transition: all 0.3s ease;
        }
        .config-field input:focus, .config-field select:focus {
            outline: none; border-color: var(--color-purple);
            box-shadow: 0 0 0 3px rgba(124, 58, 237, 0.2);
        }
        .config-field input::placeholder { color: var(--text-muted); }
        .api-key-help {
            display: block;
            margin-top: 8px;
            font-size: 0.8rem;
            color: var(--color-cyan);
            text-decoration: none;
            transition: color 0.2s ease;
        }
        .api-key-help:hover { color: var(--color-purple-light); text-decoration: underline; }

        /* Config Actions */
        .config-actions {
            display: flex; gap: 10px; margin-top: 14px; align-items: center; flex-wrap: wrap;
        }
        .config-btn {
            padding: 8px 16px; font-size: 0.8rem; font-weight: 600;
            font-family: inherit; border: none; border-radius: 8px;
            cursor: pointer; transition: all 0.25s ease;
        }
        .config-btn.save {
            background: linear-gradient(135deg, var(--color-green), var(--color-green-dark));
            color: #fff;
        }
        .config-btn.load {
            background: linear-gradient(135deg, var(--color-purple), #6366f1);
            color: #fff;
        }
        .config-btn.clear {
            background: var(--bg-overlay);
            border: 1px solid var(--border-medium);
            color: var(--text-secondary);
        }
        .config-btn:hover { transform: translateY(-2px); }
        .config-btn.clear:hover { border-color: var(--color-red); color: var(--color-red-light); }
        .credentials-status {
            font-size: 0.8rem; color: var(--color-green-light); font-weight: 500;
            opacity: 0; transition: opacity 0.3s ease;
        }
        .credentials-status.show { opacity: 1; }

        /* Main Grid */
        .main-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        @media (max-width: 900px) { .main-grid { grid-template-columns: 1fr; } }

        /* Upload Area */
        .upload-area {
            background: linear-gradient(135deg, rgba(124,58,237,0.05) 0%, rgba(236,72,153,0.05) 100%);
            border: 2px dashed rgba(124,58,237,0.3);
            border-radius: 20px; padding: 30px;
            text-align: center; cursor: pointer;
            transition: all 0.4s ease;
            min-height: 280px;
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            position: relative;
        }
        .upload-area:hover, .upload-area.drag-over {
            border-color: #7c3aed;
            background: linear-gradient(135deg, rgba(124,58,237,0.1) 0%, rgba(236,72,153,0.1) 100%);
        }
        .upload-area img { max-width: 100%; max-height: 220px; border-radius: 12px; margin-bottom: 10px; }
        .upload-icon { font-size: 3rem; margin-bottom: 12px; opacity: 0.7; }
        .upload-text { color: var(--text-secondary); font-size: 0.9rem; line-height: 1.5; }
        .upload-text strong { color: var(--color-purple-light); }

        /* Reference Image Area */
        .ref-upload-area {
            background: var(--bg-secondary);
            border: 1px dashed var(--border-accent);
            border-radius: 12px; padding: 16px;
            text-align: center; cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 12px;
        }
        .ref-upload-area:hover { border-color: var(--color-purple); }
        .ref-upload-area img { max-height: 80px; border-radius: 8px; }
        .ref-upload-area .ref-label { font-size: 0.8rem; color: var(--text-tertiary); }

        /* Product Image Loader */
        .product-image-loader {
            margin-top: 12px;
            padding: 12px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-subtle);
            border-radius: 12px;
        }
        .product-image-loader label {
            display: block;
            font-size: 0.75rem;
            font-weight: 500;
            color: var(--text-tertiary);
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        .product-image-loader select {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--border-light);
            border-radius: 8px;
            background: var(--bg-tertiary);
            color: var(--text-primary);
            font-size: 0.85rem;
            font-family: inherit;
            cursor: pointer;
        }
        .product-image-loader select:focus {
            outline: none;
            border-color: var(--color-purple);
        }

        /* Result Area */
        .result-area {
            background: var(--bg-secondary);
            border: 1px solid var(--border-subtle);
            border-radius: 20px; padding: 20px;
            min-height: 280px;
            display: flex; flex-direction: column;
            align-items: center;
        }
        .result-area:has(.result-placeholder) {
            justify-content: center;
        }
        .result-area:has(.result-header) {
            justify-content: flex-start;
        }
        .result-area img { max-width: 100%; max-height: 240px; border-radius: 12px; }
        .result-placeholder { color: var(--text-muted); text-align: center; font-size: 0.9rem; }
        .result-placeholder span { display: block; font-size: 2.5rem; margin-bottom: 10px; opacity: 0.5; }
        .result-header {
            width: 100%;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--border-subtle);
        }
        .result-header-title {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        .result-clear-btn {
            padding: 6px 12px;
            font-size: 0.75rem;
            font-weight: 600;
            font-family: inherit;
            border: 1px solid var(--border-medium);
            border-radius: 6px;
            background: transparent;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .result-clear-btn:hover {
            border-color: var(--color-red);
            color: var(--color-red-light);
            background: rgba(239, 68, 68, 0.1);
        }

        /* Result Loading Indicator */
        .result-loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px 20px;
        }
        .result-loading-spinner {
            width: 50px;
            height: 50px;
            border: 3px solid var(--border-light);
            border-top-color: var(--color-purple);
            border-radius: 50%;
            animation: resultSpin 1s linear infinite;
            margin-bottom: 16px;
        }
        @keyframes resultSpin {
            to { transform: rotate(360deg); }
        }
        .result-loading-text {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 6px;
        }
        .result-loading-subtext {
            font-size: 0.85rem;
            color: var(--text-tertiary);
        }

        /* Before/After Slider */
        .comparison-container {
            position: relative; width: 100%; max-width: 100%;
            border-radius: 12px; overflow: hidden;
            touch-action: none;
        }
        .comparison-container img { display: block; width: 100%; height: auto; }
        .comparison-before {
            position: absolute; top: 0; left: 0; width: 50%; height: 100%;
            overflow: hidden;
        }
        .comparison-before img { position: absolute; top: 0; left: 0; width: 200%; max-width: none; }
        .comparison-slider {
            position: absolute; top: 0; bottom: 0; width: 4px;
            background: #fff; left: 50%; cursor: ew-resize;
            box-shadow: 0 0 10px rgba(0,0,0,0.5);
        }
        .comparison-slider::before {
            content: ''; position: absolute;
            top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 40px; height: 40px; border-radius: 50%;
            background: #fff; border: 3px solid #7c3aed;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        .comparison-label {
            position: absolute; bottom: 10px; padding: 4px 12px;
            background: rgba(0,0,0,0.7); border-radius: 20px;
            font-size: 0.75rem; font-weight: 600;
        }
        .comparison-label.before { left: 10px; }
        .comparison-label.after { right: 10px; }

        /* Prompt Section */
        .prompt-section { margin-top: 20px; position: relative; }
        .prompt-wrapper { position: relative; }
        .prompt-section textarea {
            width: 100%; padding: 16px;
            border: 1px solid var(--border-light);
            border-radius: 14px; background: transparent;
            color: var(--text-primary); font-size: 0.95rem;
            resize: none; min-height: 90px; max-height: 500px;
            font-family: inherit; line-height: 1.6;
            transition: all 0.3s ease;
            white-space: pre-wrap;
            overflow-y: auto;
            position: relative;
            z-index: 2;
        }
        .prompt-section textarea:focus { outline: none; border-color: var(--color-purple); }
        .prompt-section textarea::placeholder { color: var(--text-muted); }

        /* Highlight backdrop for @mentions */
        .prompt-highlight-backdrop {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            padding: 16px;
            border: 1px solid transparent;
            border-radius: 14px;
            background: var(--bg-tertiary);
            font-size: 0.95rem;
            font-family: inherit;
            line-height: 1.6;
            white-space: pre-wrap;
            word-wrap: break-word;
            overflow: hidden;
            pointer-events: none;
            z-index: 1;
            color: transparent;
        }
        .prompt-highlight-backdrop .mention-highlight {
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.3), rgba(168, 85, 247, 0.3));
            color: transparent;
            border-radius: 4px;
            padding: 1px 0;
        }

        /* @ Mention Dropdown */
        .mention-dropdown {
            position: absolute;
            bottom: calc(100% + 8px);
            left: 16px;
            width: 280px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-light);
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.4);
            z-index: 1000;
            display: none;
            overflow: hidden;
        }
        .mention-dropdown.active { display: block; }
        .mention-dropdown-header {
            padding: 10px 14px;
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 1px solid var(--border-light);
            background: var(--bg-tertiary);
        }
        .mention-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 14px;
            cursor: pointer;
            transition: background 0.15s ease;
        }
        .mention-item:hover, .mention-item.selected {
            background: var(--color-purple-transparent);
        }
        .mention-item-icon {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            background: var(--bg-tertiary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            overflow: hidden;
        }
        .mention-item-icon img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .mention-item-info {
            flex: 1;
            min-width: 0;
        }
        .mention-item-name {
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--text-primary);
        }
        .mention-item-desc {
            font-size: 0.75rem;
            color: var(--text-muted);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .mention-tag {
            background: linear-gradient(135deg, var(--color-purple), var(--color-purple-light));
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.85rem;
            font-weight: 500;
        }

        .prompt-actions {
            display: flex;
            gap: 8px;
            margin-top: 10px;
            justify-content: flex-end;
        }

        .enhance-btn {
            height: 36px; padding: 0 14px;
            border: none; border-radius: 8px;
            background: linear-gradient(135deg, #f59e0b, #ef4444);
            color: #fff; font-size: 13px; font-weight: 500;
            cursor: pointer; transition: all 0.25s ease;
            display: flex; align-items: center; gap: 6px;
        }
        .enhance-btn:hover { transform: scale(1.05); box-shadow: 0 4px 12px rgba(245, 158, 11, 0.4); }
        .enhance-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }

        .prompt-actions-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 12px;
            margin-top: 10px;
        }
        .prompt-model-select select {
            padding: 8px 12px;
            border: 1px solid var(--border-medium);
            border-radius: 8px;
            background: var(--bg-tertiary);
            color: var(--text-primary);
            font-size: 0.8rem;
            font-family: inherit;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .prompt-model-select select:hover {
            border-color: var(--color-purple);
        }
        .prompt-model-select select:focus {
            outline: none;
            border-color: var(--color-purple);
        }
        .model-select-note {
            display: block;
            font-size: 0.7rem;
            color: var(--text-muted);
            margin-top: 4px;
            font-style: italic;
        }

        .mega-prompt-editor-btn {
            height: 36px; padding: 0 14px;
            border: none; border-radius: 8px;
            background: linear-gradient(135deg, #f59e0b, #ec4899);
            color: #fff; font-size: 13px; font-weight: 500;
            cursor: pointer; transition: all 0.25s ease;
            display: flex; align-items: center; gap: 6px;
        }
        .mega-prompt-editor-btn:hover { transform: scale(1.05); box-shadow: 0 4px 12px rgba(245, 158, 11, 0.4); }
        .mega-prompt-editor-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }

        /* Editor Mega Prompt Output */
        .editor-mega-output {
            display: none;
            margin-top: 16px;
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.05) 0%, rgba(124, 58, 237, 0.05) 100%);
            border: 1px solid rgba(245, 158, 11, 0.2);
            border-radius: 12px;
            padding: 16px;
        }
        .editor-mega-output.show { display: block; }
        .editor-mega-output-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border-subtle);
        }
        .editor-mega-output-header h4 {
            font-size: 0.9rem;
            color: var(--text-primary);
            margin: 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .editor-mega-output-header h4::before {
            content: '';
            width: 6px;
            height: 6px;
            background: linear-gradient(135deg, #f59e0b, #ec4899);
            border-radius: 50%;
        }
        .editor-mega-output-actions {
            display: flex;
            gap: 6px;
        }
        .editor-mega-output-actions button {
            padding: 6px 10px;
            font-size: 0.75rem;
            font-weight: 600;
            font-family: inherit;
            border: 1px solid var(--border-medium);
            border-radius: 6px;
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .editor-mega-output-actions button:hover {
            border-color: var(--color-purple);
            color: var(--text-primary);
        }
        .editor-mega-output-actions .use-btn {
            background: linear-gradient(135deg, #f59e0b, #ec4899);
            border: none;
            color: #fff;
        }
        .editor-mega-output-actions .use-btn:hover {
            transform: scale(1.02);
            box-shadow: 0 2px 8px rgba(245, 158, 11, 0.3);
        }
        .editor-mega-section {
            margin-bottom: 12px;
        }
        .editor-mega-section:last-child { margin-bottom: 0; }
        .editor-mega-section h5 {
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin: 0 0 6px 0;
            padding: 4px 8px;
            border-radius: 4px;
            display: inline-block;
        }
        .editor-mega-section h5.situation { background: rgba(59, 130, 246, 0.15); color: #3b82f6; }
        .editor-mega-section h5.task { background: rgba(16, 185, 129, 0.15); color: #10b981; }
        .editor-mega-section h5.objective { background: rgba(245, 158, 11, 0.15); color: #f59e0b; }
        .editor-mega-section h5.visual { background: rgba(139, 92, 246, 0.15); color: #8b5cf6; }
        .editor-mega-section h5.negative { background: rgba(239, 68, 68, 0.15); color: #ef4444; }
        .editor-mega-section h5.tech { background: rgba(107, 114, 128, 0.15); color: #6b7280; }
        .editor-mega-section p, .editor-mega-section ul {
            font-size: 0.85rem;
            color: var(--text-secondary);
            line-height: 1.5;
            margin: 0;
        }
        .editor-mega-section ul {
            padding-left: 20px;
        }
        .editor-mega-section li {
            margin-bottom: 4px;
        }

        /* Style Presets */
        .presets-section { margin-top: 16px; }
        .presets-label { font-size: 0.75rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.08em; color: var(--text-secondary); margin-bottom: 10px; }
        .presets-grid { display: flex; gap: 8px; flex-wrap: wrap; }
        .preset-btn {
            padding: 8px 14px; border: 1px solid var(--border-medium);
            border-radius: 20px; background: var(--bg-overlay);
            color: var(--text-secondary); font-size: 0.8rem; font-weight: 500;
            font-family: inherit; cursor: pointer; transition: all 0.25s ease;
            display: flex; align-items: center; gap: 6px;
        }
        .preset-btn:hover { border-color: var(--color-purple); color: var(--text-primary); background: rgba(124,58,237,0.15); }
        .preset-btn span { font-size: 1rem; }

        /* Quick Actions */
        .quick-actions { margin-top: 16px; }
        .quick-actions-grid { display: flex; gap: 8px; flex-wrap: wrap; }
        .quick-action-btn {
            padding: 10px 16px; border: 1px solid rgba(16, 185, 129, 0.3);
            border-radius: 10px; background: rgba(16, 185, 129, 0.1);
            color: var(--color-green-light); font-size: 0.85rem; font-weight: 500;
            font-family: inherit; cursor: pointer; transition: all 0.25s ease;
        }
        .quick-action-btn:hover {
            background: rgba(16, 185, 129, 0.2);
            border-color: var(--color-green); color: var(--text-primary);
        }

        /* Options Section */
        .options-section { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-top: 16px; }
        @media (max-width: 900px) { .options-section { grid-template-columns: repeat(2, 1fr); } }
        .option-group {
            background: var(--bg-secondary);
            border: 1px solid var(--border-subtle);
            border-radius: 12px; padding: 12px;
        }
        .option-group label {
            display: block; margin-bottom: 8px;
            font-size: 0.7rem; font-weight: 600;
            text-transform: uppercase; letter-spacing: 0.08em; color: var(--text-secondary);
        }
        .option-buttons { display: flex; gap: 6px; flex-wrap: wrap; }
        .option-btn {
            padding: 8px 12px; border: 1px solid var(--border-medium);
            border-radius: 8px; background: var(--bg-overlay);
            color: var(--text-secondary); font-size: 0.8rem; font-weight: 500;
            font-family: inherit; cursor: pointer; transition: all 0.25s ease;
        }
        .option-btn:hover { border-color: rgba(124,58,237,0.5); color: var(--text-primary); }
        .option-btn.active {
            border-color: var(--color-purple);
            background: linear-gradient(135deg, rgba(124,58,237,0.2) 0%, rgba(236,72,153,0.2) 100%);
            color: var(--text-primary);
        }

        /* Aspect Ratio Tooltip */
        .aspect-btn {
            position: relative;
        }
        .aspect-tooltip {
            position: absolute;
            bottom: calc(100% + 10px);
            left: 50%;
            transform: translateX(-50%);
            background: var(--bg-modal);
            border: 1px solid var(--border-medium);
            border-radius: 10px;
            padding: 12px 16px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            opacity: 0;
            visibility: hidden;
            transition: all 0.2s ease;
            z-index: 100;
            box-shadow: 0 8px 24px rgba(0,0,0,0.3);
            pointer-events: none;
        }
        .aspect-tooltip::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 6px solid transparent;
            border-top-color: var(--border-medium);
        }
        .aspect-btn:hover .aspect-tooltip {
            opacity: 1;
            visibility: visible;
        }
        .aspect-preview {
            background: linear-gradient(135deg, var(--color-purple), var(--color-pink));
            border-radius: 4px;
            opacity: 0.8;
        }
        .aspect-tooltip span {
            font-size: 0.7rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            white-space: nowrap;
            font-weight: 500;
        }

        /* Submit Button */
        .submit-btn {
            width: 100%; margin-top: 20px; padding: 16px 28px;
            font-size: 1.05rem; font-weight: 600; font-family: inherit;
            border: none; border-radius: 12px;
            background: linear-gradient(135deg, #7c3aed 0%, #ec4899 100%);
            color: #fff; cursor: pointer;
            transition: all 0.3s ease;
            position: relative; overflow: hidden;
        }
        .submit-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 16px 32px rgba(124, 58, 237, 0.4);
        }
        .submit-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .submit-btn span { position: relative; z-index: 1; }

        /* Status */
        .status {
            text-align: center; margin-top: 14px; padding: 12px 18px;
            border-radius: 10px; display: none; font-weight: 500; font-size: 0.9rem;
        }
        .status.error { display: block; background: rgba(239, 68, 68, 0.15); border: 1px solid rgba(239, 68, 68, 0.3); color: var(--color-red-light); }
        .status.success { display: block; background: rgba(34, 197, 94, 0.15); border: 1px solid rgba(34, 197, 94, 0.3); color: var(--color-green-light); }
        .status.loading { display: block; background: rgba(124, 58, 237, 0.15); border: 1px solid rgba(124, 58, 237, 0.3); color: var(--color-purple-light); }

        .loader {
            display: inline-block; width: 16px; height: 16px;
            border: 2px solid #c4b5fd; border-top-color: transparent;
            border-radius: 50%; animation: spin 0.8s linear infinite;
            margin-right: 8px; vertical-align: middle;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        .hidden-input { display: none; }

        /* Action Buttons */
        .action-btn {
            padding: 10px 18px; font-size: 0.85rem; font-weight: 600;
            font-family: inherit; border: none; border-radius: 8px;
            color: #fff; cursor: pointer; transition: all 0.25s ease;
        }
        .action-btn:hover { transform: translateY(-2px); }
        .action-btn.download { background: linear-gradient(135deg, #10b981, #059669); }
        .action-btn.ideas { background: linear-gradient(135deg, #7c3aed, #6366f1); }
        .action-btn.chain { background: linear-gradient(135deg, #f59e0b, #d97706); }
        .action-btn.favorite { background: linear-gradient(135deg, #ec4899, #be185d); }
        .action-btn.compare { background: linear-gradient(135deg, #06b6d4, #0891b2); }
        .action-btn.save { background: linear-gradient(135deg, #8b5cf6, #7c3aed); }

        .clear-btn {
            margin-top: 10px; padding: 8px 16px;
            font-size: 0.8rem; font-weight: 500; font-family: inherit;
            border: 1px solid var(--border-accent);
            border-radius: 8px; background: var(--bg-overlay);
            color: var(--text-secondary); cursor: pointer; transition: all 0.25s ease;
        }
        .clear-btn:hover { border-color: var(--color-red); color: var(--color-red-light); }

        /* Results Grid */
        .results-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 14px; width: 100%; }
        .result-item {
            position: relative; border-radius: 12px; overflow: hidden;
            box-shadow: 0 8px 24px rgba(0,0,0,0.3);
        }
        .result-item img { width: 100%; height: auto; display: block; cursor: pointer; transition: transform 0.3s ease; }
        .result-item:hover img { transform: scale(1.05); }
        .result-item-actions {
            position: absolute; bottom: 0; left: 0; right: 0;
            padding: 8px; display: flex; gap: 6px; justify-content: center;
            background: linear-gradient(transparent, rgba(0,0,0,0.8));
            opacity: 0; transition: opacity 0.3s ease;
        }
        .result-item:hover .result-item-actions { opacity: 1; }
        .result-item-actions button {
            padding: 6px 10px; font-size: 0.7rem; font-weight: 600;
            font-family: inherit; border: none; border-radius: 6px;
            cursor: pointer; transition: all 0.2s ease;
        }
        .result-item-actions .download-btn { background: #10b981; color: #fff; }
        .result-item-actions .chain-btn { background: #f59e0b; color: #fff; }
        .result-item-actions .fav-btn { background: #ec4899; color: #fff; }
        .result-item-actions .ideas-btn { background: #7c3aed; color: #fff; }

        /* Gallery Tab */
        .gallery-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
        .gallery-header h3 { font-size: 1.1rem; color: var(--text-primary); }
        .gallery-filters { display: flex; gap: 8px; }
        .filter-btn {
            padding: 8px 14px; border: 1px solid var(--border-medium);
            border-radius: 8px; background: transparent;
            color: var(--text-secondary); font-size: 0.8rem; font-weight: 500;
            font-family: inherit; cursor: pointer; transition: all 0.25s ease;
        }
        .filter-btn:hover, .filter-btn.active { border-color: var(--color-purple); color: var(--text-primary); }

        .gallery-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 16px;
        }
        .gallery-item {
            position: relative; border-radius: 12px; overflow: hidden;
            background: var(--bg-secondary);
            border: 1px solid var(--border-subtle);
            cursor: pointer; transition: all 0.3s ease;
        }
        .gallery-item:hover { border-color: var(--color-purple); transform: translateY(-4px); }
        .gallery-item img { width: 100%; aspect-ratio: 1; object-fit: cover; }
        .gallery-item-overlay {
            position: absolute; inset: 0;
            background: linear-gradient(transparent 50%, rgba(0,0,0,0.8));
            opacity: 0; transition: opacity 0.3s ease;
            display: flex; align-items: flex-end; padding: 10px;
        }
        .gallery-item:hover .gallery-item-overlay { opacity: 1; }
        .gallery-item-info { width: 100%; }
        .gallery-item-prompt { font-size: 0.75rem; color: var(--text-highlight); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .gallery-item-date { font-size: 0.65rem; color: var(--text-tertiary); margin-top: 4px; }
        .gallery-item-fav {
            position: absolute; top: 8px; right: 8px;
            font-size: 1rem; opacity: 0; transition: opacity 0.3s ease;
            cursor: pointer;
            z-index: 10;
        }
        .gallery-item:hover .gallery-item-fav, .gallery-item.favorited .gallery-item-fav { opacity: 1; }
        .gallery-item.favorited .gallery-item-fav { color: #ec4899; }

        .gallery-item-delete {
            position: absolute; top: 8px; left: 8px;
            width: 28px; height: 28px;
            background: rgba(239, 68, 68, 0.9);
            border: none; border-radius: 50%;
            color: #fff; font-size: 1rem;
            cursor: pointer; opacity: 0;
            transition: all 0.3s ease;
            display: flex; align-items: center; justify-content: center;
            z-index: 10;
        }
        .gallery-item:hover .gallery-item-delete { opacity: 1; }
        .gallery-item-delete:hover { background: #dc2626; transform: scale(1.1); }

        .gallery-empty {
            text-align: center; padding: 60px 20px; color: var(--text-tertiary);
        }
        .gallery-empty span { display: block; font-size: 3rem; margin-bottom: 12px; opacity: 0.5; }

        /* Collections */
        .collections-bar {
            display: flex; align-items: center; gap: 10px;
            margin-bottom: 16px; padding: 12px 16px;
            background: var(--bg-secondary); border: 1px solid var(--border-subtle);
            border-radius: 12px; flex-wrap: wrap;
        }
        .collections-label {
            font-size: 0.8rem; color: var(--text-tertiary); font-weight: 500;
        }
        .collections-list {
            display: flex; gap: 8px; flex-wrap: wrap; flex: 1;
        }
        .collection-chip {
            display: flex; align-items: center; gap: 6px;
            padding: 6px 12px; border-radius: 20px;
            background: var(--bg-tertiary); border: 1px solid var(--border-subtle);
            color: var(--text-secondary); font-size: 0.8rem;
            cursor: pointer; transition: all 0.25s ease;
            font-family: inherit;
        }
        .collection-chip:hover {
            border-color: var(--color-purple); color: var(--text-primary);
        }
        .collection-chip.active {
            background: linear-gradient(135deg, var(--color-purple), var(--color-blue));
            border-color: transparent; color: #fff;
        }
        .collection-chip .collection-count {
            background: rgba(255,255,255,0.2); padding: 2px 6px;
            border-radius: 10px; font-size: 0.7rem;
        }
        .collection-chip.active .collection-count {
            background: rgba(255,255,255,0.3);
        }
        .collection-chip.drag-over {
            background: linear-gradient(135deg, var(--color-purple), var(--color-blue));
            border-color: transparent;
            color: #fff;
            transform: scale(1.05);
            box-shadow: 0 4px 15px rgba(124, 58, 237, 0.4);
        }
        .collection-chip.drag-over .collection-count {
            background: rgba(255,255,255,0.3);
        }
        .gallery-item.dragging {
            opacity: 0.5;
            transform: scale(0.95);
        }
        .add-collection-btn {
            width: 32px; height: 32px; border-radius: 50%;
            background: var(--bg-tertiary); border: 1px dashed var(--border-medium);
            color: var(--text-tertiary); font-size: 1.2rem;
            cursor: pointer; transition: all 0.25s ease;
            display: flex; align-items: center; justify-content: center;
        }
        .add-collection-btn:hover {
            border-color: var(--color-purple); color: var(--color-purple);
            border-style: solid;
        }

        /* Collection Modal */
        .collection-modal {
            position: fixed; inset: 0; background: rgba(0,0,0,0.8);
            display: flex; align-items: center; justify-content: center;
            z-index: 10000; opacity: 0; visibility: hidden;
            transition: all 0.3s ease;
        }
        .collection-modal.active { opacity: 1; visibility: visible; }
        .collection-modal-content {
            background: var(--bg-primary); border-radius: 16px;
            padding: 24px; width: 90%; max-width: 400px;
            border: 1px solid var(--border-subtle);
        }
        .collection-modal-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 20px;
        }
        .collection-modal-header h3 {
            font-size: 1.1rem; color: var(--text-primary);
        }
        .collection-modal-close {
            width: 32px; height: 32px; border-radius: 8px;
            background: transparent; border: none;
            color: var(--text-tertiary); font-size: 1.2rem;
            cursor: pointer; transition: all 0.25s ease;
        }
        .collection-modal-close:hover {
            background: var(--bg-secondary); color: var(--text-primary);
        }
        .collection-input {
            width: 100%; padding: 12px 16px;
            background: var(--bg-secondary); border: 1px solid var(--border-subtle);
            border-radius: 10px; color: var(--text-primary);
            font-size: 0.95rem; font-family: inherit;
            margin-bottom: 16px;
        }
        .collection-input:focus {
            outline: none; border-color: var(--color-purple);
        }
        .collection-modal-actions {
            display: flex; gap: 10px; justify-content: flex-end;
        }
        .collection-modal-btn {
            padding: 10px 20px; border-radius: 10px;
            font-size: 0.9rem; font-weight: 500;
            cursor: pointer; transition: all 0.25s ease;
            font-family: inherit; border: none;
        }
        .collection-modal-btn.cancel {
            background: var(--bg-secondary); color: var(--text-secondary);
        }
        .collection-modal-btn.cancel:hover {
            background: var(--bg-tertiary); color: var(--text-primary);
        }
        .collection-modal-btn.confirm {
            background: linear-gradient(135deg, var(--color-purple), var(--color-blue));
            color: #fff;
        }
        .collection-modal-btn.confirm:hover { opacity: 0.9; }
        .collection-modal-btn.danger {
            background: #ef4444; color: #fff;
        }
        .collection-modal-btn.danger:hover { background: #dc2626; }

        /* Existing collections list in modal */
        .existing-collections {
            margin-bottom: 16px; max-height: 200px; overflow-y: auto;
        }
        .existing-collection-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 10px 12px; background: var(--bg-secondary);
            border-radius: 8px; margin-bottom: 8px;
        }
        .existing-collection-item:last-child { margin-bottom: 0; }
        .existing-collection-info {
            display: flex; align-items: center; gap: 10px;
        }
        .existing-collection-name {
            font-size: 0.9rem; color: var(--text-primary);
        }
        .existing-collection-count {
            font-size: 0.75rem; color: var(--text-tertiary);
        }
        .existing-collection-actions {
            display: flex; gap: 6px;
        }
        .existing-collection-actions button {
            width: 28px; height: 28px; border-radius: 6px;
            background: transparent; border: 1px solid var(--border-subtle);
            color: var(--text-tertiary); font-size: 0.8rem;
            cursor: pointer; transition: all 0.2s ease;
        }
        .existing-collection-actions button:hover {
            background: var(--bg-tertiary); color: var(--text-primary);
        }
        .existing-collection-actions button.delete:hover {
            background: #ef4444; border-color: #ef4444; color: #fff;
        }

        /* Move to collection dropdown */
        .move-collection-dropdown {
            position: absolute; top: 40px; right: 8px;
            background: var(--bg-primary); border: 1px solid var(--border-subtle);
            border-radius: 10px; padding: 8px 0;
            min-width: 160px; z-index: 100;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
            display: none;
        }
        .move-collection-dropdown.active { display: block; }
        .move-collection-option {
            display: block; width: 100%; padding: 10px 16px;
            background: transparent; border: none;
            color: var(--text-secondary); font-size: 0.85rem;
            text-align: left; cursor: pointer;
            font-family: inherit; transition: all 0.2s ease;
        }
        .move-collection-option:hover {
            background: var(--bg-secondary); color: var(--text-primary);
        }
        .move-collection-option.current {
            color: var(--color-purple); font-weight: 500;
        }
        .move-collection-divider {
            height: 1px; background: var(--border-subtle);
            margin: 6px 0;
        }

        /* Gallery item collection badge */
        .gallery-item-collection {
            position: absolute; bottom: 8px; left: 8px;
            padding: 4px 8px; border-radius: 6px;
            background: rgba(0,0,0,0.7); color: var(--text-highlight);
            font-size: 0.65rem; opacity: 0;
            transition: opacity 0.3s ease;
        }
        .gallery-item:hover .gallery-item-collection { opacity: 1; }

        /* Gallery Selection Mode */
        .gallery-toolbar {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 16px; padding: 12px 16px;
            background: var(--bg-secondary); border: 1px solid var(--border-subtle);
            border-radius: 12px;
        }
        .gallery-toolbar-left { display: flex; gap: 10px; align-items: center; }
        .gallery-toolbar-right { display: flex; gap: 10px; align-items: center; }
        .gallery-toolbar .select-btn {
            padding: 8px 14px; border: 1px solid var(--border-medium);
            border-radius: 8px; background: transparent;
            color: var(--text-secondary); font-size: 0.8rem; font-weight: 500;
            font-family: inherit; cursor: pointer; transition: all 0.25s ease;
        }
        .gallery-toolbar .select-btn:hover { border-color: var(--color-purple); color: var(--text-primary); }
        .gallery-toolbar .select-btn.active {
            background: var(--color-purple); border-color: var(--color-purple); color: #fff;
        }
        .gallery-toolbar .selection-count {
            font-size: 0.85rem; color: var(--text-secondary); font-weight: 500;
        }
        .gallery-toolbar .export-btn {
            padding: 8px 16px; border: none; border-radius: 8px;
            background: linear-gradient(135deg, var(--color-purple), var(--color-pink));
            color: #fff; font-size: 0.8rem; font-weight: 600;
            font-family: inherit; cursor: pointer; transition: all 0.25s ease;
        }
        .gallery-toolbar .export-btn:hover { transform: translateY(-1px); }
        .gallery-toolbar .export-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
        .gallery-toolbar .delete-selected-btn {
            padding: 8px 16px; border: none; border-radius: 8px;
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: #fff; font-size: 0.8rem; font-weight: 600;
            font-family: inherit; cursor: pointer; transition: all 0.25s ease;
        }
        .gallery-toolbar .delete-selected-btn:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(239, 68, 68, 0.4); }
        .gallery-toolbar .delete-selected-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; box-shadow: none; }

        .gallery-item .select-checkbox {
            position: absolute; top: 8px; left: 8px;
            width: 24px; height: 24px;
            background: rgba(0,0,0,0.5); border: 2px solid rgba(255,255,255,0.5);
            border-radius: 6px; cursor: pointer;
            display: none; align-items: center; justify-content: center;
            z-index: 15; transition: all 0.2s ease;
        }
        .gallery-item .select-checkbox::after {
            content: ''; width: 12px; height: 12px;
            background: transparent; border-radius: 3px;
            transition: background 0.2s ease;
        }
        .select-mode .gallery-item .select-checkbox { display: flex; }
        .select-mode .gallery-item .gallery-item-delete { display: none; }
        .gallery-item.selected .select-checkbox {
            background: var(--color-purple); border-color: var(--color-purple);
        }
        .gallery-item.selected .select-checkbox::after {
            content: ''; color: #fff; font-size: 14px; font-weight: bold;
            width: auto; height: auto; background: transparent;
        }
        .gallery-item.selected { border-color: var(--color-purple); box-shadow: 0 0 0 2px rgba(124,58,237,0.3); }

        /* Batch Export Modal */
        .batch-export-options { display: flex; flex-direction: column; gap: 20px; margin: 20px 0; }
        .batch-export-options label {
            font-size: 0.85rem; font-weight: 500; color: var(--text-highlight);
            display: block; margin-bottom: 8px;
        }
        .batch-export-options select {
            width: 100%; padding: 12px; border: 1px solid var(--border-light);
            border-radius: 10px; background: var(--bg-tertiary);
            color: var(--text-primary); font-size: 0.9rem; font-family: inherit;
        }
        .batch-export-options select:focus {
            outline: none; border-color: var(--color-purple);
            box-shadow: 0 0 0 3px rgba(124, 58, 237, 0.2);
        }
        .quality-slider-container { display: flex; align-items: center; gap: 12px; }
        .quality-slider-container input[type="range"] { flex: 1; }
        .quality-value { font-size: 0.9rem; color: var(--text-secondary); min-width: 45px; text-align: right; }
        .batch-export-preview {
            font-size: 0.85rem; color: var(--text-tertiary);
            padding: 12px; background: var(--bg-tertiary);
            border-radius: 8px; text-align: center;
        }
        .batch-export-actions { display: flex; gap: 12px; margin-top: 8px; }
        .batch-export-actions button { flex: 1; }

        /* Prompt Library Tab */
        .prompt-library-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
        .prompt-library-header h3 { font-size: 1.1rem; color: var(--text-primary); }

        .prompt-list { display: flex; flex-direction: column; gap: 12px; }
        .prompt-item {
            background: var(--bg-secondary);
            border: 1px solid var(--border-subtle);
            border-radius: 12px; padding: 16px;
            cursor: pointer; transition: all 0.3s ease;
        }
        .prompt-item:hover { border-color: var(--color-purple); background: rgba(124,58,237,0.05); }
        .prompt-item-text { color: var(--text-highlight); font-size: 0.9rem; line-height: 1.5; margin-bottom: 10px; }
        .prompt-item-meta { display: flex; justify-content: space-between; align-items: center; }
        .prompt-item-date { font-size: 0.75rem; color: var(--text-tertiary); }
        .prompt-item-actions { display: flex; gap: 8px; }
        .prompt-item-actions button {
            padding: 6px 12px; font-size: 0.75rem; font-weight: 500;
            font-family: inherit; border: 1px solid var(--border-medium);
            border-radius: 6px; background: transparent;
            color: var(--text-secondary); cursor: pointer; transition: all 0.2s ease;
        }
        .prompt-item-actions button:hover { border-color: var(--color-purple); color: var(--text-primary); }
        .prompt-item-actions button.delete:hover { border-color: var(--color-red); color: var(--color-red-light); }

        .prompt-empty { text-align: center; padding: 60px 20px; color: var(--text-tertiary); }
        .prompt-empty span { display: block; font-size: 3rem; margin-bottom: 12px; opacity: 0.5; }

        /* System Instructions Tab */
        .system-instructions-section {
            background: linear-gradient(135deg, var(--bg-card) 0%, var(--bg-secondary) 100%);
            border: 1px solid var(--border-subtle);
            border-radius: 20px; padding: 28px;
        }
        .system-header {
            display: flex; align-items: center; gap: 12px; margin-bottom: 12px;
        }
        .system-header h3 { font-size: 1.2rem; color: var(--text-primary); margin: 0; }
        .system-badge {
            background: rgba(124, 58, 237, 0.2);
            border: 1px solid rgba(124, 58, 237, 0.3);
            padding: 4px 10px; border-radius: 20px;
            font-size: 0.7rem; font-weight: 600;
            text-transform: uppercase; letter-spacing: 0.05em;
            color: var(--color-purple-light);
        }
        .system-description {
            color: var(--text-secondary); font-size: 0.9rem; line-height: 1.6;
            margin-bottom: 20px;
        }
        .system-textarea {
            width: 100%; min-height: 200px; padding: 16px;
            border: 1px solid var(--border-light);
            border-radius: 14px; background: var(--bg-tertiary);
            color: var(--text-primary); font-size: 0.95rem;
            font-family: inherit; line-height: 1.6;
            resize: vertical; transition: all 0.3s ease;
        }
        .system-textarea:focus {
            outline: none; border-color: var(--color-purple);
            box-shadow: 0 0 0 3px rgba(124, 58, 237, 0.2);
        }
        .system-textarea::placeholder { color: var(--text-muted); }
        .system-actions {
            display: flex; gap: 12px; margin-top: 16px; align-items: center;
        }
        .system-status {
            margin-top: 12px; padding: 10px 16px;
            border-radius: 8px; font-size: 0.85rem;
            display: none;
        }
        .system-status.success {
            display: block;
            background: rgba(34, 197, 94, 0.15);
            border: 1px solid rgba(34, 197, 94, 0.3);
            color: #86efac;
        }

        /* Export Modal */
        .modal {
            display: none; position: fixed; inset: 0;
            background: rgba(0, 0, 0, 0.85); backdrop-filter: blur(8px);
            z-index: 1000; align-items: center; justify-content: center;
        }
        .modal.active { display: flex; }
        .modal-content {
            background: var(--bg-modal);
            border-radius: 20px; padding: 28px;
            max-width: 500px; width: 90%;
            max-height: 85vh; overflow-y: auto;
            border: 1px solid var(--border-light);
        }
        .modal-close {
            position: absolute; top: 14px; right: 14px;
            width: 32px; height: 32px;
            background: var(--border-subtle);
            border: 1px solid var(--border-medium);
            border-radius: 8px; color: var(--text-secondary);
            font-size: 1.1rem; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
        }
        .modal-close:hover { background: rgba(239,68,68,0.1); border-color: rgba(239,68,68,0.3); color: var(--color-red-light); }
        .modal h3 {
            margin-bottom: 20px; font-size: 1.2rem; font-weight: 700;
            background: linear-gradient(135deg, #c4b5fd 0%, #f9a8d4 100%);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        }

        /* Export Options */
        .export-options { display: flex; flex-direction: column; gap: 16px; }
        .export-option-group label { display: block; margin-bottom: 8px; font-size: 0.85rem; color: var(--text-secondary); }
        .export-format-btns { display: flex; gap: 10px; }
        .export-format-btn {
            flex: 1; padding: 14px; border: 1px solid var(--border-medium);
            border-radius: 10px; background: var(--bg-overlay);
            color: var(--text-secondary); font-size: 0.9rem; font-weight: 600;
            font-family: inherit; cursor: pointer; transition: all 0.25s ease;
            text-align: center;
        }
        .export-format-btn:hover { border-color: var(--color-purple); color: var(--text-primary); }
        .export-format-btn.active { border-color: var(--color-purple); background: rgba(124,58,237,0.2); color: var(--text-primary); }
        .export-format-btn span { display: block; font-size: 1.5rem; margin-bottom: 6px; }

        .quality-slider { width: 100%; margin-top: 8px; }
        .quality-value { text-align: center; color: var(--color-purple-light); font-weight: 600; margin-top: 6px; }

        .export-btn {
            width: 100%; margin-top: 20px; padding: 14px;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            border: none; border-radius: 10px;
            color: #fff; font-size: 1rem; font-weight: 600;
            font-family: inherit; cursor: pointer;
            transition: all 0.25s ease;
        }
        .export-btn:hover { transform: translateY(-2px); box-shadow: 0 8px 24px rgba(16, 185, 129, 0.3); }

        /* Ideas Modal */
        .idea-card {
            background: var(--bg-card);
            border-radius: 12px; padding: 16px; margin-bottom: 12px;
            transition: all 0.3s ease; border: 1px solid var(--border-subtle);
        }
        .idea-card:hover { background: var(--border-subtle); border-color: rgba(124,58,237,0.3); }
        .idea-card h4 { color: var(--text-primary); margin-bottom: 8px; font-size: 0.95rem; font-weight: 600; }
        .idea-card p { color: var(--text-secondary); font-size: 0.85rem; line-height: 1.5; }
        .idea-card .use-idea-btn {
            margin-top: 12px; padding: 8px 16px;
            font-size: 0.8rem; font-weight: 600; font-family: inherit;
            border: 1px solid var(--color-purple); border-radius: 6px;
            background: transparent; color: var(--color-purple-light);
            cursor: pointer; transition: all 0.25s ease;
        }
        .idea-card .use-idea-btn:hover { background: rgba(124, 58, 237, 0.2); color: var(--text-primary); }

        .ideas-loading { text-align: center; padding: 40px; color: var(--text-secondary); }
        .ideas-loading .loader { width: 28px; height: 28px; border-width: 3px; margin-bottom: 12px; }

        /* Batch Mode */
        .batch-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 10px; margin-top: 12px;
        }
        .batch-item {
            position: relative; border-radius: 8px; overflow: hidden;
            border: 2px solid transparent;
        }
        .batch-item img { width: 100%; aspect-ratio: 1; object-fit: cover; }
        .batch-item .remove-batch {
            position: absolute; top: 4px; right: 4px;
            width: 20px; height: 20px; border-radius: 50%;
            background: rgba(239,68,68,0.9); border: none;
            color: #fff; font-size: 12px; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
        }
        .batch-add {
            aspect-ratio: 1; border: 2px dashed var(--border-accent);
            border-radius: 8px; display: flex;
            align-items: center; justify-content: center;
            font-size: 2rem; color: var(--text-tertiary);
            cursor: pointer; transition: all 0.3s ease;
        }
        .batch-add:hover { border-color: var(--color-purple); color: var(--color-purple); }

        /* Keyboard Shortcuts Hint */
        .shortcuts-hint {
            position: fixed; bottom: 20px; right: 20px;
            background: var(--bg-tertiary); border: 1px solid var(--border-medium);
            border-radius: 10px; padding: 12px 16px;
            font-size: 0.75rem; color: var(--text-secondary);
            display: none;
        }
        .shortcuts-hint kbd {
            background: var(--border-medium); padding: 2px 6px;
            border-radius: 4px; margin-right: 4px;
        }

        /* Lightbox */
        .lightbox {
            display: none; position: fixed; inset: 0;
            background: rgba(0, 0, 0, 0.95); backdrop-filter: blur(10px);
            z-index: 2000; align-items: center; justify-content: center;
            flex-direction: column; padding: 20px;
        }
        .lightbox.active { display: flex; }
        .lightbox-close {
            position: absolute; top: 20px; right: 20px;
            width: 44px; height: 44px;
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 50%; color: #fff;
            font-size: 1.5rem; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            transition: all 0.25s ease; z-index: 10;
        }
        .lightbox-close:hover { background: rgba(255,255,255,0.2); transform: scale(1.1); }
        .lightbox-image-container {
            max-width: 90vw; max-height: 80vh;
            display: flex; align-items: center; justify-content: center;
        }
        .lightbox-image {
            max-width: 100%; max-height: 80vh;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
            animation: lightboxFadeIn 0.3s ease;
        }
        @keyframes lightboxFadeIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
        .lightbox-nav {
            position: absolute; top: 50%; transform: translateY(-50%);
            width: 50px; height: 50px;
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 50%; color: #fff;
            font-size: 1.5rem; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            transition: all 0.25s ease;
        }
        .lightbox-nav:hover { background: rgba(255,255,255,0.2); }
        .lightbox-nav.prev { left: 20px; }
        .lightbox-nav.next { right: 20px; }
        .lightbox-nav:disabled { opacity: 0.3; cursor: not-allowed; }
        .lightbox-counter {
            position: absolute; bottom: 20px;
            background: rgba(0,0,0,0.6); padding: 8px 16px;
            border-radius: 20px; font-size: 0.85rem; color: var(--text-highlight);
        }
        .lightbox-actions {
            display: flex; gap: 10px; margin-top: 16px;
        }
        .lightbox-actions button {
            padding: 10px 20px; border: none; border-radius: 8px;
            font-size: 0.85rem; font-weight: 600; font-family: inherit;
            cursor: pointer; transition: all 0.25s ease;
        }
        .lightbox-actions .lb-download {
            background: linear-gradient(135deg, #10b981, #059669); color: #fff;
        }
        .lightbox-actions .lb-download:hover { transform: translateY(-2px); }

        /* Theme Toggle Button */
        .theme-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            width: 44px;
            height: 44px;
            border: 1px solid var(--border-medium);
            border-radius: 50%;
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
        }
        .theme-toggle:hover {
            border-color: var(--color-purple);
            transform: scale(1.1);
        }

        /* Tutorial System */
        .tutorial-btn {
            padding: 8px 14px;
            border-radius: 10px;
            background: linear-gradient(135deg, var(--color-purple), var(--color-blue));
            border: none;
            color: #fff;
            font-size: 0.8rem;
            font-weight: 600;
            font-family: inherit;
            cursor: pointer;
            transition: all 0.25s ease;
            display: flex;
            align-items: center;
            gap: 6px;
            white-space: nowrap;
        }
        .tutorial-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(124, 58, 237, 0.4);
        }
        .tutorial-btn.animate {
            animation: tutorialBtnPulse 2s ease-in-out infinite;
        }
        @keyframes tutorialBtnPulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(124, 58, 237, 0.4); }
            50% { box-shadow: 0 0 0 8px rgba(124, 58, 237, 0); }
        }
        .tutorial-btn-icon {
            font-size: 1rem;
        }
        .tutorial-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.75);
            z-index: 9998;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }
        .tutorial-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        .tutorial-highlight {
            position: absolute;
            box-shadow: 0 0 0 4px var(--color-purple), 0 0 0 9999px rgba(0, 0, 0, 0.75);
            border-radius: 12px;
            z-index: 9999;
            pointer-events: none;
            transition: all 0.4s ease;
        }
        .tutorial-tooltip {
            position: fixed;
            background: var(--bg-primary);
            border: 1px solid var(--border-subtle);
            border-radius: 16px;
            padding: 24px;
            max-width: 380px;
            z-index: 10000;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
            animation: tutorialFadeIn 0.3s ease;
        }
        @keyframes tutorialFadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .tutorial-tooltip-arrow {
            position: absolute;
            width: 16px; height: 16px;
            background: var(--bg-primary);
            border: 1px solid var(--border-subtle);
            transform: rotate(45deg);
            z-index: -1;
        }
        .tutorial-tooltip-arrow.top { top: -9px; border-right: none; border-bottom: none; }
        .tutorial-tooltip-arrow.bottom { bottom: -9px; border-left: none; border-top: none; }
        .tutorial-tooltip-arrow.left { left: 30px; }
        .tutorial-tooltip-arrow.right { right: 30px; }
        .tutorial-step-indicator {
            display: flex;
            gap: 6px;
            margin-bottom: 16px;
        }
        .tutorial-step-dot {
            width: 8px; height: 8px;
            border-radius: 50%;
            background: var(--bg-tertiary);
            transition: all 0.25s ease;
        }
        .tutorial-step-dot.active {
            background: var(--color-purple);
            width: 24px;
            border-radius: 4px;
        }
        .tutorial-step-dot.completed {
            background: var(--color-green);
        }
        .tutorial-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .tutorial-title-icon {
            font-size: 1.4rem;
        }
        .tutorial-description {
            font-size: 0.9rem;
            color: var(--text-secondary);
            line-height: 1.6;
            margin-bottom: 20px;
        }
        .tutorial-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 12px;
        }
        .tutorial-skip-btn {
            padding: 10px 16px;
            border: none;
            border-radius: 10px;
            background: transparent;
            color: var(--text-tertiary);
            font-size: 0.85rem;
            font-family: inherit;
            cursor: pointer;
            transition: all 0.25s ease;
        }
        .tutorial-skip-btn:hover {
            color: var(--text-secondary);
            background: var(--bg-secondary);
        }
        .tutorial-nav-btns {
            display: flex;
            gap: 10px;
        }
        .tutorial-prev-btn, .tutorial-next-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 10px;
            font-size: 0.85rem;
            font-weight: 600;
            font-family: inherit;
            cursor: pointer;
            transition: all 0.25s ease;
        }
        .tutorial-prev-btn {
            background: var(--bg-secondary);
            color: var(--text-secondary);
        }
        .tutorial-prev-btn:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }
        .tutorial-next-btn {
            background: linear-gradient(135deg, var(--color-purple), var(--color-blue));
            color: #fff;
        }
        .tutorial-next-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(139, 92, 246, 0.4);
        }
        .tutorial-start-modal {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10001;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }
        .tutorial-start-modal.active {
            opacity: 1;
            visibility: visible;
        }
        .tutorial-start-content {
            background: var(--bg-primary);
            border: 1px solid var(--border-subtle);
            border-radius: 20px;
            padding: 32px;
            max-width: 420px;
            text-align: center;
        }
        .tutorial-start-icon {
            font-size: 3rem;
            margin-bottom: 16px;
        }
        .tutorial-start-title {
            font-size: 1.4rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 12px;
        }
        .tutorial-start-description {
            font-size: 0.95rem;
            color: var(--text-secondary);
            line-height: 1.6;
            margin-bottom: 24px;
        }
        .tutorial-start-actions {
            display: flex;
            gap: 12px;
            justify-content: center;
        }
        .tutorial-start-btn {
            padding: 12px 28px;
            border: none;
            border-radius: 12px;
            font-size: 0.95rem;
            font-weight: 600;
            font-family: inherit;
            cursor: pointer;
            transition: all 0.25s ease;
        }
        .tutorial-start-btn.secondary {
            background: var(--bg-secondary);
            color: var(--text-secondary);
        }
        .tutorial-start-btn.secondary:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }
        .tutorial-start-btn.primary {
            background: linear-gradient(135deg, var(--color-purple), var(--color-blue));
            color: #fff;
        }
        .tutorial-start-btn.primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(139, 92, 246, 0.4);
        }

        /* Auth UI */
        .auth-bar {
            position: fixed;
            top: 20px;
            right: 80px;
            display: flex;
            align-items: center;
            gap: 10px;
            z-index: 1000;
        }
        .auth-btn {
            padding: 10px 18px;
            border: 1px solid var(--border-medium);
            border-radius: 10px;
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-size: 0.85rem;
            font-weight: 600;
            font-family: inherit;
            cursor: pointer;
            transition: all 0.25s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .auth-btn:hover { border-color: var(--color-purple); transform: translateY(-2px); }
        .auth-btn.google { background: #4285f4; border-color: #4285f4; color: #fff; }
        .auth-btn.google:hover { background: #3367d6; }
        .auth-btn.logout { background: transparent; color: var(--text-secondary); }
        .auth-btn.logout:hover { border-color: var(--color-red); color: var(--color-red-light); }
        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 6px 12px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-subtle);
            border-radius: 10px;
        }
        .user-avatar {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--color-purple), var(--color-pink));
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: 600;
            color: #fff;
        }
        .user-avatar img { width: 100%; height: 100%; border-radius: 50%; object-fit: cover; }
        .user-name { font-size: 0.85rem; color: var(--text-primary); font-weight: 500; max-width: 120px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }

        /* Notification Inbox */
        .notification-inbox {
            position: relative;
        }
        .notification-btn {
            width: 42px;
            height: 42px;
            border: 1px solid var(--border-medium);
            border-radius: 10px;
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.25s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }
        .notification-btn:hover {
            border-color: var(--color-purple);
            transform: translateY(-2px);
        }
        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            min-width: 18px;
            height: 18px;
            background: linear-gradient(135deg, var(--color-pink), var(--color-purple));
            color: #fff;
            font-size: 0.7rem;
            font-weight: 600;
            border-radius: 9px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0 5px;
            animation: notifPulse 2s ease-in-out infinite;
        }
        .notification-badge.hidden { display: none; }
        @keyframes notifPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        .notification-dropdown {
            position: absolute;
            top: 50px;
            right: 0;
            width: 320px;
            background: var(--bg-modal);
            border: 1px solid var(--border-medium);
            border-radius: 14px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.4);
            overflow: hidden;
            display: none;
            z-index: 1001;
        }
        .notification-dropdown.show { display: block; }
        .notification-header {
            padding: 14px 16px;
            border-bottom: 1px solid var(--border-subtle);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .notification-header h4 {
            font-size: 0.95rem;
            font-weight: 600;
            color: var(--text-primary);
            margin: 0;
        }
        .notification-clear-btn {
            font-size: 0.75rem;
            color: var(--text-tertiary);
            background: none;
            border: none;
            cursor: pointer;
            transition: color 0.2s ease;
        }
        .notification-clear-btn:hover { color: var(--text-primary); }
        .notification-list {
            max-height: 300px;
            overflow-y: auto;
        }
        .notification-empty {
            padding: 30px 20px;
            text-align: center;
            color: var(--text-tertiary);
            font-size: 0.85rem;
        }
        .notification-empty-icon {
            font-size: 2rem;
            margin-bottom: 8px;
            opacity: 0.5;
        }
        .notification-item {
            padding: 14px 16px;
            border-bottom: 1px solid var(--border-subtle);
            cursor: pointer;
            transition: background 0.2s ease;
        }
        .notification-item:last-child { border-bottom: none; }
        .notification-item:hover { background: var(--bg-secondary); }
        .notification-item.unread { background: rgba(124, 58, 237, 0.08); }
        .notification-item-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 4px;
        }
        .notification-icon {
            font-size: 1.1rem;
        }
        .notification-title {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--text-primary);
        }
        .notification-message {
            font-size: 0.8rem;
            color: var(--text-secondary);
            line-height: 1.4;
        }
        .notification-time {
            font-size: 0.7rem;
            color: var(--text-muted);
            margin-top: 6px;
        }
        .notification-action {
            display: inline-block;
            margin-top: 8px;
            padding: 6px 12px;
            background: linear-gradient(135deg, var(--color-purple), var(--color-pink));
            color: #fff;
            font-size: 0.75rem;
            font-weight: 500;
            border-radius: 6px;
            text-decoration: none;
            transition: transform 0.2s ease;
        }
        .notification-action:hover { transform: translateY(-1px); }

        /* Auth Modal */
        .auth-modal {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.7);
            backdrop-filter: blur(8px);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }
        .auth-modal.show { display: flex; }
        .auth-modal-content {
            background: var(--bg-modal);
            border: 1px solid var(--border-medium);
            border-radius: 20px;
            padding: 32px;
            width: 100%;
            max-width: 400px;
            text-align: center;
        }
        .auth-modal h2 { font-size: 1.5rem; margin-bottom: 8px; color: var(--text-primary); }
        .auth-modal p { color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 24px; }
        .auth-divider {
            display: flex;
            align-items: center;
            gap: 12px;
            margin: 20px 0;
            color: var(--text-muted);
            font-size: 0.8rem;
        }
        .auth-divider::before, .auth-divider::after {
            content: '';
            flex: 1;
            height: 1px;
            background: var(--border-light);
        }
        .auth-input {
            width: 100%;
            padding: 14px 16px;
            border: 1px solid var(--border-light);
            border-radius: 10px;
            background: var(--bg-tertiary);
            color: var(--text-primary);
            font-size: 0.95rem;
            font-family: inherit;
            margin-bottom: 12px;
            transition: border-color 0.2s ease;
        }
        .auth-input:focus { outline: none; border-color: var(--color-purple); }
        .auth-input::placeholder { color: var(--text-muted); }
        .auth-submit {
            width: 100%;
            padding: 14px;
            border: none;
            border-radius: 10px;
            background: linear-gradient(135deg, var(--color-purple), var(--color-pink));
            color: #fff;
            font-size: 1rem;
            font-weight: 600;
            font-family: inherit;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .auth-submit:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(124, 58, 237, 0.4); }
        .auth-submit:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }
        .auth-toggle { margin-top: 16px; color: var(--text-secondary); font-size: 0.85rem; }
        .auth-toggle a { color: var(--color-cyan); cursor: pointer; text-decoration: none; }
        .auth-toggle a:hover { text-decoration: underline; }
        .auth-error { color: var(--color-red-light); font-size: 0.85rem; margin-bottom: 12px; display: none; }
        .auth-error.show { display: block; }
        .auth-close {
            position: absolute;
            top: 16px;
            right: 16px;
            width: 32px;
            height: 32px;
            border: none;
            border-radius: 8px;
            background: rgba(255,255,255,0.1);
            color: var(--text-secondary);
            font-size: 1.2rem;
            cursor: pointer;
        }
        .auth-close:hover { background: rgba(255,255,255,0.2); color: var(--text-primary); }
        .auth-modal-content { position: relative; }

        /* Sync indicator */
        .sync-indicator {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 10px 16px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-subtle);
            border-radius: 10px;
            font-size: 0.8rem;
            color: var(--text-secondary);
            display: none;
            align-items: center;
            gap: 8px;
            z-index: 1000;
        }
        .sync-indicator.show { display: flex; }
        .sync-indicator.syncing { color: var(--color-cyan); }
        .sync-indicator.synced { color: var(--color-green-light); }
        .sync-spinner {
            width: 14px;
            height: 14px;
            border: 2px solid var(--border-light);
            border-top-color: var(--color-cyan);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* Light mode adjustments */
        [data-theme="light"] body::before {
            background:
                radial-gradient(ellipse at 20% 20%, rgba(120, 0, 255, 0.08) 0%, transparent 50%),
                radial-gradient(ellipse at 80% 80%, rgba(255, 0, 128, 0.08) 0%, transparent 50%),
                radial-gradient(ellipse at 50% 50%, rgba(0, 200, 255, 0.05) 0%, transparent 60%);
        }

        /* Light mode logo gradient - darker colors for visibility */
        [data-theme="light"] h1 {
            background: linear-gradient(135deg, #1a1a2e 0%, #7c3aed 50%, #ec4899 100%);
            -webkit-background-clip: text;
            background-clip: text;
        }

        /* Light mode logo icon adjustment */
        [data-theme="light"] .logo-icon {
            box-shadow: 0 8px 32px rgba(124, 58, 237, 0.3);
        }

        /* ========== PRODUCTS TAB ========== */
        .products-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .products-header h3 {
            font-size: 1.1rem;
            color: var(--text-primary);
        }

        .products-description {
            color: var(--text-secondary);
            font-size: 0.9rem;
            line-height: 1.6;
            margin-bottom: 20px;
        }

        .products-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .product-item {
            background: var(--bg-secondary);
            border: 1px solid var(--border-subtle);
            border-radius: 12px;
            padding: 16px;
            transition: all 0.3s ease;
        }

        .product-item:hover {
            border-color: var(--color-purple);
        }

        .product-item.active {
            border-color: var(--color-green);
            background: rgba(16, 185, 129, 0.05);
        }

        .product-item-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 10px;
        }

        .product-item-name {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .product-item-active-badge {
            background: rgba(16, 185, 129, 0.2);
            border: 1px solid rgba(16, 185, 129, 0.3);
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.65rem;
            font-weight: 600;
            text-transform: uppercase;
            color: var(--color-green-light);
        }

        .product-item-description {
            color: var(--text-secondary);
            font-size: 0.85rem;
            line-height: 1.5;
            margin-bottom: 10px;
        }

        .product-item-tags {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
            margin-bottom: 12px;
        }

        .product-tag {
            padding: 3px 8px;
            border-radius: 6px;
            font-size: 0.7rem;
            font-weight: 500;
        }

        .product-tag.golden {
            background: rgba(245, 158, 11, 0.15);
            color: #fbbf24;
        }

        .product-tag.forbidden {
            background: rgba(239, 68, 68, 0.15);
            color: var(--color-red-light);
        }

        .product-item-actions {
            display: flex;
            gap: 8px;
        }

        .product-item-actions button {
            padding: 6px 12px;
            font-size: 0.75rem;
            font-weight: 500;
            font-family: inherit;
            border: 1px solid var(--border-medium);
            border-radius: 6px;
            background: transparent;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .product-item-actions button:hover {
            border-color: var(--color-purple);
            color: var(--text-primary);
        }

        .product-item-actions button.activate {
            border-color: rgba(16, 185, 129, 0.3);
            color: var(--color-green-light);
        }

        .product-item-actions button.activate:hover {
            background: rgba(16, 185, 129, 0.1);
            border-color: var(--color-green);
        }

        .product-item-actions button.delete:hover {
            border-color: var(--color-red);
            color: var(--color-red-light);
        }

        .products-empty {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-tertiary);
        }

        .products-empty span {
            display: block;
            font-size: 3rem;
            margin-bottom: 12px;
            opacity: 0.5;
        }

        /* Product Form Modal */
        .product-form {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .form-field label {
            display: block;
            margin-bottom: 6px;
            font-size: 0.85rem;
            font-weight: 500;
            color: var(--text-highlight);
        }

        .field-hint {
            font-weight: 400;
            color: var(--text-muted);
            font-size: 0.75rem;
        }

        .form-field input,
        .form-field textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border-light);
            border-radius: 10px;
            background: var(--bg-tertiary);
            color: var(--text-primary);
            font-size: 0.9rem;
            font-family: inherit;
            transition: all 0.3s ease;
            box-sizing: border-box;
        }

        .form-field textarea {
            min-height: 80px;
            resize: vertical;
        }

        .form-field input:focus,
        .form-field textarea:focus {
            outline: none;
            border-color: var(--color-purple);
            box-shadow: 0 0 0 3px rgba(124, 58, 237, 0.2);
        }

        .product-image-upload {
            border: 2px dashed var(--border-accent);
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            color: var(--text-tertiary);
        }

        .product-image-upload:hover {
            border-color: var(--color-purple);
            color: var(--text-secondary);
        }

        .product-image-upload img {
            max-height: 100px;
            border-radius: 8px;
        }

        .form-actions {
            display: flex;
            gap: 12px;
            margin-top: 8px;
        }

        .hidden-input {
            display: none;
        }

        /* ========== PROMPT GENERATOR TAB ========== */
        .promptgen-section {
            background: linear-gradient(135deg, var(--bg-card) 0%, var(--bg-secondary) 100%);
            border: 1px solid var(--border-subtle);
            border-radius: 20px;
            padding: 28px;
        }

        .promptgen-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
        }

        .promptgen-header h3 {
            font-size: 1.2rem;
            color: var(--text-primary);
            margin: 0;
        }

        .promptgen-description {
            color: var(--text-secondary);
            font-size: 0.9rem;
            line-height: 1.6;
            margin-bottom: 20px;
        }

        .promptgen-product-select,
        .promptgen-model-select {
            margin-bottom: 20px;
        }

        .promptgen-product-select label,
        .promptgen-model-select label {
            display: block;
            margin-bottom: 8px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: var(--text-secondary);
        }

        .promptgen-product-select select,
        .promptgen-model-select select {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border-light);
            border-radius: 10px;
            background: var(--bg-tertiary);
            color: var(--text-primary);
            font-size: 0.9rem;
            font-family: inherit;
        }

        .promptgen-model-select select optgroup {
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            font-weight: 600;
        }

        .promptgen-model-select select option {
            background: var(--bg-primary);
            color: var(--text-primary);
            padding: 8px;
        }

        .active-product-preview {
            margin-top: 12px;
            padding: 12px;
            background: rgba(16, 185, 129, 0.05);
            border: 1px solid rgba(16, 185, 129, 0.2);
            border-radius: 10px;
            font-size: 0.85rem;
            color: var(--text-secondary);
            display: none;
        }

        .active-product-preview.show {
            display: block;
        }

        .promptgen-input {
            margin-bottom: 16px;
        }

        .promptgen-input label {
            display: block;
            margin-bottom: 8px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: var(--text-secondary);
        }

        .promptgen-input textarea {
            width: 100%;
            min-height: 100px;
            padding: 16px;
            border: 1px solid var(--border-light);
            border-radius: 14px;
            background: var(--bg-tertiary);
            color: var(--text-primary);
            font-size: 0.95rem;
            font-family: inherit;
            line-height: 1.5;
            resize: vertical;
            box-sizing: border-box;
        }

        .promptgen-input textarea:focus {
            outline: none;
            border-color: var(--color-purple);
            box-shadow: 0 0 0 3px rgba(124, 58, 237, 0.2);
        }

        .promptgen-options {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin-bottom: 20px;
        }

        @media (max-width: 600px) {
            .promptgen-options {
                grid-template-columns: 1fr;
            }
        }

        .option-group label {
            display: block;
            margin-bottom: 8px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: var(--text-secondary);
        }

        .option-buttons {
            display: flex;
            gap: 8px;
        }

        .option-btn {
            flex: 1;
            padding: 10px 14px;
            border: 1px solid var(--border-medium);
            border-radius: 8px;
            background: transparent;
            color: var(--text-secondary);
            font-size: 0.85rem;
            font-weight: 500;
            font-family: inherit;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .option-btn:hover {
            border-color: var(--color-purple);
            color: var(--text-primary);
        }

        .option-btn.active {
            background: linear-gradient(135deg, var(--color-purple), var(--color-pink));
            border-color: transparent;
            color: #fff;
        }

        /* Generated Prompts */
        .generated-prompts {
            margin-top: 24px;
        }

        .generated-prompts-header {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .generated-prompt-item {
            background: var(--bg-secondary);
            border: 1px solid var(--border-subtle);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            transition: all 0.3s ease;
        }

        .generated-prompt-item:hover {
            border-color: var(--color-purple);
        }

        .generated-prompt-text {
            color: var(--text-highlight);
            font-size: 0.9rem;
            line-height: 1.6;
            margin-bottom: 12px;
        }

        .generated-prompt-actions {
            display: flex;
            gap: 8px;
        }

        .generated-prompt-actions button {
            padding: 8px 14px;
            font-size: 0.8rem;
            font-weight: 600;
            font-family: inherit;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.25s ease;
        }

        .generated-prompt-actions .use-btn {
            background: linear-gradient(135deg, var(--color-purple), var(--color-pink));
            color: #fff;
        }

        .generated-prompt-actions .copy-btn {
            background: var(--bg-overlay);
            border: 1px solid var(--border-medium);
            color: var(--text-secondary);
        }

        .generated-prompt-actions button:hover {
            transform: translateY(-1px);
        }

        /* ========== MEGA PROMPT FEATURE ========== */
        .promptgen-buttons {
            display: flex;
            gap: 12px;
            margin-top: 20px;
        }

        .promptgen-buttons .submit-btn {
            flex: 1;
            margin-top: 0;
        }

        .mega-prompt-btn {
            flex: 1;
            padding: 16px 28px;
            font-size: 1.05rem;
            font-weight: 600;
            font-family: inherit;
            border: 2px solid transparent;
            border-radius: 12px;
            background:
                linear-gradient(var(--bg-primary), var(--bg-primary)) padding-box,
                linear-gradient(135deg, #f59e0b 0%, #ec4899 50%, #7c3aed 100%) border-box;
            color: var(--text-primary);
            cursor: pointer;
            transition: transform 0.3s ease, box-shadow 0.3s ease, color 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .mega-prompt-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, #f59e0b 0%, #ec4899 50%, #7c3aed 100%);
            border-radius: 10px;
            opacity: 0;
            transition: opacity 0.3s ease;
            z-index: 0;
        }

        .mega-prompt-btn:hover:not(:disabled)::before {
            opacity: 1;
        }

        .mega-prompt-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 16px 32px rgba(245, 158, 11, 0.3);
            color: #fff;
        }

        .mega-prompt-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .mega-prompt-btn span {
            position: relative;
            z-index: 1;
        }

        /* Mega Prompt Output Section */
        .mega-prompt-output {
            margin-top: 24px;
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.05) 0%, rgba(124, 58, 237, 0.05) 100%);
            border: 1px solid rgba(245, 158, 11, 0.2);
            border-radius: 16px;
            padding: 24px;
            display: none;
        }

        .mega-prompt-output.show {
            display: block;
        }

        .mega-prompt-output-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--border-subtle);
        }

        .mega-prompt-output-header h4 {
            font-size: 1.1rem;
            color: var(--text-primary);
            margin: 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .mega-prompt-output-header h4::before {
            content: '';
            width: 8px;
            height: 8px;
            background: linear-gradient(135deg, #f59e0b, #ec4899);
            border-radius: 50%;
        }

        .mega-prompt-actions {
            display: flex;
            gap: 8px;
        }

        .mega-prompt-actions button {
            padding: 8px 14px;
            font-size: 0.8rem;
            font-weight: 600;
            font-family: inherit;
            border: 1px solid var(--border-medium);
            border-radius: 6px;
            background: var(--bg-overlay);
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.25s ease;
        }

        .mega-prompt-actions button:hover {
            border-color: var(--color-purple);
            color: var(--text-primary);
        }

        .mega-prompt-actions .use-mega-btn {
            background: linear-gradient(135deg, var(--color-purple), var(--color-pink));
            border: none;
            color: #fff;
        }

        .mega-prompt-section {
            margin-bottom: 20px;
        }

        .mega-prompt-section:last-child {
            margin-bottom: 0;
        }

        .mega-prompt-section h5 {
            font-size: 0.85rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .mega-prompt-section h5.situation { color: #f59e0b; }
        .mega-prompt-section h5.task { color: #ec4899; }
        .mega-prompt-section h5.objective { color: #7c3aed; }
        .mega-prompt-section h5.visual { color: #06b6d4; }
        .mega-prompt-section h5.negative { color: #ef4444; }
        .mega-prompt-section h5.tech { color: #10b981; }

        .mega-prompt-section p {
            color: var(--text-highlight);
            font-size: 0.9rem;
            line-height: 1.7;
            margin: 0;
        }

        .mega-prompt-section ul {
            margin: 0;
            padding-left: 20px;
            color: var(--text-highlight);
            font-size: 0.9rem;
            line-height: 1.8;
        }

        .mega-prompt-section ul li {
            margin-bottom: 4px;
        }

        @media (max-width: 600px) {
            .promptgen-buttons {
                flex-direction: column;
            }
        }

        /* ========== IMAGE BREAKDOWN TAB STYLES ========== */
        .breakdown-section {
            background: linear-gradient(135deg, var(--bg-card) 0%, var(--bg-secondary) 100%);
            border: 1px solid var(--border-subtle);
            border-radius: 20px;
            padding: 28px;
        }

        .breakdown-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
        }

        .breakdown-header h3 {
            font-size: 1.2rem;
            color: var(--text-primary);
            margin: 0;
        }

        .breakdown-description {
            color: var(--text-secondary);
            font-size: 0.9rem;
            line-height: 1.6;
            margin-bottom: 20px;
        }

        .breakdown-upload-area {
            border: 2px dashed var(--border-medium);
            border-radius: 16px;
            padding: 40px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 20px;
            background: var(--bg-tertiary);
        }

        .breakdown-upload-area:hover {
            border-color: var(--color-purple);
            background: rgba(124, 58, 237, 0.05);
        }

        .breakdown-upload-area.dragover {
            border-color: var(--color-purple);
            background: rgba(124, 58, 237, 0.1);
            transform: scale(1.01);
        }

        .breakdown-upload-icon {
            font-size: 3rem;
            margin-bottom: 12px;
        }

        .breakdown-upload-text {
            font-size: 1rem;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .breakdown-upload-hint {
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        .breakdown-image-preview {
            display: none;
            position: relative;
            margin-bottom: 20px;
            border-radius: 16px;
            overflow: hidden;
            background: var(--bg-tertiary);
        }

        .breakdown-image-preview.show {
            display: block;
        }

        .breakdown-image-preview img {
            width: 100%;
            max-height: 400px;
            object-fit: contain;
            display: block;
        }

        .breakdown-remove-btn {
            position: absolute;
            top: 12px;
            right: 12px;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: rgba(0, 0, 0, 0.7);
            border: none;
            color: #fff;
            font-size: 1.2rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .breakdown-remove-btn:hover {
            background: var(--color-red);
            transform: scale(1.1);
        }

        .breakdown-model-select,
        .breakdown-product-select {
            margin-bottom: 20px;
        }

        .breakdown-model-select label,
        .breakdown-product-select label {
            display: block;
            margin-bottom: 8px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: var(--text-secondary);
        }

        .breakdown-model-select select,
        .breakdown-product-select select {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border-light);
            border-radius: 10px;
            background: var(--bg-tertiary);
            color: var(--text-primary);
            font-size: 0.9rem;
            font-family: inherit;
        }

        .breakdown-model-select select optgroup,
        .breakdown-product-select select optgroup {
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            font-weight: 600;
        }

        .breakdown-model-select select option,
        .breakdown-product-select select option {
            background: var(--bg-primary);
            color: var(--text-primary);
            padding: 8px;
        }

        .breakdown-product-hint {
            margin-top: 8px;
            font-size: 0.8rem;
            color: var(--text-muted);
            font-style: italic;
        }

        .breakdown-buttons {
            display: flex;
            gap: 12px;
            margin-bottom: 12px;
        }

        .breakdown-buttons .submit-btn {
            flex: 1;
            padding: 14px 24px;
            font-size: 1rem;
        }

        .breakdown-buttons .submit-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .breakdown-output {
            margin-top: 24px;
            background: linear-gradient(135deg, rgba(124, 58, 237, 0.05) 0%, rgba(6, 182, 212, 0.05) 100%);
            border: 1px solid rgba(124, 58, 237, 0.2);
            border-radius: 16px;
            padding: 24px;
            display: none;
        }

        .breakdown-output.show {
            display: block;
        }

        .breakdown-output-header,
        .breakdown-rewrite-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .breakdown-output-header h4,
        .breakdown-rewrite-header h4 {
            font-size: 1rem;
            color: var(--text-primary);
            margin: 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .breakdown-output-header h4::before {
            content: '';
            width: 8px;
            height: 8px;
            background: linear-gradient(135deg, #7c3aed, #06b6d4);
            border-radius: 50%;
        }

        .breakdown-rewrite-header h4::before {
            content: '';
            width: 8px;
            height: 8px;
            background: linear-gradient(135deg, #10b981, #f59e0b);
            border-radius: 50%;
        }

        .breakdown-output-content,
        .breakdown-rewrite-content {
            background: var(--bg-tertiary);
            border-radius: 12px;
            padding: 20px;
            font-size: 0.95rem;
            line-height: 1.7;
            color: var(--text-highlight);
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .breakdown-rewrite {
            display: none;
            margin-top: 24px;
            padding-top: 24px;
            border-top: 1px solid var(--border-subtle);
        }

        .breakdown-rewrite.show {
            display: block;
        }

        .use-prompt-btn {
            margin-top: 16px;
            width: 100%;
            padding: 12px 20px;
            background: linear-gradient(135deg, var(--color-green) 0%, var(--color-green-dark) 100%);
            border: none;
            border-radius: 10px;
            color: #fff;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .use-prompt-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(16, 185, 129, 0.3);
        }

        .copy-btn {
            padding: 6px 14px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-light);
            border-radius: 8px;
            color: var(--text-secondary);
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .copy-btn:hover {
            background: var(--border-light);
            color: var(--text-primary);
        }

        .copy-btn.copied {
            background: var(--color-green);
            border-color: var(--color-green);
            color: #fff;
        }

        @media (max-width: 600px) {
            .breakdown-section {
                padding: 16px;
            }
            .breakdown-upload-area {
                padding: 30px 16px;
            }
            .breakdown-output {
                padding: 16px;
            }
        }

        /* ========== GALLERY PICKER MODAL STYLES ========== */
        .gallery-picker-modal {
            max-width: 700px;
            max-height: 80vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .gallery-picker-modal h3 {
            margin-bottom: 16px;
            flex-shrink: 0;
        }

        .gallery-picker-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 12px;
            overflow-y: auto;
            max-height: 50vh;
            padding: 4px;
        }

        .gallery-picker-item {
            aspect-ratio: 1;
            border-radius: 10px;
            overflow: hidden;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.2s ease;
            position: relative;
        }

        .gallery-picker-item:hover {
            border-color: var(--color-purple);
            transform: scale(1.03);
        }

        .gallery-picker-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .gallery-picker-empty {
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px;
            color: var(--text-muted);
        }

        .gallery-picker-empty.show {
            display: flex;
        }

        .gallery-picker-empty span {
            font-size: 3rem;
            margin-bottom: 12px;
        }

        .gallery-picker-filters {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--border-subtle);
        }

        .gallery-picker-filter-btn {
            padding: 6px 14px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-light);
            border-radius: 20px;
            color: var(--text-secondary);
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .gallery-picker-filter-btn:hover {
            border-color: var(--color-purple);
            color: var(--text-primary);
        }

        .gallery-picker-filter-btn.active {
            background: var(--color-purple);
            border-color: var(--color-purple);
            color: #fff;
        }

        /* Upload Options Popup */
        .upload-options-popup {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--bg-modal);
            border: 1px solid var(--border-medium);
            border-radius: 16px;
            padding: 20px;
            z-index: 10;
            display: none;
            flex-direction: column;
            gap: 12px;
            min-width: 220px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.4);
        }

        .upload-options-popup.show {
            display: flex;
        }

        .upload-option-btn {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px 18px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-light);
            border-radius: 12px;
            color: var(--text-primary);
            font-size: 0.95rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .upload-option-btn:hover {
            background: var(--border-light);
            border-color: var(--color-purple);
        }

        .upload-option-btn span {
            font-size: 1.3rem;
        }

        /* Make upload areas position relative for popup */
        .upload-area, .ref-upload-area {
            position: relative;
        }

        /* ========== QUEUE PANEL STYLES ========== */
        .queue-panel {
            background: var(--bg-card);
            border: 1px solid var(--border-light);
            border-radius: 14px;
            margin-top: 16px;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .queue-panel.hidden {
            display: none;
        }

        .queue-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 14px 18px;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-subtle);
            cursor: pointer;
            user-select: none;
        }

        .queue-header:hover {
            background: var(--bg-tertiary);
        }

        .queue-header-left {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .queue-header h4 {
            font-size: 0.95rem;
            font-weight: 600;
            color: var(--text-primary);
            margin: 0;
        }

        .queue-count {
            background: linear-gradient(135deg, var(--color-purple), var(--color-pink));
            color: #fff;
            font-size: 0.75rem;
            font-weight: 600;
            padding: 2px 8px;
            border-radius: 10px;
            min-width: 20px;
            text-align: center;
        }

        .queue-toggle-icon {
            color: var(--text-secondary);
            font-size: 1.2rem;
            transition: transform 0.3s ease;
        }

        .queue-panel.collapsed .queue-toggle-icon {
            transform: rotate(-90deg);
        }

        .queue-panel.collapsed .queue-content {
            display: none;
        }

        .queue-content {
            padding: 12px;
            max-height: 400px;
            overflow-y: auto;
        }

        .queue-empty {
            text-align: center;
            padding: 30px 20px;
            color: var(--text-tertiary);
            font-size: 0.9rem;
        }

        .queue-empty-icon {
            font-size: 2.5rem;
            margin-bottom: 10px;
            opacity: 0.5;
        }

        .queue-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .queue-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-subtle);
            border-radius: 10px;
            transition: all 0.2s ease;
        }

        .queue-item:hover {
            border-color: var(--border-medium);
        }

        .queue-item.processing {
            border-color: var(--color-purple);
            background: rgba(124, 58, 237, 0.08);
        }

        .queue-item.completed {
            border-color: var(--color-green);
            background: rgba(16, 185, 129, 0.08);
        }

        .queue-item.failed {
            border-color: var(--color-red);
            background: rgba(239, 68, 68, 0.08);
        }

        .queue-item-thumb {
            width: 48px;
            height: 48px;
            border-radius: 8px;
            object-fit: cover;
            flex-shrink: 0;
        }

        .queue-item-info {
            flex: 1;
            min-width: 0;
        }

        .queue-item-prompt {
            font-size: 0.85rem;
            color: var(--text-primary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-bottom: 4px;
        }

        .queue-item-meta {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.75rem;
        }

        .queue-status {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 2px 8px;
            border-radius: 6px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .queue-status.pending {
            background: rgba(245, 158, 11, 0.15);
            color: var(--color-amber);
        }

        .queue-status.processing {
            background: rgba(124, 58, 237, 0.15);
            color: var(--color-purple);
        }

        .queue-status.completed {
            background: rgba(16, 185, 129, 0.15);
            color: var(--color-green);
        }

        .queue-status.failed {
            background: rgba(239, 68, 68, 0.15);
            color: var(--color-red);
        }

        .queue-status-spinner {
            width: 10px;
            height: 10px;
            border: 2px solid var(--color-purple);
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .queue-eta {
            color: var(--text-secondary);
        }

        .queue-eta.countdown {
            font-family: 'Space Grotesk', monospace;
            color: var(--color-cyan);
        }

        .queue-item-actions {
            display: flex;
            gap: 6px;
        }

        .queue-action-btn {
            width: 28px;
            height: 28px;
            border: none;
            border-radius: 6px;
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
            transition: all 0.2s ease;
        }

        .queue-action-btn:hover {
            background: var(--border-medium);
            color: var(--text-primary);
        }

        .queue-action-btn.remove:hover {
            background: rgba(239, 68, 68, 0.2);
            color: var(--color-red);
        }

        .queue-progress-bar {
            margin-top: 12px;
            padding: 12px;
            background: var(--bg-secondary);
            border-radius: 10px;
            border: 1px solid var(--border-subtle);
        }

        .queue-progress-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            font-size: 0.8rem;
        }

        .queue-progress-text {
            color: var(--text-secondary);
        }

        .queue-progress-percent {
            color: var(--color-purple);
            font-weight: 600;
        }

        .queue-progress-track {
            height: 6px;
            background: var(--bg-tertiary);
            border-radius: 3px;
            overflow: hidden;
        }

        .queue-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--color-purple), var(--color-pink));
            border-radius: 3px;
            transition: width 0.3s ease;
        }

        /* ========== REVIEW TAB STYLES ========== */
        .review-tab-badge {
            background: linear-gradient(135deg, var(--color-amber), var(--color-pink));
            color: #fff;
            font-size: 0.7rem;
            font-weight: 600;
            padding: 1px 6px;
            border-radius: 8px;
            margin-left: 6px;
            min-width: 18px;
            text-align: center;
            display: inline-block;
        }

        .review-tab-badge.empty {
            display: none;
        }

        .review-tab-badge.pulse {
            animation: badgePulse 2s ease-in-out infinite;
        }

        @keyframes badgePulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.15); }
        }

        .review-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 12px;
        }

        .review-header h3 {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-primary);
            margin: 0;
        }

        .review-header-info {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .review-count-text {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .review-toolbar {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .review-btn {
            padding: 8px 14px;
            border: 1px solid var(--border-light);
            border-radius: 8px;
            background: var(--bg-card);
            color: var(--text-secondary);
            font-size: 0.8rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .review-btn:hover {
            border-color: var(--border-medium);
            color: var(--text-primary);
        }

        .review-btn.primary {
            background: linear-gradient(135deg, var(--color-green), var(--color-green-dark));
            border: none;
            color: #fff;
        }

        .review-btn.primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }

        .review-btn.danger {
            color: var(--color-red);
        }

        .review-btn.danger:hover {
            background: rgba(239, 68, 68, 0.1);
            border-color: var(--color-red);
        }

        .review-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .review-empty {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-tertiary);
        }

        .review-empty-icon {
            font-size: 4rem;
            margin-bottom: 16px;
            opacity: 0.4;
        }

        .review-empty h4 {
            font-size: 1.1rem;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        .review-empty p {
            font-size: 0.9rem;
            max-width: 300px;
            margin: 0 auto;
        }

        .review-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 16px;
        }

        .review-item {
            position: relative;
            border-radius: 12px;
            overflow: hidden;
            background: var(--bg-card);
            border: 2px solid var(--border-subtle);
            transition: all 0.2s ease;
        }

        .review-item:hover {
            border-color: var(--border-medium);
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
        }

        .review-item.selected {
            border-color: var(--color-purple);
            box-shadow: 0 0 0 2px rgba(124, 58, 237, 0.3);
        }

        .review-item-checkbox {
            position: absolute;
            top: 10px;
            left: 10px;
            width: 22px;
            height: 22px;
            border: 2px solid rgba(255, 255, 255, 0.6);
            border-radius: 6px;
            background: rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(4px);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: transparent;
            font-size: 0.8rem;
            transition: all 0.2s ease;
            z-index: 2;
        }

        .review-item.selected .review-item-checkbox {
            background: var(--color-purple);
            border-color: var(--color-purple);
            color: #fff;
        }

        .review-item-image {
            width: 100%;
            aspect-ratio: 1;
            object-fit: cover;
            cursor: pointer;
        }

        .review-item-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 40px 12px 12px;
            background: linear-gradient(transparent, rgba(0, 0, 0, 0.85));
        }

        .review-item-prompt {
            font-size: 0.75rem;
            color: #fff;
            line-height: 1.4;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            margin-bottom: 8px;
        }

        .review-item-date {
            font-size: 0.7rem;
            color: rgba(255, 255, 255, 0.6);
            margin-bottom: 10px;
        }

        .review-item-actions {
            display: flex;
            gap: 6px;
        }

        .review-item-btn {
            flex: 1;
            padding: 6px 10px;
            border: none;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
        }

        .review-item-btn.approve {
            background: var(--color-green);
            color: #fff;
        }

        .review-item-btn.approve:hover {
            background: var(--color-green-dark);
        }

        .review-item-btn.reject {
            background: rgba(255, 255, 255, 0.15);
            color: #fff;
        }

        .review-item-btn.reject:hover {
            background: rgba(239, 68, 68, 0.8);
        }

        .review-item-btn.compare {
            background: rgba(255, 255, 255, 0.15);
            color: #fff;
        }

        .review-item-btn.compare:hover {
            background: rgba(124, 58, 237, 0.6);
        }

        .review-selection-bar {
            display: none;
            align-items: center;
            justify-content: space-between;
            padding: 12px 16px;
            background: linear-gradient(135deg, rgba(124, 58, 237, 0.15), rgba(236, 72, 153, 0.15));
            border: 1px solid var(--color-purple);
            border-radius: 10px;
            margin-bottom: 16px;
        }

        .review-selection-bar.show {
            display: flex;
        }

        .review-selection-count {
            font-size: 0.9rem;
            color: var(--text-primary);
            font-weight: 500;
        }

        .review-selection-actions {
            display: flex;
            gap: 8px;
        }

        /* ========== LASSO SELECTION TOOL ========== */
        .lasso-modal {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            z-index: 3000;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            padding: 20px;
        }
        .lasso-modal.active { display: flex; }

        .lasso-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            width: 100%;
            max-width: 900px;
            margin-bottom: 16px;
        }

        .lasso-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #fff;
        }

        .lasso-close {
            width: 36px; height: 36px;
            border: none; border-radius: 8px;
            background: rgba(255, 255, 255, 0.1);
            color: #fff; font-size: 1.5rem;
            cursor: pointer;
            transition: background 0.2s ease;
        }
        .lasso-close:hover { background: rgba(255, 255, 255, 0.2); }

        .lasso-toolbar {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            margin-bottom: 16px;
        }

        .lasso-tool-btn {
            padding: 8px 14px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            background: transparent;
            color: #fff;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .lasso-tool-btn:hover { background: rgba(255, 255, 255, 0.1); }
        .lasso-tool-btn.active {
            background: var(--color-purple);
            border-color: var(--color-purple);
        }

        .lasso-brush-size {
            display: flex;
            align-items: center;
            gap: 8px;
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.8rem;
        }
        .lasso-brush-size input {
            width: 80px;
            accent-color: var(--color-purple);
        }

        .lasso-canvas-container {
            position: relative;
            max-width: 900px;
            max-height: 60vh;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        }

        .lasso-canvas-container img {
            display: block;
            max-width: 100%;
            max-height: 60vh;
            object-fit: contain;
        }

        .lasso-canvas {
            position: absolute;
            top: 0; left: 0;
            cursor: crosshair;
        }

        .lasso-instructions {
            margin-top: 12px;
            font-size: 0.85rem;
            color: rgba(255, 255, 255, 0.6);
            text-align: center;
        }

        .lasso-actions {
            display: flex;
            gap: 12px;
            margin-top: 20px;
        }

        .lasso-action-btn {
            padding: 12px 24px;
            border: none;
            border-radius: 10px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .lasso-action-btn.primary {
            background: linear-gradient(135deg, var(--color-purple), var(--color-pink));
            color: #fff;
        }
        .lasso-action-btn.primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(124, 58, 237, 0.4);
        }
        .lasso-action-btn.primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        .lasso-action-btn.secondary {
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .lasso-action-btn.secondary:hover {
            background: rgba(255, 255, 255, 0.15);
        }

        .lasso-prompt-input {
            width: 100%;
            max-width: 600px;
            margin-top: 16px;
            padding: 14px 18px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
            font-size: 0.95rem;
            font-family: inherit;
            resize: none;
        }
        .lasso-prompt-input::placeholder { color: rgba(255, 255, 255, 0.4); }
        .lasso-prompt-input:focus { outline: none; border-color: var(--color-purple); }

        /* ========== MOBILE MENU ========== */
        .mobile-menu-btn {
            display: none;
            position: fixed;
            top: 16px;
            right: 16px;
            width: 44px;
            height: 44px;
            border: 1px solid var(--border-medium);
            border-radius: 12px;
            background: var(--bg-secondary);
            cursor: pointer;
            z-index: 1001;
            padding: 0;
            align-items: center;
            justify-content: center;
        }
        .hamburger-icon {
            display: flex;
            flex-direction: column;
            gap: 5px;
            width: 20px;
        }
        .hamburger-icon span {
            display: block;
            height: 2px;
            background: var(--text-primary);
            border-radius: 2px;
            transition: all 0.3s ease;
        }
        .mobile-menu-btn.active .hamburger-icon span:nth-child(1) {
            transform: rotate(45deg) translate(5px, 5px);
        }
        .mobile-menu-btn.active .hamburger-icon span:nth-child(2) {
            opacity: 0;
        }
        .mobile-menu-btn.active .hamburger-icon span:nth-child(3) {
            transform: rotate(-45deg) translate(5px, -5px);
        }
        .mobile-menu-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        .mobile-menu-overlay.active {
            display: block;
            opacity: 1;
        }
        .mobile-menu {
            display: none;
            position: fixed;
            top: 0;
            right: -280px;
            width: 280px;
            height: 100vh;
            background: var(--bg-secondary);
            border-left: 1px solid var(--border-medium);
            z-index: 1000;
            transition: right 0.3s ease;
            overflow-y: auto;
        }
        .mobile-menu.active {
            right: 0;
        }
        .mobile-menu-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 20px;
            border-bottom: 1px solid var(--border-subtle);
            font-weight: 600;
            color: var(--text-primary);
        }
        .mobile-menu-close {
            width: 32px;
            height: 32px;
            border: none;
            background: var(--bg-tertiary);
            border-radius: 8px;
            font-size: 1.5rem;
            color: var(--text-secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1;
        }
        .mobile-menu-close:hover {
            background: var(--bg-overlay);
            color: var(--text-primary);
        }
        .mobile-menu-content {
            padding: 16px;
        }
        .mobile-menu-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px 16px;
            border: none;
            background: var(--bg-tertiary);
            border-radius: 10px;
            color: var(--text-primary);
            font-size: 0.95rem;
            font-family: inherit;
            cursor: pointer;
            width: 100%;
            margin-bottom: 8px;
            transition: all 0.2s ease;
        }
        .mobile-menu-item:hover {
            background: var(--bg-overlay);
        }
        .mobile-menu-item.primary {
            background: linear-gradient(135deg, var(--color-purple), var(--color-blue));
            color: #fff;
        }
        .mobile-menu-item.primary:hover {
            transform: scale(1.02);
        }
        .mobile-menu-item-icon {
            font-size: 1.2rem;
        }
        .mobile-menu-divider {
            height: 1px;
            background: var(--border-subtle);
            margin: 16px 0;
        }
        .mobile-menu-user {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px;
            background: var(--bg-tertiary);
            border-radius: 10px;
            margin-bottom: 16px;
        }
        .mobile-menu-user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
        }
        .mobile-menu-user-info {
            flex: 1;
            min-width: 0;
        }
        .mobile-menu-user-name {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 0.9rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .mobile-menu-user-email {
            font-size: 0.75rem;
            color: var(--text-muted);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* ========== MOBILE RESPONSIVE STYLES ========== */
        @media (max-width: 768px) {
            body {
                padding: 12px;
                padding-top: 70px;
            }

            /* Show hamburger, hide desktop elements */
            .mobile-menu-btn {
                display: flex;
            }
            .mobile-menu {
                display: block;
            }
            .theme-toggle,
            .auth-bar {
                display: none !important;
            }

            /* Header */
            .header {
                margin-bottom: 20px;
            }
            .logo-icon {
                width: 40px;
                height: 40px;
                font-size: 20px;
            }
            .logo h1 {
                font-size: 1.5rem;
            }
            .tagline {
                font-size: 0.8rem;
            }

            /* Auth Bar */
            .auth-bar {
                flex-wrap: wrap;
                gap: 8px;
                padding: 10px;
            }
            .auth-bar .user-info span {
                max-width: 100px;
                overflow: hidden;
                text-overflow: ellipsis;
                white-space: nowrap;
            }
            .tutorial-btn {
                padding: 6px 10px;
                font-size: 0.75rem;
            }

            /* Tabs */
            .tabs {
                flex-wrap: wrap;
                gap: 6px;
                padding: 6px;
            }
            .tab {
                flex: 1 1 calc(50% - 6px);
                padding: 10px 12px;
                font-size: 0.8rem;
                min-width: 0;
            }
            .review-badge {
                width: 16px;
                height: 16px;
                font-size: 0.65rem;
            }

            /* Main Grid */
            .main-grid {
                grid-template-columns: 1fr;
                gap: 16px;
            }

            /* Upload Area */
            .upload-area {
                min-height: 200px;
                padding: 20px;
            }
            .upload-icon {
                font-size: 2.5rem;
            }
            .upload-text {
                font-size: 0.85rem;
            }

            /* Reference Image */
            .ref-upload-area {
                padding: 12px;
            }

            /* Prompt Section */
            .prompt-section textarea {
                font-size: 0.9rem;
                padding: 12px;
                min-height: 80px;
            }
            .prompt-actions-row {
                flex-direction: column;
                align-items: stretch;
                gap: 10px;
            }
            .prompt-model-select {
                width: 100%;
            }
            .prompt-model-select select {
                width: 100%;
            }
            .prompt-actions {
                display: flex;
                gap: 8px;
            }
            .prompt-actions button {
                flex: 1;
                justify-content: center;
            }
            .mega-prompt-editor-btn,
            .enhance-btn {
                font-size: 0.8rem;
                padding: 0 10px;
            }

            /* Editor Mega Output */
            .editor-mega-output {
                padding: 12px;
            }
            .editor-mega-output-header {
                flex-direction: column;
                gap: 10px;
                align-items: flex-start;
            }
            .editor-mega-output-actions {
                width: 100%;
                flex-wrap: wrap;
            }
            .editor-mega-output-actions button {
                flex: 1;
                min-width: calc(50% - 4px);
            }

            /* Style Presets */
            .presets-grid {
                gap: 6px;
            }
            .preset-btn {
                padding: 6px 10px;
                font-size: 0.75rem;
            }
            .preset-btn span {
                font-size: 0.9rem;
            }

            /* Quick Actions */
            .quick-actions {
                gap: 6px;
            }
            .quick-action-btn {
                padding: 6px 10px;
                font-size: 0.75rem;
            }

            /* Options Section */
            .options-section {
                grid-template-columns: repeat(2, 1fr);
                gap: 8px;
            }
            .option-group {
                padding: 10px;
            }
            .option-group label {
                font-size: 0.65rem;
                margin-bottom: 6px;
            }
            .option-buttons {
                gap: 4px;
            }
            .option-btn {
                padding: 6px 8px;
                font-size: 0.7rem;
            }
            .aspect-btn {
                padding: 6px;
                font-size: 0.65rem;
            }

            /* Submit Button */
            .submit-btn {
                padding: 14px 24px;
                font-size: 1rem;
            }

            /* Result Area */
            .result-header {
                flex-direction: column;
                gap: 8px;
                align-items: flex-start;
            }
            .result-area img {
                border-radius: 12px;
            }
            .results-grid {
                grid-template-columns: 1fr;
                gap: 12px;
            }

            /* Gallery */
            .gallery-header {
                flex-direction: column;
                gap: 12px;
                align-items: flex-start;
            }
            .gallery-actions {
                width: 100%;
                flex-wrap: wrap;
            }
            .gallery-actions button {
                flex: 1;
                min-width: calc(50% - 4px);
                font-size: 0.75rem;
            }
            .filter-bar {
                overflow-x: auto;
                padding-bottom: 8px;
                -webkit-overflow-scrolling: touch;
            }
            .filter-btn {
                padding: 6px 12px;
                font-size: 0.75rem;
                white-space: nowrap;
            }
            .collections-bar {
                flex-wrap: wrap;
            }
            .collections-label {
                width: 100%;
                margin-bottom: 4px;
            }
            .collection-chip {
                font-size: 0.75rem;
                padding: 5px 10px;
            }
            .gallery-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 10px;
            }

            /* Queue Panel */
            .queue-panel {
                padding: 12px;
            }
            .queue-header h4 {
                font-size: 0.9rem;
            }
            .queue-item {
                padding: 10px;
            }
            .queue-item-thumb {
                width: 40px;
                height: 40px;
            }

            /* Review Tab */
            .review-header {
                flex-direction: column;
                gap: 12px;
                align-items: flex-start;
            }
            .review-actions {
                width: 100%;
                flex-wrap: wrap;
            }
            .review-actions button {
                flex: 1;
                font-size: 0.75rem;
            }
            .review-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 10px;
            }

            /* Modals */
            .modal-content,
            .collection-modal-content,
            .move-collection-modal-content {
                width: 95%;
                max-width: none;
                margin: 10px;
                padding: 16px;
                max-height: 90vh;
                overflow-y: auto;
            }
            .modal-content h3 {
                font-size: 1.1rem;
            }

            /* Lightbox */
            .lightbox-content {
                padding: 10px;
            }
            .lightbox-content img {
                max-height: 60vh;
            }
            .lightbox-actions {
                flex-wrap: wrap;
                gap: 6px;
                padding: 10px;
            }
            .lightbox-actions button {
                padding: 8px 12px;
                font-size: 0.75rem;
            }
            .lb-nav {
                width: 36px;
                height: 36px;
                font-size: 1.2rem;
            }

            /* Tutorial */
            .tutorial-tooltip {
                width: calc(100vw - 40px);
                max-width: 320px;
            }
            .tutorial-tooltip-title {
                font-size: 1rem;
            }
            .tutorial-tooltip-description {
                font-size: 0.85rem;
            }
            .tutorial-start-content {
                width: calc(100vw - 40px);
                max-width: 320px;
                padding: 20px;
            }

            /* Prompt Generator */
            .promptgen-input textarea {
                font-size: 0.9rem;
            }
            .promptgen-model-select select {
                width: 100%;
            }
            .promptgen-buttons {
                flex-direction: column;
            }
            .promptgen-buttons button {
                width: 100%;
            }
            .mega-prompt-output {
                padding: 12px;
            }
            .mega-prompt-header {
                flex-direction: column;
                gap: 10px;
            }
            .mega-prompt-actions {
                width: 100%;
                flex-wrap: wrap;
            }
            .mega-prompt-actions button {
                flex: 1;
                font-size: 0.75rem;
            }

            /* Products Section */
            .products-grid {
                grid-template-columns: 1fr;
            }

            /* Export Modal */
            .export-options {
                gap: 12px;
            }
            .export-format-btns {
                flex-wrap: wrap;
            }
            .export-format-btn {
                flex: 1;
                min-width: calc(50% - 4px);
            }

            /* Lasso Modal */
            .lasso-modal-content {
                width: 95%;
                padding: 16px;
            }
            .lasso-canvas-container {
                max-height: 50vh;
            }
        }

        /* Extra small devices */
        @media (max-width: 480px) {
            .tabs {
                gap: 4px;
            }
            .tab {
                padding: 8px 10px;
                font-size: 0.75rem;
            }

            .options-section {
                grid-template-columns: 1fr;
            }

            .gallery-grid {
                grid-template-columns: 1fr;
            }

            .review-grid {
                grid-template-columns: 1fr;
            }

            .lightbox-actions {
                flex-direction: column;
            }
            .lightbox-actions button {
                width: 100%;
            }
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/heic2any@0.0.3/dist/heic2any.min.js"></script>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>
</head>
<body>
    <!-- Mobile Hamburger Menu -->
    <button class="mobile-menu-btn" id="mobileMenuBtn" title="Menu">
        <span class="hamburger-icon">
            <span></span>
            <span></span>
            <span></span>
        </span>
    </button>
    <div class="mobile-menu-overlay" id="mobileMenuOverlay"></div>
    <div class="mobile-menu" id="mobileMenu">
        <div class="mobile-menu-header">
            <span>Menu</span>
            <button class="mobile-menu-close" id="mobileMenuClose">&times;</button>
        </div>
        <div class="mobile-menu-content" id="mobileMenuContent">
            <!-- Content populated by JS -->
        </div>
    </div>

    <!-- Theme Toggle Button -->
    <button class="theme-toggle" id="themeToggle" title="Toggle theme">
        <span class="theme-icon"></span>
    </button>

    <!-- Auth Bar (includes notifications) -->
    <div class="auth-bar" id="authBar">
        <!-- Tutorial Button -->
        <button class="tutorial-btn" id="tutorialBtn" title="Take a tour of KnappShot"><span class="tutorial-btn-icon"></span> Tour</button>
        <!-- Notification Inbox -->
        <div class="notification-inbox" id="notificationInbox">
            <button class="notification-btn" id="notificationBtn" title="Notifications">
                <span></span>
                <span class="notification-badge hidden" id="notificationBadge">0</span>
            </button>
            <div class="notification-dropdown" id="notificationDropdown">
                <div class="notification-header">
                    <h4>Notifications</h4>
                    <button class="notification-clear-btn" onclick="clearAllNotifications()">Clear all</button>
                </div>
                <div class="notification-list" id="notificationList">
                    <div class="notification-empty" id="notificationEmpty">
                        <div class="notification-empty-icon"></div>
                        <div>No notifications yet</div>
                    </div>
                </div>
            </div>
        </div>
        <button class="auth-btn" id="loginBtn">Sign In</button>
    </div>

    <!-- Auth Modal -->
    <div class="auth-modal" id="authModal">
        <div class="auth-modal-content">
            <button class="auth-close" id="authClose">&times;</button>
            <h2 id="authTitle">Sign In</h2>
            <p id="authSubtitle">Sign in to sync your gallery across devices</p>
            <div class="auth-error" id="authError"></div>
            <button class="auth-btn google" id="googleSignIn" style="width: 100%; justify-content: center; margin-bottom: 12px;">
                <svg width="18" height="18" viewBox="0 0 24 24"><path fill="#fff" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path fill="#fff" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#fff" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="#fff" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
                Continue with Google
            </button>
            <div class="auth-divider">or</div>
            <form id="emailAuthForm">
                <input type="email" class="auth-input" id="authEmail" placeholder="Email" required>
                <input type="password" class="auth-input" id="authPassword" placeholder="Password" required>
                <button type="submit" class="auth-submit" id="authSubmit">Sign In</button>
            </form>
            <div class="auth-toggle">
                <span id="authToggleText">Don't have an account?</span>
                <a id="authToggleLink">Sign Up</a>
            </div>
        </div>
    </div>

    <!-- Sync Indicator -->
    <div class="sync-indicator" id="syncIndicator">
        <div class="sync-spinner"></div>
        <span id="syncText">Syncing...</span>
    </div>

    <div class="container">
        <div class="header">
            <div class="logo">
                <div class="logo-icon">K</div>
                <h1>KnappShot</h1>
            </div>
            <p class="tagline">AI-powered photo editing with Nano Banana Pro</p>
        </div>

        <!-- First-time user welcome banner -->
        <div class="welcome-banner" id="welcomeBanner">
            <div class="welcome-content">
                <span class="welcome-icon"></span>
                <div class="welcome-text">
                    <strong>Welcome to KnappShot!</strong>
                    <p>To get started, you'll need a free API key from Google AI Studio.</p>
                </div>
                <a href="https://aistudio.google.com/apikey" target="_blank" rel="noopener" class="welcome-btn">
                    Get Free API Key
                </a>
                <button class="welcome-dismiss" id="dismissWelcome" title="Dismiss"></button>
            </div>
        </div>

        <!-- Tabs -->
        <div class="tabs">
            <button class="tab active" data-tab="editor">Editor</button>
            <button class="tab" data-tab="gallery">Gallery</button>
            <button class="tab" data-tab="review">Review<span class="review-tab-badge empty" id="reviewTabBadge">0</span></button>
            <button class="tab" data-tab="prompts">Prompt Library</button>
            <button class="tab" data-tab="system">System Instructions</button>
            <button class="tab" data-tab="products">Products</button>
            <button class="tab" data-tab="promptgen">Prompt Generator</button>
            <button class="tab" data-tab="breakdown">Image Breakdown</button>
        </div>

        <!-- Editor Tab -->
        <div class="tab-content active" id="tab-editor">
            <div class="config-section">
                <h2>API Configuration</h2>
                <div class="config-row">
                    <div class="config-field">
                        <label>Image Generation Model</label>
                        <select id="apiEndpoint">
                            <option value="https://generativelanguage.googleapis.com/v1beta/models/gemini-3-pro-image-preview:generateContent">Gemini 3 Pro Image Preview</option>
                        </select>
                    </div>
                    <div class="config-field">
                        <label>API Key</label>
                        <input type="password" id="apiKey" placeholder="Enter your API key">
                        <a href="https://aistudio.google.com/apikey" target="_blank" rel="noopener" class="api-key-help">
                            Get a free API key from Google AI Studio 
                        </a>
                    </div>
                </div>
                <div class="config-actions">
                    <button class="config-btn save" id="saveCredentials" title="Save API key to browser">Save API Key</button>
                    <button class="config-btn load" id="loadCredentials" title="Load saved API key">Load Saved</button>
                    <button class="config-btn clear" id="clearFields" title="Clear API key field">Clear Field</button>
                    <button class="config-btn clear" id="deleteSaved" title="Delete saved API key from browser">Delete Saved</button>
                    <span class="credentials-status" id="credentialsStatus"></span>
                </div>
            </div>

            <div class="main-grid">
                <div>
                    <div class="upload-area" id="uploadArea">
                        <div class="upload-icon"></div>
                        <div class="upload-text">
                            <strong>Drop, paste, or click</strong><br>
                            to upload an image
                        </div>
                        <input type="file" id="fileInput" class="hidden-input" accept="image/*,.heic,.heif" multiple>
                        <div class="upload-options-popup" id="mainUploadOptions">
                            <button class="upload-option-btn" onclick="triggerFileUpload('main')">
                                <span></span> Upload from Computer
                            </button>
                            <button class="upload-option-btn" onclick="openGalleryPicker('main')">
                                <span></span> Select from Gallery
                            </button>
                        </div>
                    </div>

                    <!-- Load from Product -->
                    <div class="product-image-loader">
                        <label>Or load from Product Profile</label>
                        <select id="editorProductSelect">
                            <option value="">-- Select a product --</option>
                        </select>
                    </div>

                    <!-- Reference Image -->
                    <div class="ref-upload-area" id="refUploadArea">
                        <div class="ref-label">+ Add Style Reference (optional)</div>
                        <input type="file" id="refFileInput" class="hidden-input" accept="image/*,.heic,.heif">
                        <div class="upload-options-popup" id="refUploadOptions">
                            <button class="upload-option-btn" onclick="triggerFileUpload('ref')">
                                <span></span> Upload from Computer
                            </button>
                            <button class="upload-option-btn" onclick="openGalleryPicker('ref')">
                                <span></span> Select from Gallery
                            </button>
                            <button class="upload-option-btn" onclick="pasteToRef()">
                                <span></span> Paste from Clipboard
                            </button>
                        </div>
                    </div>

                    <!-- Batch Mode Preview -->
                    <div class="batch-grid" id="batchGrid" style="display: none;"></div>

                    <!-- Queue Panel (Batch Mode) -->
                    <div class="queue-panel hidden" id="queuePanel">
                        <div class="queue-header" onclick="toggleQueuePanel()">
                            <div class="queue-header-left">
                                <h4>Processing Queue</h4>
                                <span class="queue-count" id="queueCount">0</span>
                            </div>
                            <span class="queue-toggle-icon"></span>
                        </div>
                        <div class="queue-content">
                            <div class="queue-empty" id="queueEmpty">
                                <div class="queue-empty-icon"></div>
                                <div>Queue is empty</div>
                                <div style="font-size: 0.8rem; margin-top: 4px; color: var(--text-muted);">
                                    Add images in batch mode to start
                                </div>
                            </div>
                            <div class="queue-list" id="queueList"></div>
                            <div class="queue-progress-bar" id="queueProgressBar" style="display: none;">
                                <div class="queue-progress-info">
                                    <span class="queue-progress-text" id="queueProgressText">Processing 0 of 0</span>
                                    <span class="queue-progress-percent" id="queueProgressPercent">0%</span>
                                </div>
                                <div class="queue-progress-track">
                                    <div class="queue-progress-fill" id="queueProgressFill" style="width: 0%;"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="result-area" id="resultArea">
                    <div class="result-placeholder">
                        <span></span>
                        Your creation will appear here
                    </div>
                </div>
            </div>

            <!-- Prompt Section -->
            <div class="prompt-section">
                <div class="prompt-wrapper">
                    <div class="prompt-highlight-backdrop" id="promptHighlightBackdrop"></div>
                    <textarea id="promptInput" placeholder="Describe the edits you want... (Type @ to reference images)"></textarea>
                    <!-- @ Mention Dropdown -->
                    <div class="mention-dropdown" id="mentionDropdown">
                        <div class="mention-dropdown-header">Reference an image</div>
                        <div class="mention-dropdown-items" id="mentionDropdownItems"></div>
                    </div>
                </div>
                <div class="prompt-actions-row">
                    <div class="prompt-model-select">
                        <select id="editorModelSelect" title="Select AI model for prompt generation">
                            <optgroup label="Gemini 3 Pro">
                                <option value="pro" selected>Gemini 3 Pro</option>
                                <option value="pro-thinking-low">Pro (Thinking - Low)</option>
                                <option value="pro-thinking-high">Pro (Thinking - High)</option>
                            </optgroup>
                            <optgroup label="Gemini 3 Flash">
                                <option value="flash">Gemini 3 Flash</option>
                                <option value="flash-thinking-minimal">Flash (Thinking - Minimal)</option>
                                <option value="flash-thinking-low">Flash (Thinking - Low)</option>
                                <option value="flash-thinking-medium">Flash (Thinking - Medium)</option>
                                <option value="flash-thinking-high">Flash (Thinking - High)</option>
                            </optgroup>
                        </select>
                        <span class="model-select-note">For prompt generation only. Images use Google's best model.</span>
                    </div>
                    <div class="prompt-actions">
                        <button class="mega-prompt-editor-btn" id="megaPromptEditorBtn" title="Generate structured mega prompt"> Mega Prompt</button>
                        <button class="enhance-btn" id="enhanceBtn" title="Enhance prompt with AI"> Enhance</button>
                    </div>
                </div>
                <!-- Mega Prompt Output (shown when generated) -->
                <div class="editor-mega-output" id="editorMegaOutput"></div>
            </div>

            <!-- Style Presets -->
            <div class="presets-section">
                <div class="presets-label">Style Presets</div>
                <div class="presets-grid">
                    <button class="preset-btn" data-style="cinematic"><span></span> Cinematic</button>
                    <button class="preset-btn" data-style="vintage"><span></span> Vintage</button>
                    <button class="preset-btn" data-style="neon"><span></span> Neon</button>
                    <button class="preset-btn" data-style="watercolor"><span></span> Watercolor</button>
                    <button class="preset-btn" data-style="anime"><span></span> Anime</button>
                    <button class="preset-btn" data-style="minimalist"><span></span> Minimalist</button>
                    <button class="preset-btn" data-style="dramatic"><span></span> Dramatic</button>
                    <button class="preset-btn" data-style="dreamy"><span></span> Dreamy</button>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="quick-actions">
                <div class="presets-label">Quick Actions</div>
                <div class="quick-actions-grid">
                    <button class="quick-action-btn" data-action="remove-bg">Remove Background</button>
                    <button class="quick-action-btn" data-action="enhance">Enhance Quality</button>
                    <button class="quick-action-btn" data-action="upscale">Upscale 2x</button>
                    <button class="quick-action-btn" data-action="restore">Restore Old Photo</button>
                    <button class="quick-action-btn" data-action="colorize">Colorize B&W</button>
                </div>
            </div>

            <!-- Options -->
            <div class="options-section">
                <div class="option-group" style="grid-column: span 2;">
                    <label>Aspect Ratio</label>
                    <div class="option-buttons" id="aspectRatioButtons">
                        <button class="option-btn aspect-btn active" data-value="1:1">1:1
                            <div class="aspect-tooltip"><div class="aspect-preview" style="width: 40px; height: 40px;"></div><span>Square</span></div>
                        </button>
                        <button class="option-btn aspect-btn" data-value="16:9">16:9
                            <div class="aspect-tooltip"><div class="aspect-preview" style="width: 48px; height: 27px;"></div><span>Widescreen</span></div>
                        </button>
                        <button class="option-btn aspect-btn" data-value="9:16">9:16
                            <div class="aspect-tooltip"><div class="aspect-preview" style="width: 27px; height: 48px;"></div><span>Portrait</span></div>
                        </button>
                        <button class="option-btn aspect-btn" data-value="4:3">4:3
                            <div class="aspect-tooltip"><div class="aspect-preview" style="width: 44px; height: 33px;"></div><span>Landscape</span></div>
                        </button>
                        <button class="option-btn aspect-btn" data-value="3:4">3:4
                            <div class="aspect-tooltip"><div class="aspect-preview" style="width: 33px; height: 44px;"></div><span>Portrait</span></div>
                        </button>
                        <button class="option-btn aspect-btn" data-value="4:5">4:5
                            <div class="aspect-tooltip"><div class="aspect-preview" style="width: 36px; height: 45px;"></div><span>Instagram</span></div>
                        </button>
                        <button class="option-btn aspect-btn" data-value="3:2">3:2
                            <div class="aspect-tooltip"><div class="aspect-preview" style="width: 45px; height: 30px;"></div><span>Landscape</span></div>
                        </button>
                        <button class="option-btn aspect-btn" data-value="2:3">2:3
                            <div class="aspect-tooltip"><div class="aspect-preview" style="width: 30px; height: 45px;"></div><span>Portrait</span></div>
                        </button>
                    </div>
                </div>
                <div class="option-group">
                    <label>Resolution</label>
                    <div class="option-buttons" id="resolutionButtons">
                        <button class="option-btn active" data-value="1K">1K</button>
                        <button class="option-btn" data-value="2K">2K</button>
                        <button class="option-btn" data-value="4K">4K</button>
                    </div>
                </div>
                <div class="option-group">
                    <label>Generations</label>
                    <div class="option-buttons" id="generationCountButtons">
                        <button class="option-btn active" data-value="1">1</button>
                        <button class="option-btn" data-value="2">2</button>
                        <button class="option-btn" data-value="3">3</button>
                        <button class="option-btn" data-value="4">4</button>
                    </div>
                </div>
                <div class="option-group">
                    <label>Mode</label>
                    <div class="option-buttons" id="modeButtons">
                        <button class="option-btn active" data-value="single">Single</button>
                        <button class="option-btn" data-value="batch">Batch</button>
                    </div>
                </div>
            </div>

            <button class="submit-btn" id="submitBtn"><span>Generate Edit</span></button>
            <div class="status" id="status"></div>
        </div>

        <!-- Gallery Tab -->
        <div class="tab-content" id="tab-gallery">
            <div class="gallery-header">
                <h3>Your Creations</h3>
                <div class="gallery-filters">
                    <button class="filter-btn active" data-filter="all">All</button>
                    <button class="filter-btn" data-filter="favorites">Favorites</button>
                </div>
            </div>
            <div class="collections-bar" id="collectionsBar">
                <span class="collections-label">Collections:</span>
                <div class="collections-list" id="collectionsList">
                    <button class="collection-chip active" data-collection="all">
                        All <span class="collection-count" id="allCount">0</span>
                    </button>
                </div>
                <button class="add-collection-btn" id="addCollectionBtn" title="Create new collection">+</button>
            </div>
            <div class="gallery-toolbar" id="galleryToolbar">
                <div class="gallery-toolbar-left">
                    <button class="select-btn" id="selectModeBtn">Select</button>
                    <button class="select-btn" id="selectAllBtn" style="display:none;">Select All</button>
                    <span class="selection-count" id="selectionCount" style="display:none;">0 selected</span>
                </div>
                <div class="gallery-toolbar-right">
                    <button class="select-btn" id="moveToCollectionBtn" style="display:none;" disabled onclick="openMoveToCollectionModal(null, true)">Move to Collection</button>
                    <button class="delete-selected-btn" id="deleteSelectedBtn" style="display:none;" disabled>Delete Selected</button>
                    <button class="export-btn" id="exportSelectedBtn" style="display:none;" disabled>Download Selected</button>
                </div>
            </div>
            <div class="gallery-grid" id="galleryGrid">
                <div class="gallery-empty">
                    <span></span>
                    No images yet. Start creating!
                </div>
            </div>
        </div>

        <!-- Review Tab -->
        <div class="tab-content" id="tab-review">
            <div class="review-header">
                <div class="review-header-info">
                    <h3>Review Generated Images</h3>
                    <span class="review-count-text" id="reviewCountText">0 images pending review</span>
                </div>
                <div class="review-toolbar">
                    <button class="review-btn" id="reviewSelectModeBtn" onclick="toggleReviewSelectMode()">Select</button>
                    <button class="review-btn primary" id="approveAllBtn" onclick="approveAllReview()" disabled>Add All to Gallery</button>
                    <button class="review-btn danger" id="clearReviewBtn" onclick="clearReview()" disabled>Discard All</button>
                </div>
            </div>
            <div class="review-selection-bar" id="reviewSelectionBar">
                <span class="review-selection-count" id="reviewSelectionCount">0 selected</span>
                <div class="review-selection-actions">
                    <button class="review-btn" onclick="selectAllReview()">Select All</button>
                    <button class="review-btn primary" onclick="approveSelectedReview()">Add Selected to Gallery</button>
                    <button class="review-btn danger" onclick="rejectSelectedReview()">Discard Selected</button>
                </div>
            </div>
            <div class="review-empty" id="reviewEmpty">
                <div class="review-empty-icon"></div>
                <h4>No images to review</h4>
                <p>Generated batch images will appear here for review before adding to your gallery.</p>
            </div>
            <div class="review-grid" id="reviewGrid"></div>
        </div>

        <!-- Prompts Tab -->
        <div class="tab-content" id="tab-prompts">
            <div class="prompt-library-header">
                <h3>Saved Prompts</h3>
            </div>
            <div class="prompt-list" id="promptList">
                <div class="prompt-empty">
                    <span></span>
                    No saved prompts yet. Save a prompt after generating!
                </div>
            </div>
        </div>

        <!-- System Instructions Tab -->
        <div class="tab-content" id="tab-system">
            <div class="system-instructions-section">
                <div class="system-header">
                    <h3>System Instructions</h3>
                    <span class="system-badge">Optional</span>
                </div>
                <p class="system-description">
                    Add custom instructions that will be included with every generation request.
                    Use this for consistent styling, brand guidelines, or specific requirements.
                </p>
                <textarea id="systemInstructions" class="system-textarea" placeholder="Example: Always maintain a consistent warm color palette. Keep subjects centered. Use soft, natural lighting. Avoid oversaturation..."></textarea>
                <div class="system-actions">
                    <button class="action-btn save" onclick="saveSystemInstructions()">Save Instructions</button>
                    <button class="clear-btn" onclick="clearSystemInstructions()">Clear</button>
                </div>
                <div class="system-status" id="systemStatus"></div>
            </div>
        </div>

        <!-- Products Tab -->
        <div class="tab-content" id="tab-products">
            <div class="products-header">
                <h3>Product Profiles</h3>
                <button class="action-btn save" id="addProductBtn">+ Add Product</button>
            </div>
            <p class="products-description">
                Create product profiles with descriptions, golden phrases (always include),
                and forbidden words (never use). Select an active profile to use in the Prompt Generator.
            </p>
            <div class="products-list" id="productsList">
                <div class="products-empty">
                    <span></span>
                    No products yet. Add your first product profile!
                </div>
            </div>
        </div>

        <!-- Prompt Generator Tab -->
        <div class="tab-content" id="tab-promptgen">
            <div class="promptgen-section">
                <div class="promptgen-header">
                    <h3>AI Prompt Generator</h3>
                    <span class="system-badge">Powered by Gemini</span>
                </div>
                <p class="promptgen-description">
                    Describe your idea and let AI generate optimized prompts using your product profile.
                </p>

                <!-- Product Selection -->
                <div class="promptgen-product-select">
                    <label>Active Product Profile</label>
                    <select id="promptgenProductSelect">
                        <option value="">-- No product selected --</option>
                    </select>
                    <div class="active-product-preview" id="activeProductPreview"></div>
                </div>

                <!-- Idea Input -->
                <div class="promptgen-input">
                    <label>Describe Your Idea</label>
                    <textarea id="promptgenIdea" placeholder="e.g., Product floating on clouds with soft morning light, minimal background..."></textarea>
                </div>

                <!-- Model Selection -->
                <div class="promptgen-model-select">
                    <label>Text Generation Model</label>
                    <select id="promptgenModelSelect">
                        <optgroup label="Gemini 3 Pro">
                            <option value="pro" selected>Gemini 3 Pro</option>
                            <option value="pro-thinking-low">Gemini 3 Pro (Thinking - Low)</option>
                            <option value="pro-thinking-high">Gemini 3 Pro (Thinking - High)</option>
                        </optgroup>
                        <optgroup label="Gemini 3 Flash">
                            <option value="flash">Gemini 3 Flash</option>
                            <option value="flash-thinking-minimal">Gemini 3 Flash (Thinking - Minimal)</option>
                            <option value="flash-thinking-low">Gemini 3 Flash (Thinking - Low)</option>
                            <option value="flash-thinking-medium">Gemini 3 Flash (Thinking - Medium)</option>
                            <option value="flash-thinking-high">Gemini 3 Flash (Thinking - High)</option>
                        </optgroup>
                    </select>
                </div>

                <!-- Generation Options -->
                <div class="promptgen-options">
                    <div class="option-group">
                        <label>Number of Prompts</label>
                        <div class="option-buttons" id="promptCountButtons">
                            <button class="option-btn" data-value="1">1</button>
                            <button class="option-btn active" data-value="3">3</button>
                            <button class="option-btn" data-value="5">5</button>
                            <button class="option-btn" data-value="7">7</button>
                        </div>
                    </div>
                    <div class="option-group">
                        <label>Style Focus <span class="field-hint">(Optional)</span></label>
                        <div class="option-buttons" id="styleFocusButtons">
                            <button class="option-btn active" data-value="">Not sure</button>
                            <button class="option-btn" data-value="product">Product</button>
                            <button class="option-btn" data-value="lifestyle">Lifestyle</button>
                            <button class="option-btn" data-value="artistic">Artistic</button>
                        </div>
                    </div>
                </div>

                <div class="promptgen-buttons">
                    <button class="submit-btn" id="generatePromptsBtn">
                        <span>Generate Prompts</span>
                    </button>
                    <button class="mega-prompt-btn" id="generateMegaPromptBtn">
                        <span>Mega Prompt</span>
                    </button>
                </div>
                <div class="status" id="promptgenStatus"></div>

                <!-- Mega Prompt Output -->
                <div class="mega-prompt-output" id="megaPromptOutput"></div>

                <!-- Generated Prompts -->
                <div class="generated-prompts" id="generatedPrompts"></div>
            </div>
        </div>

        <!-- Image Breakdown Tab -->
        <div class="tab-content" id="tab-breakdown">
            <div class="breakdown-section">
                <div class="breakdown-header">
                    <h3>Image Breakdown</h3>
                    <span class="system-badge">Powered by Gemini</span>
                </div>
                <p class="breakdown-description">
                    Upload any image and AI will describe exactly what's happening - composition, lighting, mood, subjects, and more. Perfect for analyzing ads, photos, or concepts you want to recreate.
                </p>

                <!-- Image Upload Area -->
                <div class="breakdown-upload-area" id="breakdownUploadArea">
                    <div class="breakdown-upload-content">
                        <div class="breakdown-upload-icon"></div>
                        <div class="breakdown-upload-text">Drop, paste, or click to upload</div>
                        <div class="breakdown-upload-hint">Supports JPG, PNG, WebP, HEIC</div>
                    </div>
                    <input type="file" id="breakdownFileInput" class="hidden-input" accept="image/*,.heic,.heif">
                </div>

                <!-- Image Preview -->
                <div class="breakdown-image-preview" id="breakdownImagePreview">
                    <img id="breakdownPreviewImg" src="" alt="Preview" class="preview-image" style="cursor: zoom-in;" title="Click to preview">
                    <button class="breakdown-remove-btn" id="breakdownRemoveBtn">&times;</button>
                </div>

                <!-- Model Selection -->
                <div class="breakdown-model-select">
                    <label>Analysis Model</label>
                    <select id="breakdownModelSelect">
                        <optgroup label="Gemini 3 Pro">
                            <option value="pro" selected>Gemini 3 Pro</option>
                            <option value="pro-thinking-low">Gemini 3 Pro (Thinking - Low)</option>
                            <option value="pro-thinking-high">Gemini 3 Pro (Thinking - High)</option>
                        </optgroup>
                        <optgroup label="Gemini 3 Flash">
                            <option value="flash">Gemini 3 Flash</option>
                            <option value="flash-thinking-minimal">Gemini 3 Flash (Thinking - Minimal)</option>
                            <option value="flash-thinking-low">Gemini 3 Flash (Thinking - Low)</option>
                            <option value="flash-thinking-medium">Gemini 3 Flash (Thinking - Medium)</option>
                            <option value="flash-thinking-high">Gemini 3 Flash (Thinking - High)</option>
                        </optgroup>
                    </select>
                </div>

                <!-- Product Selection (Optional) -->
                <div class="breakdown-product-select">
                    <label>Rewrite for Product <span class="field-hint">(Optional)</span></label>
                    <select id="breakdownProductSelect">
                        <option value="">-- Just describe the image --</option>
                    </select>
                    <div class="breakdown-product-hint" id="breakdownProductHint">
                        When a product is selected, AI will also generate a prompt to recreate this concept with your product.
                    </div>
                </div>

                <!-- Analyze Button -->
                <div class="breakdown-buttons">
                    <button class="submit-btn" id="analyzeImageBtn" disabled>
                        <span>Analyze Image</span>
                    </button>
                </div>
                <div class="status" id="breakdownStatus"></div>

                <!-- Analysis Output -->
                <div class="breakdown-output" id="breakdownOutput">
                    <div class="breakdown-output-header">
                        <h4>Image Analysis</h4>
                        <button class="copy-btn" id="copyBreakdownBtn">Copy</button>
                    </div>
                    <div class="breakdown-output-content" id="breakdownOutputContent"></div>
                    <button class="use-prompt-btn" id="useAnalysisBtn">Use in Editor</button>

                    <!-- Product Rewrite Section -->
                    <div class="breakdown-rewrite" id="breakdownRewrite">
                        <div class="breakdown-rewrite-header">
                            <h4>Recreate with Your Product</h4>
                            <button class="copy-btn" id="copyRewriteBtn">Copy</button>
                        </div>
                        <div class="breakdown-rewrite-content" id="breakdownRewriteContent"></div>
                        <button class="use-prompt-btn" id="useRewriteBtn">Use in Editor</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Ideas Modal -->
    <div class="modal" id="ideasModal">
        <div class="modal-content" style="position: relative;">
            <button class="modal-close" onclick="closeModal('ideasModal')">&times;</button>
            <h3>Prompt Ideas from Gemini</h3>
            <div id="ideasContainer"></div>
        </div>
    </div>

    <!-- Gallery Picker Modal -->
    <div class="modal" id="galleryPickerModal">
        <div class="modal-content gallery-picker-modal">
            <button class="modal-close" onclick="closeGalleryPicker()">&times;</button>
            <h3 id="galleryPickerTitle">Select from Gallery</h3>
            <div class="gallery-picker-filters" id="galleryPickerFilters"></div>
            <div class="gallery-picker-grid" id="galleryPickerGrid"></div>
            <div class="gallery-picker-empty" id="galleryPickerEmpty">
                <span></span>
                <p>No images in your gallery yet</p>
            </div>
        </div>
    </div>

    <!-- Export Modal -->
    <div class="modal" id="exportModal">
        <div class="modal-content" style="position: relative;">
            <button class="modal-close" onclick="closeModal('exportModal')">&times;</button>
            <h3>Export Image</h3>
            <div class="export-options">
                <div class="export-option-group">
                    <label>Format</label>
                    <div class="export-format-btns">
                        <button class="export-format-btn active" data-format="png">
                            <span></span>PNG
                        </button>
                        <button class="export-format-btn" data-format="jpg">
                            <span></span>JPG
                        </button>
                        <button class="export-format-btn" data-format="webp">
                            <span></span>WebP
                        </button>
                    </div>
                </div>
                <div class="export-option-group" id="qualityGroup">
                    <label>Quality</label>
                    <input type="range" class="quality-slider" id="qualitySlider" min="10" max="100" value="90">
                    <div class="quality-value"><span id="qualityValue">90</span>%</div>
                </div>
                <button class="export-btn" id="exportBtn">Download Image</button>
            </div>
        </div>
    </div>

    <!-- Comparison Modal -->
    <div class="modal" id="compareModal">
        <div class="modal-content" style="position: relative; max-width: 700px;">
            <button class="modal-close" onclick="closeModal('compareModal')">&times;</button>
            <h3>Before / After</h3>
            <div class="comparison-container" id="comparisonContainer">
                <img id="compareAfter" src="" alt="After">
                <div class="comparison-before">
                    <img id="compareBefore" src="" alt="Before">
                </div>
                <div class="comparison-slider" id="comparisonSlider"></div>
                <div class="comparison-label before">Before</div>
                <div class="comparison-label after">After</div>
            </div>
        </div>
    </div>

    <!-- Product Modal -->
    <div class="modal" id="productModal">
        <div class="modal-content" style="position: relative; max-width: 600px;">
            <button class="modal-close" onclick="closeModal('productModal')">&times;</button>
            <h3 id="productModalTitle">Add Product Profile</h3>
            <div class="product-form">
                <div class="form-field">
                    <label>Product Name</label>
                    <input type="text" id="productName" placeholder="e.g., Cosmetic Applicator">
                </div>
                <div class="form-field">
                    <label>Product Description</label>
                    <textarea id="productDescription" placeholder="Describe the physical appearance of your product..."></textarea>
                </div>
                <div class="form-field">
                    <label>Golden Phrases <span class="field-hint">(Always include in prompts - one per line)</span></label>
                    <textarea id="productGoldenPhrases" placeholder="a slim stainless steel rod with a precision threaded screw texture at the tip, no bristles"></textarea>
                </div>
                <div class="form-field">
                    <label>Forbidden Words <span class="field-hint">(Never use - comma separated)</span></label>
                    <input type="text" id="productForbiddenWords" placeholder="mascara, bristles, brush">
                </div>
                <div class="form-field">
                    <label>Reference Image <span class="field-hint">(Optional)</span></label>
                    <input type="file" id="productImageInput" class="hidden-input" accept="image/*,.heic,.heif">
                    <label for="productImageInput" class="product-image-upload" id="productImageUpload">
                        <span>Click to upload reference image</span>
                    </label>
                </div>
                <div class="form-actions">
                    <button class="action-btn save" id="saveProductBtn">Save Product</button>
                    <button class="clear-btn" onclick="closeModal('productModal')">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Batch Export Modal -->
    <div class="modal" id="batchExportModal">
        <div class="modal-content" style="position: relative; max-width: 450px;">
            <button class="modal-close" onclick="closeModal('batchExportModal')">&times;</button>
            <h3>Export Selected Images</h3>
            <div class="batch-export-options">
                <div>
                    <label>Format</label>
                    <select id="batchExportFormat">
                        <option value="png">PNG (Lossless)</option>
                        <option value="jpeg" selected>JPEG (Smaller size)</option>
                        <option value="webp">WebP (Best compression)</option>
                    </select>
                </div>
                <div id="batchQualitySection">
                    <label>Quality</label>
                    <div class="quality-slider-container">
                        <input type="range" id="batchExportQuality" min="10" max="100" value="90">
                        <span class="quality-value" id="batchQualityValue">90%</span>
                    </div>
                </div>
                <div class="batch-export-preview" id="batchExportPreview">
                    0 images selected
                </div>
            </div>
            <div class="batch-export-actions">
                <button class="clear-btn" onclick="closeModal('batchExportModal')">Cancel</button>
                <button class="action-btn save" id="batchExportBtn">Download ZIP</button>
            </div>
        </div>
    </div>

    <!-- Lightbox -->
    <div class="lightbox" id="lightbox">
        <button class="lightbox-close" onclick="closeLightbox()">&times;</button>
        <button class="lightbox-nav prev" id="lbPrev" onclick="lightboxNav(-1)">&#8249;</button>
        <button class="lightbox-nav next" id="lbNext" onclick="lightboxNav(1)">&#8250;</button>
        <div class="lightbox-image-container">
            <img class="lightbox-image" id="lightboxImage" src="" alt="Preview">
        </div>
        <div class="lightbox-actions">
            <button class="lb-download" onclick="downloadLightboxImage()">Download</button>
            <button class="lb-download" id="lbEditBtn" onclick="editFromLightbox()" style="background: linear-gradient(135deg, #f59e0b, #d97706);">Edit This</button>
        </div>
        <div class="lightbox-counter" id="lightboxCounter"></div>
    </div>

    <!-- Lasso Selection Tool Modal -->
    <div class="lasso-modal" id="lassoModal">
        <div class="lasso-header">
            <span class="lasso-title">Select Area to Edit</span>
            <button class="lasso-close" onclick="closeLassoModal()">&times;</button>
        </div>
        <div class="lasso-toolbar">
            <button class="lasso-tool-btn active" id="lassoBrushBtn" onclick="setLassoTool('brush')">
                <span></span> Brush
            </button>
            <button class="lasso-tool-btn" id="lassoEraserBtn" onclick="setLassoTool('eraser')">
                <span></span> Eraser
            </button>
            <div class="lasso-brush-size">
                <span>Size:</span>
                <input type="range" id="lassoBrushSize" min="5" max="100" value="30">
                <span id="lassoBrushSizeValue">30</span>
            </div>
            <button class="lasso-tool-btn" onclick="clearLassoSelection()">
                <span></span> Clear
            </button>
        </div>
        <div class="lasso-canvas-container" id="lassoCanvasContainer">
            <img id="lassoImage" src="" alt="Edit image">
            <canvas class="lasso-canvas" id="lassoCanvas"></canvas>
        </div>
        <div class="lasso-instructions">
            Paint over the area you want to change. The highlighted region will be modified.
        </div>
        <textarea class="lasso-prompt-input" id="lassoPromptInput" placeholder="Describe what you want to change in the selected area..." rows="2"></textarea>
        <div class="lasso-actions">
            <button class="lasso-action-btn secondary" onclick="closeLassoModal()">Cancel</button>
            <button class="lasso-action-btn primary" id="lassoApplyBtn" onclick="applyLassoEdit()" disabled>Apply Edit</button>
        </div>
    </div>

    <!-- Collection Modal -->
    <div class="collection-modal" id="collectionModal">
        <div class="collection-modal-content">
            <div class="collection-modal-header">
                <h3 id="collectionModalTitle">Create Collection</h3>
                <button class="collection-modal-close" onclick="closeCollectionModal()">&times;</button>
            </div>
            <div id="collectionModalBody">
                <input type="text" class="collection-input" id="collectionNameInput" placeholder="Collection name...">
            </div>
            <div class="collection-modal-actions" id="collectionModalActions">
                <button class="collection-modal-btn cancel" onclick="closeCollectionModal()">Cancel</button>
                <button class="collection-modal-btn confirm" id="collectionModalConfirm" onclick="confirmCollectionAction()">Create</button>
            </div>
        </div>
    </div>

    <!-- Move to Collection Modal -->
    <div class="collection-modal" id="moveToCollectionModal">
        <div class="collection-modal-content">
            <div class="collection-modal-header">
                <h3>Move to Collection</h3>
                <button class="collection-modal-close" onclick="closeMoveToCollectionModal()">&times;</button>
            </div>
            <div id="moveToCollectionList" class="existing-collections">
                <!-- Populated dynamically -->
            </div>
            <div class="collection-modal-actions">
                <button class="collection-modal-btn cancel" onclick="closeMoveToCollectionModal()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Tutorial Start Modal -->
    <div class="tutorial-start-modal" id="tutorialStartModal">
        <div class="tutorial-start-content">
            <div class="tutorial-start-icon"></div>
            <h2 class="tutorial-start-title">Welcome to KnappShot!</h2>
            <p class="tutorial-start-description">
                Would you like a quick tour of the main features?
                We'll show you how to create stunning AI-edited images in just a few steps.
            </p>
            <div class="tutorial-start-actions">
                <button class="tutorial-start-btn secondary" onclick="closeTutorialStart()">Maybe Later</button>
                <button class="tutorial-start-btn primary" onclick="startTutorial()">Start Tour</button>
            </div>
        </div>
    </div>

    <!-- Tutorial Highlight & Tooltip (rendered dynamically) -->
    <div class="tutorial-highlight" id="tutorialHighlight" style="display: none;"></div>
    <div class="tutorial-tooltip" id="tutorialTooltip" style="display: none;"></div>

    <script>
        // ========== FIREBASE INITIALIZATION ==========
        const firebaseConfig = {
            apiKey: "AIzaSyBvhDPLBm1UL1LdJnXrPDmoUVAcvVPNcYQ",
            authDomain: "knappshot-ed719.firebaseapp.com",
            projectId: "knappshot-ed719",
            storageBucket: "knappshot-ed719.firebasestorage.app",
            messagingSenderId: "248567883876",
            appId: "1:248567883876:web:225cfc2bdad67794491771"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const storage = firebase.storage();

        // Auth state
        let currentUser = null;

        // ========== STORAGE ==========
        const Storage = {
            get(key, defaultVal = null) {
                try {
                    const data = localStorage.getItem('knappshot_' + key);
                    return data ? JSON.parse(data) : defaultVal;
                } catch { return defaultVal; }
            },
            set(key, value) {
                try {
                    localStorage.setItem('knappshot_' + key, JSON.stringify(value));
                    return true;
                } catch (e) {
                    console.error('Storage error:', e);
                    return false;
                }
            },
            // Save only when NOT signed in (cloud is source of truth when signed in)
            setIfOffline(key, value) {
                if (typeof currentUser !== 'undefined' && currentUser) {
                    // User is signed in, don't save to localStorage
                    // Cloud sync will handle persistence
                    return true;
                }
                return this.set(key, value);
            }
        };

        // ========== STATE ==========
        let state = {
            currentImage: null,
            currentImageBase64: null,
            currentImageMimeType: 'image/jpeg',
            referenceImage: null,
            referenceImageBase64: null,
            batchImages: [],
            generatedImages: [],
            originalImage: null,
            selectedAspectRatio: '1:1',
            selectedResolution: '1K',
            selectedGenerationCount: 1,
            mode: 'single',
            exportFormat: 'png',
            exportQuality: 90,
            exportImageSrc: null,
            gallery: Storage.get('gallery', []),
            prompts: Storage.get('prompts', []),
            generatedPrompts: [],
            currentMegaPrompt: null,
            // Queue system
            queue: [],
            queueHistory: [],
            avgProcessingTime: 15000,
            isProcessing: false,
            currentQueueItem: null,
            queueTimerInterval: null,
            // Review system
            reviewItems: Storage.get('reviewItems', []),
            reviewSelectMode: false,
            // Collections system
            collections: Storage.get('collections', []),
            activeCollection: null,
            // Products system
            products: Storage.get('products', []),
            activeProductId: Storage.get('activeProductId', null)
        };

        // ========== DOM ELEMENTS ==========
        const $ = id => document.getElementById(id);
        const uploadArea = $('uploadArea');
        const fileInput = $('fileInput');
        const refUploadArea = $('refUploadArea');
        const refFileInput = $('refFileInput');
        const resultArea = $('resultArea');
        const promptInput = $('promptInput');
        const submitBtn = $('submitBtn');
        const statusDiv = $('status');
        const apiEndpointInput = $('apiEndpoint');
        const apiKeyInput = $('apiKey');
        const enhanceBtn = $('enhanceBtn');
        const batchGrid = $('batchGrid');

        // Auto-resize prompt textarea to fit content
        function autoResizePromptInput() {
            if (!promptInput) return;
            // Reset height to auto to get the correct scrollHeight
            promptInput.style.height = 'auto';
            // Set height to scrollHeight (content height) with min/max bounds
            const minHeight = 90;
            const maxHeight = 500;
            const newHeight = Math.min(Math.max(promptInput.scrollHeight, minHeight), maxHeight);
            promptInput.style.height = newHeight + 'px';
        }

        // Auto-resize on input, paste, and initial load
        promptInput.addEventListener('input', autoResizePromptInput);
        promptInput.addEventListener('paste', () => setTimeout(autoResizePromptInput, 0));

        // ========== @ MENTION SYSTEM ==========
        const mentionDropdown = $('mentionDropdown');
        const mentionDropdownItems = $('mentionDropdownItems');
        const promptHighlightBackdrop = $('promptHighlightBackdrop');
        let mentionStartIndex = -1;
        let selectedMentionIndex = 0;

        // Update highlight backdrop to show @mentions in purple
        function updateMentionHighlights() {
            const text = promptInput.value;
            // Escape HTML and highlight @mentions
            const escaped = text
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/(@main-image|@reference)/g, '<span class="mention-highlight">$1</span>');
            // Add a trailing space to match textarea line height
            promptHighlightBackdrop.innerHTML = escaped + '\n';
            // Sync scroll position
            promptHighlightBackdrop.scrollTop = promptInput.scrollTop;
        }

        // Sync backdrop with textarea
        promptInput.addEventListener('input', updateMentionHighlights);
        promptInput.addEventListener('scroll', () => {
            promptHighlightBackdrop.scrollTop = promptInput.scrollTop;
        });

        function getAvailableImages() {
            const images = [];
            if (state.currentImage) {
                images.push({
                    id: 'main-image',
                    name: 'Main Image',
                    desc: 'The uploaded image to edit',
                    icon: state.currentImage,
                    tag: '@main-image'
                });
            }
            if (state.referenceImage) {
                images.push({
                    id: 'reference-image',
                    name: 'Reference Image',
                    desc: 'Style reference image',
                    icon: state.referenceImage,
                    tag: '@reference'
                });
            }
            return images;
        }

        function showMentionDropdown() {
            const images = getAvailableImages();
            if (images.length === 0) {
                hideMentionDropdown();
                return;
            }

            selectedMentionIndex = 0;
            mentionDropdownItems.innerHTML = images.map((img, i) => `
                <div class="mention-item ${i === 0 ? 'selected' : ''}" data-index="${i}" data-tag="${img.tag}">
                    <div class="mention-item-icon">
                        <img src="${img.icon}" alt="${img.name}">
                    </div>
                    <div class="mention-item-info">
                        <div class="mention-item-name">${img.name}</div>
                        <div class="mention-item-desc">${img.desc}</div>
                    </div>
                    <span class="mention-tag">${img.tag}</span>
                </div>
            `).join('');

            mentionDropdown.classList.add('active');
        }

        function hideMentionDropdown() {
            mentionDropdown.classList.remove('active');
            mentionStartIndex = -1;
        }

        function insertMention(tag) {
            const text = promptInput.value;
            const before = text.substring(0, mentionStartIndex);
            const after = text.substring(promptInput.selectionStart);
            promptInput.value = before + tag + ' ' + after;
            promptInput.selectionStart = promptInput.selectionEnd = mentionStartIndex + tag.length + 1;
            promptInput.focus();
            hideMentionDropdown();
            autoResizePromptInput();
            updateMentionHighlights();
        }

        function updateMentionSelection(newIndex) {
            const items = mentionDropdownItems.querySelectorAll('.mention-item');
            if (items.length === 0) return;

            selectedMentionIndex = Math.max(0, Math.min(newIndex, items.length - 1));
            items.forEach((item, i) => {
                item.classList.toggle('selected', i === selectedMentionIndex);
            });
        }

        // Listen for @ symbol in prompt input
        promptInput.addEventListener('input', (e) => {
            const text = promptInput.value;
            const cursorPos = promptInput.selectionStart;

            // Check if we just typed @
            if (text[cursorPos - 1] === '@') {
                // Make sure it's at the start or after a space
                if (cursorPos === 1 || text[cursorPos - 2] === ' ' || text[cursorPos - 2] === '\n') {
                    mentionStartIndex = cursorPos - 1;
                    showMentionDropdown();
                    return;
                }
            }

            // If dropdown is open, check if we should close it
            if (mentionDropdown.classList.contains('active')) {
                // Close if we deleted the @
                if (mentionStartIndex >= cursorPos || text[mentionStartIndex] !== '@') {
                    hideMentionDropdown();
                }
            }
        });

        // Handle keyboard navigation in mention dropdown
        promptInput.addEventListener('keydown', (e) => {
            if (!mentionDropdown.classList.contains('active')) return;

            const items = mentionDropdownItems.querySelectorAll('.mention-item');
            if (items.length === 0) return;

            if (e.key === 'ArrowDown') {
                e.preventDefault();
                updateMentionSelection(selectedMentionIndex + 1);
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                updateMentionSelection(selectedMentionIndex - 1);
            } else if (e.key === 'Enter' || e.key === 'Tab') {
                e.preventDefault();
                const selectedItem = items[selectedMentionIndex];
                if (selectedItem) {
                    insertMention(selectedItem.dataset.tag);
                }
            } else if (e.key === 'Escape') {
                e.preventDefault();
                hideMentionDropdown();
            }
        });

        // Handle click on mention items
        mentionDropdownItems.addEventListener('click', (e) => {
            const item = e.target.closest('.mention-item');
            if (item) {
                insertMention(item.dataset.tag);
            }
        });

        // Close dropdown when clicking outside
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.prompt-wrapper')) {
                hideMentionDropdown();
            }
        });

        // Load saved config (API key only - endpoint is now a preset dropdown)
        apiKeyInput.value = Storage.get('apiKey', '');

        // Load system instructions
        const systemInstructionsInput = $('systemInstructions');
        systemInstructionsInput.value = Storage.get('systemInstructions', '');

        // Save API key on change (local + cloud if signed in)
        apiKeyInput.addEventListener('change', async () => {
            Storage.set('apiKey', apiKeyInput.value);
            if (currentUser) {
                await saveSettingsToCloud({ apiKey: apiKeyInput.value });
            }
        });

        // ========== FIREBASE AUTH ==========
        const authBar = $('authBar');
        const authModal = $('authModal');
        const loginBtn = $('loginBtn');
        const authClose = $('authClose');
        const googleSignIn = $('googleSignIn');
        const emailAuthForm = $('emailAuthForm');
        const authEmail = $('authEmail');
        const authPassword = $('authPassword');
        const authSubmit = $('authSubmit');
        const authError = $('authError');
        const authTitle = $('authTitle');
        const authSubtitle = $('authSubtitle');
        const authToggleText = $('authToggleText');
        const authToggleLink = $('authToggleLink');
        const syncIndicator = $('syncIndicator');
        const syncText = $('syncText');

        let isSignUpMode = false;

        function showAuthError(message) {
            authError.textContent = message;
            authError.classList.add('show');
        }

        function hideAuthError() {
            authError.classList.remove('show');
        }

        function openAuthModal() {
            authModal.classList.add('show');
            hideAuthError();
        }

        function closeAuthModal() {
            authModal.classList.remove('show');
            authEmail.value = '';
            authPassword.value = '';
            hideAuthError();
        }

        function toggleAuthMode() {
            isSignUpMode = !isSignUpMode;
            if (isSignUpMode) {
                authTitle.textContent = 'Create Account';
                authSubtitle.textContent = 'Sign up to save your gallery to the cloud';
                authSubmit.textContent = 'Sign Up';
                authToggleText.textContent = 'Already have an account?';
                authToggleLink.textContent = 'Sign In';
            } else {
                authTitle.textContent = 'Sign In';
                authSubtitle.textContent = 'Sign in to sync your gallery across devices';
                authSubmit.textContent = 'Sign In';
                authToggleText.textContent = "Don't have an account?";
                authToggleLink.textContent = 'Sign Up';
            }
            hideAuthError();
        }

        function updateAuthUI(user) {
            const notificationInboxHTML = `
                <div class="notification-inbox" id="notificationInbox">
                    <button class="notification-btn" id="notificationBtn" title="Notifications">
                        <span></span>
                        <span class="notification-badge hidden" id="notificationBadge">0</span>
                    </button>
                    <div class="notification-dropdown" id="notificationDropdown">
                        <div class="notification-header">
                            <h4>Notifications</h4>
                            <button class="notification-clear-btn" onclick="clearAllNotifications()">Clear all</button>
                        </div>
                        <div class="notification-list" id="notificationList">
                            <div class="notification-empty" id="notificationEmpty">
                                <div class="notification-empty-icon"></div>
                                <div>No notifications yet</div>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            if (user) {
                const displayName = user.displayName || user.email.split('@')[0];
                const photoURL = user.photoURL;
                authBar.innerHTML = `
                    <button class="tutorial-btn" id="tutorialBtn" title="Take a tour of KnappShot"><span class="tutorial-btn-icon"></span> Tour</button>
                    ${notificationInboxHTML}
                    <div class="user-info">
                        <div class="user-avatar">
                            ${photoURL ? `<img src="${photoURL}" alt="Avatar">` : displayName.charAt(0).toUpperCase()}
                        </div>
                        <span class="user-name">${displayName}</span>
                    </div>
                    <button class="auth-btn logout" id="logoutBtn">Sign Out</button>
                `;
                $('logoutBtn').addEventListener('click', () => {
                    auth.signOut();
                });
            } else {
                authBar.innerHTML = `
                    <button class="tutorial-btn" id="tutorialBtn" title="Take a tour of KnappShot"><span class="tutorial-btn-icon"></span> Tour</button>
                    ${notificationInboxHTML}
                    <button class="auth-btn" id="loginBtn">Sign In</button>
                `;
                $('loginBtn').addEventListener('click', openAuthModal);
            }

            // Re-attach tutorial button handler
            $('tutorialBtn')?.addEventListener('click', () => {
                if (typeof openTutorialStart === 'function') openTutorialStart();
            });

            // Re-initialize tutorial animation for first-time visitors
            if (typeof initTutorialAnimation === 'function') {
                initTutorialAnimation();
            }

            // Re-initialize notification UI
            initNotificationUI();
        }

        function showSyncIndicator(message, isSyncing = true) {
            syncIndicator.classList.add('show');
            syncIndicator.classList.toggle('syncing', isSyncing);
            syncIndicator.classList.toggle('synced', !isSyncing);
            syncText.textContent = message;
            syncIndicator.querySelector('.sync-spinner').style.display = isSyncing ? 'block' : 'none';
            if (!isSyncing) {
                setTimeout(() => syncIndicator.classList.remove('show'), 2000);
            }
        }

        function hideSyncIndicator() {
            syncIndicator.classList.remove('show');
        }

        // Auth event listeners
        loginBtn?.addEventListener('click', openAuthModal);
        authClose?.addEventListener('click', closeAuthModal);
        authToggleLink?.addEventListener('click', toggleAuthMode);
        authModal?.addEventListener('click', (e) => {
            if (e.target === authModal) closeAuthModal();
        });

        // Google Sign In
        googleSignIn?.addEventListener('click', async () => {
            try {
                const provider = new firebase.auth.GoogleAuthProvider();
                await auth.signInWithPopup(provider);
                closeAuthModal();
            } catch (error) {
                showAuthError(error.message);
            }
        });

        // Email Sign In/Up
        emailAuthForm?.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = authEmail.value.trim();
            const password = authPassword.value;

            if (!email || !password) {
                showAuthError('Please fill in all fields');
                return;
            }

            authSubmit.disabled = true;
            try {
                if (isSignUpMode) {
                    await auth.createUserWithEmailAndPassword(email, password);
                } else {
                    await auth.signInWithEmailAndPassword(email, password);
                }
                closeAuthModal();
            } catch (error) {
                let message = error.message;
                if (error.code === 'auth/email-already-in-use') message = 'Email already in use';
                if (error.code === 'auth/weak-password') message = 'Password should be at least 6 characters';
                if (error.code === 'auth/user-not-found') message = 'No account found with this email';
                if (error.code === 'auth/wrong-password') message = 'Incorrect password';
                showAuthError(message);
            } finally {
                authSubmit.disabled = false;
            }
        });

        // ========== FIREBASE CLOUD STORAGE FOR GALLERY ==========
        async function saveImageToCloud(imageData) {
            if (!currentUser) return null;

            try {
                const imageId = Date.now().toString();
                const imageRef = storage.ref(`users/${currentUser.uid}/gallery/${imageId}`);

                // Convert base64 to blob
                const response = await fetch(imageData.src);
                const blob = await response.blob();

                // Upload to Storage
                await imageRef.put(blob);
                const downloadURL = await imageRef.getDownloadURL();

                // Save metadata to Firestore
                await db.collection('users').doc(currentUser.uid).collection('gallery').doc(imageId).set({
                    id: imageId,
                    url: downloadURL,
                    prompt: imageData.prompt || '',
                    date: imageData.date || new Date().toISOString(),
                    favorite: imageData.favorite || false,
                    collectionId: imageData.collectionId || null
                });

                return imageId;
            } catch (error) {
                console.error('Error saving to cloud:', error);
                return null;
            }
        }

        async function loadGalleryFromCloud() {
            if (!currentUser) return [];

            try {
                showSyncIndicator('Loading gallery...');
                const snapshot = await db.collection('users').doc(currentUser.uid).collection('gallery')
                    .orderBy('date', 'desc')
                    .get();

                const gallery = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const item = {
                        id: data.id,
                        src: data.url,
                        prompt: data.prompt,
                        date: data.date,
                        favorite: data.favorite
                    };
                    // Include collectionId if it exists
                    if (data.collectionId) {
                        item.collectionId = data.collectionId;
                    }
                    gallery.push(item);
                });

                showSyncIndicator('Gallery synced!', false);
                return gallery;
            } catch (error) {
                console.error('Error loading from cloud:', error);
                hideSyncIndicator();
                return [];
            }
        }

        async function deleteImageFromCloud(imageId) {
            if (!currentUser) return;

            try {
                // Delete from Storage
                const imageRef = storage.ref(`users/${currentUser.uid}/gallery/${imageId}`);
                await imageRef.delete().catch(() => {}); // Ignore if not found

                // Delete from Firestore
                await db.collection('users').doc(currentUser.uid).collection('gallery').doc(imageId).delete();
            } catch (error) {
                console.error('Error deleting from cloud:', error);
            }
        }

        async function updateImageInCloud(imageId, updates) {
            if (!currentUser) return;

            try {
                await db.collection('users').doc(currentUser.uid).collection('gallery').doc(imageId).update(updates);
            } catch (error) {
                console.error('Error updating in cloud:', error);
            }
        }

        // ========== CLOUD SETTINGS (API Key, etc.) ==========
        async function saveSettingsToCloud(settings) {
            if (!currentUser) return;
            try {
                await db.collection('users').doc(currentUser.uid).set(settings, { merge: true });
            } catch (error) {
                console.error('Error saving settings:', error);
            }
        }

        async function loadSettingsFromCloud() {
            if (!currentUser) return null;
            try {
                const doc = await db.collection('users').doc(currentUser.uid).get();
                if (doc.exists) {
                    return doc.data();
                }
                return null;
            } catch (error) {
                console.error('Error loading settings:', error);
                return null;
            }
        }

        // ========== CLOUD SYNC FOR PRODUCTS ==========

        // Helper function to get image data from either a URL or base64 data URL
        async function getImageDataFromSource(imageSource) {
            if (!imageSource) {
                console.log('getImageDataFromSource: No image source provided');
                return null;
            }

            console.log('getImageDataFromSource: Processing', imageSource.substring(0, 100) + '...');

            // Check if it's already a base64 data URL
            if (imageSource.startsWith('data:')) {
                const mimeMatch = imageSource.match(/^data:([^;]+);/);
                const mimeType = mimeMatch ? mimeMatch[1] : 'image/jpeg';
                const base64Data = imageSource.split(',')[1];
                console.log('getImageDataFromSource: Extracted base64, mime:', mimeType, 'length:', base64Data?.length);
                return { mimeType, base64Data };
            }

            // It's a URL - use canvas approach to avoid CORS issues
            console.log('getImageDataFromSource: URL detected, loading via canvas...');
            try {
                return new Promise((resolve) => {
                    const img = new Image();
                    img.crossOrigin = 'anonymous';

                    img.onload = () => {
                        try {
                            const canvas = document.createElement('canvas');
                            canvas.width = img.naturalWidth;
                            canvas.height = img.naturalHeight;
                            const ctx = canvas.getContext('2d');
                            ctx.drawImage(img, 0, 0);

                            // Get as JPEG for better compatibility
                            const dataUrl = canvas.toDataURL('image/jpeg', 0.9);
                            const base64Data = dataUrl.split(',')[1];
                            console.log('getImageDataFromSource: Canvas conversion successful, length:', base64Data?.length);
                            resolve({ mimeType: 'image/jpeg', base64Data });
                        } catch (canvasError) {
                            console.error('getImageDataFromSource: Canvas error (CORS?):', canvasError);
                            resolve(null);
                        }
                    };

                    img.onerror = (err) => {
                        console.error('getImageDataFromSource: Image load error:', err);
                        resolve(null);
                    };

                    // Add cache buster to avoid stale responses
                    img.src = imageSource + (imageSource.includes('?') ? '&' : '?') + 't=' + Date.now();
                });
            } catch (error) {
                console.error('getImageDataFromSource: Unexpected error:', error);
                return null;
            }
        }

        async function uploadProductImage(productId, base64Image) {
            // Upload reference image to Firebase Storage and return download URL
            try {
                const imageRef = storage.ref(`users/${currentUser.uid}/products/${productId}`);

                // Convert base64 to blob
                const response = await fetch(base64Image);
                const blob = await response.blob();

                // Upload to Storage
                await imageRef.put(blob);
                const downloadURL = await imageRef.getDownloadURL();
                return downloadURL;
            } catch (error) {
                console.error('Error uploading product image:', error);
                return null;
            }
        }

        async function saveProductsToCloud() {
            if (!currentUser) return;
            try {
                const productsRef = db.collection('users').doc(currentUser.uid).collection('products');

                // Get existing products to find ones to delete
                const existingDocs = await productsRef.get();
                const existingIds = new Set();
                existingDocs.forEach(doc => existingIds.add(doc.id));

                // Save each product
                for (const product of state.products) {
                    const productId = product.id.toString();
                    const productToSave = { ...product };

                    // If referenceImage is a base64 data URL (large), upload to Storage first
                    if (productToSave.referenceImage && productToSave.referenceImage.startsWith('data:')) {
                        console.log('Uploading product reference image to Storage...');
                        const imageUrl = await uploadProductImage(productId, productToSave.referenceImage);
                        if (imageUrl) {
                            productToSave.referenceImage = imageUrl;
                            // Update local state with the URL too
                            product.referenceImage = imageUrl;
                        } else {
                            // If upload failed, remove image to prevent Firestore error
                            delete productToSave.referenceImage;
                        }
                    }

                    await productsRef.doc(productId).set(productToSave);
                    existingIds.delete(productId);
                }

                // Delete removed products
                for (const idToDelete of existingIds) {
                    await productsRef.doc(idToDelete).delete();
                }
            } catch (error) {
                console.error('Error saving products to cloud:', error);
                throw error; // Re-throw so the caller knows it failed
            }
        }

        async function loadProductsFromCloud() {
            if (!currentUser) return [];
            try {
                const productsRef = db.collection('users').doc(currentUser.uid).collection('products');
                const snapshot = await productsRef.get();
                const products = [];
                snapshot.forEach(doc => {
                    products.push(doc.data());
                });
                return products.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
            } catch (error) {
                console.error('Error loading products from cloud:', error);
                return [];
            }
        }

        // ========== CLOUD SYNC FOR ALL DATA ==========
        async function saveAllDataToCloud() {
            if (!currentUser) return;
            try {
                // Save settings (API key, system instructions, active product, etc.)
                await saveSettingsToCloud({
                    apiKey: apiKeyInput.value,
                    systemInstructions: $('systemInstructions').value,
                    activeProductId: state.activeProductId,
                    prompts: state.prompts,
                    reviewItems: state.reviewItems,
                    collections: state.collections
                });

                // Save products separately (can be large with images)
                await saveProductsToCloud();
            } catch (error) {
                console.error('Error saving all data to cloud:', error);
            }
        }

        async function loadAllDataFromCloud() {
            if (!currentUser) return;
            try {
                // Load settings
                const settings = await loadSettingsFromCloud();
                if (settings) {
                    if (settings.apiKey) {
                        apiKeyInput.value = settings.apiKey;
                        // Only save API key to localStorage (useful for form restoration)
                        Storage.set('apiKey', settings.apiKey);
                    }
                    if (settings.systemInstructions) {
                        $('systemInstructions').value = settings.systemInstructions;
                        // Only save system instructions to localStorage (useful for form restoration)
                        Storage.set('systemInstructions', settings.systemInstructions);
                    }
                    if (settings.activeProductId) {
                        state.activeProductId = settings.activeProductId;
                        // Don't save to localStorage - cloud is source of truth when signed in
                    }
                    if (settings.prompts) {
                        state.prompts = settings.prompts;
                        // Don't save to localStorage - cloud is source of truth when signed in
                    }
                    if (settings.reviewItems) {
                        state.reviewItems = settings.reviewItems;
                        // Don't save to localStorage - cloud is source of truth when signed in
                        updateReviewUI();
                    }
                    if (settings.collections) {
                        state.collections = settings.collections;
                        // Don't save to localStorage - cloud is source of truth when signed in
                        renderCollections();
                    }
                }

                // Load products - always use cloud as source of truth when signed in
                const products = await loadProductsFromCloud();
                state.products = products;
                // Don't save to localStorage - cloud is source of truth when signed in
                renderProducts();
                updateProductSelect();

                updateWelcomeBanner();
            } catch (error) {
                console.error('Error loading all data from cloud:', error);
            }
        }

        // Debounced cloud sync for settings changes
        let cloudSyncTimeout = null;
        function scheduleCloudSync() {
            if (!currentUser) return;
            if (cloudSyncTimeout) clearTimeout(cloudSyncTimeout);
            cloudSyncTimeout = setTimeout(() => {
                saveAllDataToCloud();
            }, 2000); // Debounce 2 seconds
        }

        async function migrateLocalGalleryToCloud() {
            const localGallery = Storage.get('gallery', []);
            if (localGallery.length === 0 || !currentUser) return;

            const shouldMigrate = confirm(`You have ${localGallery.length} images saved locally. Would you like to upload them to your cloud account?`);
            if (!shouldMigrate) return;

            showSyncIndicator(`Uploading ${localGallery.length} images...`);

            for (let i = 0; i < localGallery.length; i++) {
                showSyncIndicator(`Uploading image ${i + 1} of ${localGallery.length}...`);
                await saveImageToCloud(localGallery[i]);
            }

            // Clear local storage after migration
            Storage.set('gallery', []);
            showSyncIndicator('Migration complete!', false);

            // Reload gallery from cloud
            state.gallery = await loadGalleryFromCloud();
            renderGallery();
        }

        // Auth state listener
        auth.onAuthStateChanged(async (user) => {
            currentUser = user;
            updateAuthUI(user);

            if (user) {
                // IMPORTANT: Capture truly local data BEFORE loading cloud data
                // This prevents us from re-migrating data we just downloaded
                const preLoginLocalGallery = Storage.get('gallery', []);
                const preLoginLocalProducts = Storage.get('products', []);
                const preLoginLocalPrompts = Storage.get('prompts', []);

                showSyncIndicator('Syncing data...');

                // Load all data from cloud (settings, products, prompts, etc.)
                await loadAllDataFromCloud();

                // Load gallery from cloud
                state.gallery = await loadGalleryFromCloud();
                renderGallery();
                // Re-render collections now that gallery is loaded (to update counts)
                renderCollections();

                showSyncIndicator('Synced!', false);

                // Check if there was truly local data BEFORE we logged in
                // Only migrate if we captured local data before cloud sync
                if (preLoginLocalGallery.length > 0 || preLoginLocalProducts.length > 0) {
                    setTimeout(() => migrateLocalDataToCloud(preLoginLocalGallery, preLoginLocalProducts, preLoginLocalPrompts), 1000);
                }
            } else {
                // Load from local storage when signed out
                state.gallery = Storage.get('gallery', []);
                state.products = Storage.get('products', []);
                state.prompts = Storage.get('prompts', []);
                state.reviewItems = Storage.get('reviewItems', []);
                state.collections = Storage.get('collections', []);
                renderGallery();
                renderCollections();
                renderProducts();
                renderPrompts();
                updateReviewUI();
            }
        });

        // Migrate all local data to cloud
        // Parameters are pre-captured local data from BEFORE cloud sync
        async function migrateLocalDataToCloud(localGallery = [], localProducts = [], localPrompts = []) {
            if (!currentUser) return;

            // Filter out items that already exist in cloud (by comparing IDs/URLs)
            // For gallery, check if the image src already exists in cloud gallery
            const cloudGallerySrcs = new Set(state.gallery.map(item => item.src));
            const trulyLocalGallery = localGallery.filter(item => !cloudGallerySrcs.has(item.src));

            // For products, check by ID
            const cloudProductIds = new Set(state.products.map(p => p.id.toString()));
            const trulyLocalProducts = localProducts.filter(p => !cloudProductIds.has(p.id.toString()));

            // For prompts, check by text
            const cloudPromptTexts = new Set(state.prompts.map(p => p.text));
            const trulyLocalPrompts = localPrompts.filter(p => !cloudPromptTexts.has(p.text));

            let hasDataToMigrate = trulyLocalGallery.length > 0 || trulyLocalProducts.length > 0;
            if (!hasDataToMigrate) {
                // No truly new local data to migrate, clear localStorage
                Storage.set('gallery', []);
                Storage.set('products', []);
                Storage.set('prompts', []);
                return;
            }

            let message = 'You have local data that can be uploaded to your cloud account:\n';
            if (trulyLocalGallery.length > 0) message += `\n- ${trulyLocalGallery.length} gallery images`;
            if (trulyLocalProducts.length > 0) message += `\n- ${trulyLocalProducts.length} products`;
            message += '\n\nWould you like to upload them?';

            const shouldMigrate = confirm(message);
            if (!shouldMigrate) {
                // User declined, still clear localStorage to prevent re-prompting
                Storage.set('gallery', []);
                Storage.set('products', []);
                Storage.set('prompts', []);
                return;
            }

            showSyncIndicator('Uploading local data...');

            // Migrate gallery (preserving collectionId)
            if (trulyLocalGallery.length > 0) {
                for (let i = 0; i < trulyLocalGallery.length; i++) {
                    showSyncIndicator(`Uploading image ${i + 1} of ${trulyLocalGallery.length}...`);
                    await saveImageToCloud(trulyLocalGallery[i]);
                }
            }
            Storage.set('gallery', []);

            // Migrate products
            if (trulyLocalProducts.length > 0) {
                for (const product of trulyLocalProducts) {
                    state.products.push(product);
                }
                await saveProductsToCloud();
            }
            Storage.set('products', []);

            // Migrate prompts (merge with existing)
            if (trulyLocalPrompts.length > 0) {
                for (const prompt of trulyLocalPrompts) {
                    state.prompts.push(prompt);
                }
                await saveSettingsToCloud({ prompts: state.prompts });
            }
            Storage.set('prompts', []);

            showSyncIndicator('Migration complete!', false);

            // Reload all data
            state.gallery = await loadGalleryFromCloud();
            renderGallery();
            renderProducts();
            renderPrompts();
        }

        // ========== TABS ==========
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                tab.classList.add('active');
                $('tab-' + tab.dataset.tab).classList.add('active');
                if (tab.dataset.tab === 'gallery') renderGallery();
                if (tab.dataset.tab === 'review') updateReviewUI();
                if (tab.dataset.tab === 'prompts') renderPrompts();
                if (tab.dataset.tab === 'products') renderProducts();
                if (tab.dataset.tab === 'promptgen') {
                    updateProductSelect();
                    renderProducts();
                }
            });
        });

        // ========== OPTION BUTTONS ==========
        function setupOptionButtons(containerId, stateKey, parser = v => v) {
            $(containerId).addEventListener('click', e => {
                if (e.target.classList.contains('option-btn')) {
                    $(containerId).querySelectorAll('.option-btn').forEach(b => b.classList.remove('active'));
                    e.target.classList.add('active');
                    state[stateKey] = parser(e.target.dataset.value);
                    if (stateKey === 'mode') toggleBatchMode();
                }
            });
        }
        setupOptionButtons('aspectRatioButtons', 'selectedAspectRatio');
        setupOptionButtons('resolutionButtons', 'selectedResolution');
        setupOptionButtons('generationCountButtons', 'selectedGenerationCount', v => parseInt(v));
        setupOptionButtons('modeButtons', 'mode');

        function toggleBatchMode() {
            const isBatch = state.mode === 'batch';
            batchGrid.style.display = isBatch ? 'grid' : 'none';
            renderBatchGrid();

            // Show/hide queue panel based on mode
            if (isBatch) {
                showQueuePanel();
            } else {
                hideQueuePanel();
            }
        }

        // ========== FILE UPLOAD ==========
        let currentUploadTarget = null; // 'main' or 'ref'

        uploadArea.addEventListener('click', (e) => {
            // Don't show options if clicking on clear button or if image is already displayed
            if (e.target.closest('.clear-btn') || e.target.closest('.upload-option-btn')) return;
            if (state.currentImage) return; // If image exists, don't show options

            const popup = $('mainUploadOptions');
            popup.classList.toggle('show');
            // Hide ref popup if open
            $('refUploadOptions')?.classList.remove('show');
        });
        uploadArea.addEventListener('dragover', e => { e.preventDefault(); uploadArea.classList.add('drag-over'); });
        uploadArea.addEventListener('dragleave', () => uploadArea.classList.remove('drag-over'));
        uploadArea.addEventListener('drop', e => {
            e.preventDefault();
            uploadArea.classList.remove('drag-over');
            $('mainUploadOptions')?.classList.remove('show');
            handleFiles(e.dataTransfer.files);
        });
        fileInput.addEventListener('change', e => {
            handleFiles(e.target.files);
            $('mainUploadOptions')?.classList.remove('show');
        });

        // Hide popups when clicking outside
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.upload-area') && !e.target.closest('.ref-upload-area')) {
                $('mainUploadOptions')?.classList.remove('show');
                $('refUploadOptions')?.classList.remove('show');
            }
        });

        // Preview image click handler (event delegation)
        document.addEventListener('click', (e) => {
            const previewImg = e.target.closest('.preview-image');
            if (previewImg) {
                e.stopPropagation();
                const src = previewImg.src;
                if (src) {
                    openLightbox([{ src }], 0, 'preview');
                }
            }
        });

        // Trigger file upload from popup
        function triggerFileUpload(target) {
            if (target === 'main') {
                $('fileInput')?.click();
            } else if (target === 'ref') {
                $('refFileInput')?.click();
            }
            $('mainUploadOptions')?.classList.remove('show');
            $('refUploadOptions')?.classList.remove('show');
        }

        // Paste from clipboard for reference image
        async function pasteToRef() {
            $('refUploadOptions')?.classList.remove('show');
            try {
                const clipboardItems = await navigator.clipboard.read();
                for (const item of clipboardItems) {
                    const imageType = item.types.find(type => type.startsWith('image/'));
                    if (imageType) {
                        const blob = await item.getType(imageType);
                        const file = new File([blob], 'pasted-image.png', { type: imageType });
                        const result = await processImageFile(file);
                        if (result) {
                            state.referenceImage = result.dataUrl;
                            state.referenceImageBase64 = result.base64;
                            refUploadArea.innerHTML = `
                                <img src="${state.referenceImage}" alt="Reference" class="preview-image" style="cursor: zoom-in;" title="Click to preview">
                                <button class="clear-btn" onclick="clearRef(event)">Clear</button>
                                <div class="upload-options-popup" id="refUploadOptions">
                                    <button class="upload-option-btn" onclick="triggerFileUpload('ref')">
                                        <span></span> Upload from Computer
                                    </button>
                                    <button class="upload-option-btn" onclick="openGalleryPicker('ref')">
                                        <span></span> Select from Gallery
                                    </button>
                                    <button class="upload-option-btn" onclick="pasteToRef()">
                                        <span></span> Paste from Clipboard
                                    </button>
                                </div>
                            `;
                            showStatus('Reference image pasted!', 'success');
                            return;
                        }
                    }
                }
                showStatus('No image found in clipboard', 'error');
            } catch (err) {
                showStatus('Unable to read clipboard. Try Ctrl+V after clicking the upload area.', 'error');
            }
        }

        // Global paste handler for images
        document.addEventListener('paste', async (e) => {
            // Don't intercept if user is typing in an input/textarea
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;

            const items = e.clipboardData?.items;
            if (!items) return;

            let imageFile = null;
            for (const item of items) {
                if (item.type.startsWith('image/')) {
                    imageFile = item.getAsFile();
                    break;
                }
            }
            if (!imageFile) return;

            e.preventDefault();

            // Determine where to paste based on current context
            const activeTab = document.querySelector('.tab.active')?.dataset.tab;
            const productModal = $('productModal');
            const isProductModalOpen = productModal?.classList.contains('active');

            // If product modal is open, paste to product image
            if (isProductModalOpen) {
                const result = await processImageFile(imageFile);
                if (result) {
                    const uploadArea = $('productImageUpload');
                    uploadArea.innerHTML = `<img src="${result.dataUrl}" alt="Reference" class="preview-image" style="cursor: zoom-in;" title="Click to preview">`;
                    uploadArea.dataset.imageData = result.dataUrl;
                    showStatus('Image pasted to product!', 'success');
                }
                return;
            }

            // Based on active tab
            if (activeTab === 'breakdown') {
                // Paste to breakdown upload
                const result = await processImageFile(imageFile);
                if (result) {
                    breakdownImageData = {
                        mimeType: result.mimeType,
                        base64Data: result.base64
                    };
                    $('breakdownPreviewImg').src = result.dataUrl;
                    $('breakdownUploadArea').style.display = 'none';
                    $('breakdownImagePreview').style.display = 'block';
                    $('analyzeImageBtn').disabled = false;
                    $('breakdownOutput')?.classList.remove('show');
                    $('breakdownRewrite')?.classList.remove('show');
                    showStatus('Image pasted!', 'success');
                }
            } else if (activeTab === 'editor') {
                // Paste to main upload (or handle batch mode)
                handleFiles([imageFile]);
                showStatus('Image pasted!', 'success');
            }
        });

        // Gallery picker functions
        let galleryPickerFilter = null; // Currently selected collection filter
        let galleryPickerItems = []; // Filtered items for selection

        function openGalleryPicker(target) {
            currentUploadTarget = target;
            galleryPickerFilter = null; // Reset filter
            const modal = $('galleryPickerModal');
            const title = $('galleryPickerTitle');

            title.textContent = target === 'ref' ? 'Select Style Reference from Gallery' : 'Select Image from Gallery';

            // Hide upload options popups
            $('mainUploadOptions')?.classList.remove('show');
            $('refUploadOptions')?.classList.remove('show');

            // Render collection filters
            renderGalleryPickerFilters();
            // Render gallery items
            renderGalleryPickerItems();

            modal.classList.add('active');
        }

        function renderGalleryPickerFilters() {
            const filters = $('galleryPickerFilters');
            if (!filters) return;

            // Build filter buttons: All + each collection
            let html = `<button class="gallery-picker-filter-btn ${galleryPickerFilter === null ? 'active' : ''}" onclick="filterGalleryPicker(null)">All</button>`;

            if (state.collections && state.collections.length > 0) {
                html += state.collections.map(col => `
                    <button class="gallery-picker-filter-btn ${galleryPickerFilter === col.id ? 'active' : ''}" onclick="filterGalleryPicker('${col.id}')">
                        ${escapeHtml(col.name)}
                    </button>
                `).join('');
            }

            filters.innerHTML = html;
        }

        function filterGalleryPicker(collectionId) {
            galleryPickerFilter = collectionId;
            renderGalleryPickerFilters();
            renderGalleryPickerItems();
        }

        function renderGalleryPickerItems() {
            const grid = $('galleryPickerGrid');
            const empty = $('galleryPickerEmpty');

            // Filter items by collection if selected
            galleryPickerItems = galleryPickerFilter
                ? state.gallery.filter(item => item.collectionId === galleryPickerFilter)
                : [...state.gallery];

            if (galleryPickerItems.length === 0) {
                grid.innerHTML = '';
                empty.classList.add('show');
            } else {
                empty.classList.remove('show');
                grid.innerHTML = galleryPickerItems.map((item, i) => `
                    <div class="gallery-picker-item" onclick="selectFromGalleryPicker(${i})">
                        <img src="${item.src}" alt="Gallery image">
                    </div>
                `).join('');
            }
        }

        function closeGalleryPicker() {
            $('galleryPickerModal').classList.remove('active');
            currentUploadTarget = null;
            galleryPickerFilter = null;
        }

        async function selectFromGalleryPicker(index) {
            const item = galleryPickerItems[index];
            if (!item) return;

            if (currentUploadTarget === 'main') {
                state.currentImage = item.src;
                state.originalImage = item.src;
                // Extract base64 data
                if (item.src.startsWith('data:')) {
                    const mimeMatch = item.src.match(/^data:([^;]+);/);
                    state.currentImageMimeType = mimeMatch ? mimeMatch[1] : 'image/jpeg';
                    state.currentImageBase64 = item.src.split(',')[1];
                    console.log('Gallery selection: Data URL, base64 length:', state.currentImageBase64?.length);
                } else {
                    // Firebase URL - need to convert to base64
                    console.log('Gallery selection: Firebase URL detected, converting to base64...');
                    showStatus('Loading image...', 'info');
                    const imageData = await getImageDataFromSource(item.src);
                    if (imageData) {
                        state.currentImageMimeType = imageData.mimeType;
                        state.currentImageBase64 = imageData.base64Data;
                        console.log('Gallery selection: Converted to base64, length:', state.currentImageBase64?.length);
                        showStatus('Image loaded!', 'success');
                    } else {
                        console.error('Gallery selection: Failed to convert Firebase URL to base64');
                        state.currentImageMimeType = 'image/jpeg';
                        state.currentImageBase64 = null;
                        showStatus('Warning: Could not process image for editing', 'error');
                    }
                }
                displayUploadedImage(item.src);
            } else if (currentUploadTarget === 'ref') {
                state.referenceImage = item.src;
                if (item.src.startsWith('data:')) {
                    state.referenceImageBase64 = item.src.split(',')[1];
                } else {
                    // Firebase URL - convert to base64
                    const imageData = await getImageDataFromSource(item.src);
                    if (imageData) {
                        state.referenceImageBase64 = imageData.base64Data;
                    }
                }
                refUploadArea.innerHTML = `
                    <img src="${state.referenceImage}" alt="Reference" class="preview-image" style="cursor: zoom-in;" title="Click to preview">
                    <button class="clear-btn" onclick="clearRef(event)">Clear</button>
                    <div class="upload-options-popup" id="refUploadOptions">
                        <button class="upload-option-btn" onclick="triggerFileUpload('ref')">
                            <span></span> Upload from Computer
                        </button>
                        <button class="upload-option-btn" onclick="openGalleryPicker('ref')">
                            <span></span> Select from Gallery
                        </button>
                        <button class="upload-option-btn" onclick="pasteToRef()">
                            <span></span> Paste from Clipboard
                        </button>
                    </div>
                `;
            }

            closeGalleryPicker();
        }

        // Check if file is HEIC/HEIF format
        function isHeicFile(file) {
            const type = (file.type || '').toLowerCase();
            const name = (file.name || '').toLowerCase();
            return type === 'image/heic' || type === 'image/heif' ||
                   type === '' && (name.endsWith('.heic') || name.endsWith('.heif')) ||
                   name.endsWith('.heic') || name.endsWith('.heif');
        }

        // Try to convert HEIC using native browser canvas (works in Safari)
        async function tryNativeHeicConversion(file) {
            return new Promise((resolve) => {
                const url = URL.createObjectURL(file);
                const img = new Image();

                img.onload = () => {
                    try {
                        const canvas = document.createElement('canvas');
                        canvas.width = img.naturalWidth;
                        canvas.height = img.naturalHeight;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0);

                        canvas.toBlob((blob) => {
                            URL.revokeObjectURL(url);
                            if (blob && blob.size > 0) {
                                const convertedFile = new File([blob], file.name.replace(/\.(heic|heif)$/i, '.jpg'), { type: 'image/jpeg' });
                                resolve(convertedFile);
                            } else {
                                resolve(null);
                            }
                        }, 'image/jpeg', 0.92);
                    } catch (e) {
                        URL.revokeObjectURL(url);
                        resolve(null);
                    }
                };

                img.onerror = () => {
                    URL.revokeObjectURL(url);
                    resolve(null);
                };

                img.src = url;
            });
        }

        // Convert HEIC to JPEG
        async function convertHeicToJpeg(file) {
            showStatus('Converting HEIC image... (this may take a moment)', 'info');
            console.log('Starting HEIC conversion for:', file.name, 'type:', file.type, 'size:', file.size);

            // First, try native browser support (Safari on Mac supports HEIC natively)
            console.log('Trying native browser HEIC support...');
            const nativeResult = await tryNativeHeicConversion(file);
            if (nativeResult) {
                console.log('Native conversion succeeded!');
                showStatus('HEIC converted successfully!', 'success');
                return nativeResult;
            }
            console.log('Native conversion failed, trying heic2any library...');

            // Fall back to heic2any library
            if (typeof heic2any === 'undefined') {
                console.error('heic2any library not loaded');
                showStatus('HEIC conversion not available. Try using Safari or convert the image to JPG first.', 'error');
                return null;
            }

            try {
                const blob = await heic2any({
                    blob: file,
                    toType: 'image/jpeg',
                    quality: 0.92,
                    multiple: true
                });

                console.log('HEIC conversion result:', blob);

                // heic2any can return array or single blob
                const resultBlob = Array.isArray(blob) ? blob[0] : blob;

                if (!resultBlob || resultBlob.size === 0) {
                    throw new Error('Conversion produced empty result');
                }

                const convertedFile = new File([resultBlob], file.name.replace(/\.(heic|heif)$/i, '.jpg'), { type: 'image/jpeg' });
                console.log('Converted file:', convertedFile.name, 'type:', convertedFile.type, 'size:', convertedFile.size);

                showStatus('HEIC converted successfully!', 'success');
                return convertedFile;
            } catch (error) {
                console.error('HEIC conversion error:', error);
                showStatus('Could not convert HEIC. Please convert to JPG/PNG first, or use Safari browser.', 'error');
                return null;
            }
        }

        // Process any image file - converts HEIC if needed, returns data URL
        async function processImageFile(file) {
            if (!file) return null;

            let processFile = file;

            // Convert HEIC if needed
            if (isHeicFile(file)) {
                processFile = await convertHeicToJpeg(file);
                if (!processFile) return null;
            }

            // Read as data URL
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    resolve({
                        dataUrl: e.target.result,
                        base64: e.target.result.split(',')[1],
                        mimeType: processFile.type || 'image/jpeg'
                    });
                };
                reader.onerror = () => resolve(null);
                reader.readAsDataURL(processFile);
            });
        }

        // Handle clipboard paste for image uploads
        async function handlePasteEvent(e, callback) {
            const items = e.clipboardData?.items;
            if (!items) return false;

            for (const item of items) {
                if (item.type.startsWith('image/')) {
                    e.preventDefault();
                    const file = item.getAsFile();
                    if (file) {
                        callback(file);
                        return true;
                    }
                }
            }
            return false;
        }

        async function handleFiles(files) {
            if (state.mode === 'batch') {
                for (const file of Array.from(files)) {
                    if ((file.type.startsWith('image/') || isHeicFile(file)) && state.batchImages.length < 10) {
                        let processFile = file;

                        // Convert HEIC if needed
                        if (isHeicFile(file)) {
                            processFile = await convertHeicToJpeg(file);
                            if (!processFile) continue;
                        }

                        const reader = new FileReader();
                        reader.onload = e => {
                            state.batchImages.push({ src: e.target.result, base64: e.target.result.split(',')[1], mimeType: processFile.type });
                            renderBatchGrid();
                        };
                        reader.readAsDataURL(processFile);
                    }
                }
            } else {
                let file = files[0];
                if (file && (file.type.startsWith('image/') || isHeicFile(file))) {
                    // Convert HEIC if needed
                    if (isHeicFile(file)) {
                        file = await convertHeicToJpeg(file);
                        if (!file) return;
                    }

                    state.currentImageMimeType = file.type;
                    const reader = new FileReader();
                    reader.onload = e => {
                        state.currentImage = e.target.result;
                        state.currentImageBase64 = e.target.result.split(',')[1];
                        state.originalImage = e.target.result;
                        displayUploadedImage(state.currentImage);
                        showStatus('Image loaded!', 'success');
                    };
                    reader.readAsDataURL(file);
                }
            }
        }

        function displayUploadedImage(src) {
            uploadArea.innerHTML = `
                <img src="${src}" alt="Uploaded" class="preview-image" data-preview="main" style="cursor: zoom-in;" title="Click to preview">
                <button class="clear-btn" onclick="clearImage(event)">Clear</button>
                <div class="upload-options-popup" id="mainUploadOptions">
                    <button class="upload-option-btn" onclick="triggerFileUpload('main')">
                        <span></span> Upload from Computer
                    </button>
                    <button class="upload-option-btn" onclick="openGalleryPicker('main')">
                        <span></span> Select from Gallery
                    </button>
                </div>
            `;
        }

        function clearImage(e) {
            e?.stopPropagation();
            state.currentImage = null;
            state.currentImageBase64 = null;
            state.originalImage = null;
            uploadArea.innerHTML = `
                <div class="upload-icon"></div>
                <div class="upload-text"><strong>Drop, paste, or click</strong><br>to upload an image</div>
                <input type="file" id="fileInput" class="hidden-input" accept="image/*,.heic,.heif" multiple>
                <div class="upload-options-popup" id="mainUploadOptions">
                    <button class="upload-option-btn" onclick="triggerFileUpload('main')">
                        <span></span> Upload from Computer
                    </button>
                    <button class="upload-option-btn" onclick="openGalleryPicker('main')">
                        <span></span> Select from Gallery
                    </button>
                </div>
            `;
            // Re-attach event listener to new file input
            const newFileInput = $('fileInput');
            newFileInput.addEventListener('change', e => {
                handleFiles(e.target.files);
                $('mainUploadOptions')?.classList.remove('show');
            });
        }

        function resetResultArea() {
            resultArea.innerHTML = `
                <div class="result-placeholder">
                    <span></span>
                    Your creation will appear here
                </div>
            `;
        }

        function renderBatchGrid() {
            let html = '';
            state.batchImages.forEach((img, i) => {
                html += `<div class="batch-item"><img src="${img.src}"><button class="remove-batch" onclick="removeBatchImage(${i})"></button></div>`;
            });
            html += '<div class="batch-add" onclick="fileInput.click()">+</div>';
            batchGrid.innerHTML = html;
        }

        function removeBatchImage(index) {
            state.batchImages.splice(index, 1);
            renderBatchGrid();
        }

        // Reference Image
        refUploadArea.addEventListener('click', (e) => {
            // Don't show options if clicking on clear button or option buttons
            if (e.target.closest('.clear-btn') || e.target.closest('.upload-option-btn')) return;
            if (state.referenceImage) return; // If image exists, don't show options

            const popup = $('refUploadOptions');
            popup?.classList.toggle('show');
            // Hide main popup if open
            $('mainUploadOptions')?.classList.remove('show');
        });
        refFileInput.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (file) {
                const result = await processImageFile(file);
                if (result) {
                    state.referenceImage = result.dataUrl;
                    state.referenceImageBase64 = result.base64;
                    refUploadArea.innerHTML = `
                        <img src="${state.referenceImage}" alt="Reference" class="preview-image" style="cursor: zoom-in;" title="Click to preview">
                        <button class="clear-btn" onclick="clearRef(event)">Clear</button>
                        <div class="upload-options-popup" id="refUploadOptions">
                            <button class="upload-option-btn" onclick="triggerFileUpload('ref')">
                                <span></span> Upload from Computer
                            </button>
                            <button class="upload-option-btn" onclick="openGalleryPicker('ref')">
                                <span></span> Select from Gallery
                            </button>
                            <button class="upload-option-btn" onclick="pasteToRef()">
                                <span></span> Paste from Clipboard
                            </button>
                        </div>
                    `;
                    showStatus('Reference image loaded!', 'success');
                }
            }
        });

        function clearRef(e) {
            e.stopPropagation();
            state.referenceImage = null;
            state.referenceImageBase64 = null;
            refUploadArea.innerHTML = `
                <div class="ref-label">+ Add Style Reference (optional)</div>
                <input type="file" id="refFileInput" class="hidden-input" accept="image/*,.heic,.heif">
                <div class="upload-options-popup" id="refUploadOptions">
                    <button class="upload-option-btn" onclick="triggerFileUpload('ref')">
                        <span></span> Upload from Computer
                    </button>
                    <button class="upload-option-btn" onclick="openGalleryPicker('ref')">
                        <span></span> Select from Gallery
                    </button>
                    <button class="upload-option-btn" onclick="pasteToRef()">
                        <span></span> Paste from Clipboard
                    </button>
                </div>
            `;
            // Re-attach event listener to new file input
            const newRefInput = $('refFileInput');
            newRefInput.addEventListener('change', async (e) => {
                const file = e.target.files[0];
                if (file) {
                    const result = await processImageFile(file);
                    if (result) {
                        state.referenceImage = result.dataUrl;
                        state.referenceImageBase64 = result.base64;
                        refUploadArea.innerHTML = `
                            <img src="${state.referenceImage}" alt="Reference" class="preview-image" style="cursor: zoom-in;" title="Click to preview">
                            <button class="clear-btn" onclick="clearRef(event)">Clear</button>
                            <div class="upload-options-popup" id="refUploadOptions">
                                <button class="upload-option-btn" onclick="triggerFileUpload('ref')">
                                    <span></span> Upload from Computer
                                </button>
                                <button class="upload-option-btn" onclick="openGalleryPicker('ref')">
                                    <span></span> Select from Gallery
                                </button>
                                <button class="upload-option-btn" onclick="pasteToRef()">
                                    <span></span> Paste from Clipboard
                                </button>
                            </div>
                        `;
                        showStatus('Reference image loaded!', 'success');
                    }
                }
            });
        }

        // ========== STYLE PRESETS ==========
        const stylePresets = {
            cinematic: 'Apply cinematic color grading with dramatic lighting, film grain, and a wide dynamic range look',
            vintage: 'Apply vintage film photography style with faded colors, light leaks, and grain',
            neon: 'Add vibrant neon lighting effects with glowing edges and cyberpunk atmosphere',
            watercolor: 'Transform into a watercolor painting with soft brushstrokes and blended colors',
            anime: 'Convert to anime/manga art style with cel shading and characteristic features',
            minimalist: 'Create a clean minimalist aesthetic with simplified forms and muted palette',
            dramatic: 'Apply dramatic contrast with moody shadows and intense highlights',
            dreamy: 'Add a dreamy ethereal effect with soft focus, bloom, and pastel tones'
        };

        document.querySelectorAll('.preset-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const style = btn.dataset.style;
                const currentPrompt = promptInput.value.trim();
                promptInput.value = currentPrompt ? `${currentPrompt}. ${stylePresets[style]}` : stylePresets[style];
            });
        });

        // ========== QUICK ACTIONS ==========
        const quickActions = {
            'remove-bg': 'Remove the background completely, leaving only the main subject with a transparent background',
            'enhance': 'Enhance image quality: improve sharpness, clarity, color vibrancy, and overall visual appeal',
            'upscale': 'Upscale the image to 2x resolution while preserving details and adding realistic texture',
            'restore': 'Restore this old/damaged photo: fix scratches, tears, fading, and improve overall quality',
            'colorize': 'Colorize this black and white photo with realistic, natural colors'
        };

        document.querySelectorAll('.quick-action-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                promptInput.value = quickActions[btn.dataset.action];
            });
        });

        // ========== PROMPT ENHANCER ==========
        const GEMINI_FLASH = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-3-flash-preview:generateContent';

        enhanceBtn.addEventListener('click', async () => {
            const prompt = promptInput.value.trim();
            const apiKey = apiKeyInput.value.trim();

            // Get product from editor dropdown directly, not global state
            const editorProductSelect = $('editorProductSelect');
            const selectedProductId = editorProductSelect?.value ? parseInt(editorProductSelect.value) : null;
            const product = selectedProductId ? state.products.find(p => p.id === selectedProductId) : null;

            if (!prompt) { alert('Enter a prompt first'); return; }
            if (!apiKey) { alert('Enter API key first'); return; }

            enhanceBtn.disabled = true;
            enhanceBtn.textContent = '...';

            try {
                // Get selected model from editor dropdown
                const editorModelSelect = $('editorModelSelect');
                const selectedModel = editorModelSelect?.value || 'flash';
                const modelConfig = promptGenModels[selectedModel] || promptGenModels['flash'];

                // Build request parts - include image if uploaded for better context
                const parts = [];

                // Build product context instructions if a product is selected in the editor dropdown
                let productInstructions = '';
                if (product) {
                    productInstructions = `\n\nPRODUCT PROFILE REQUIREMENTS:
- Product Name: ${product.name}
- Description: ${product.description || 'Not specified'}`;
                    if ((product.goldenPhrases || []).length) {
                        productInstructions += `\n- MANDATORY: You MUST naturally incorporate these key phrases: "${product.goldenPhrases.join('", "')}"`;
                    }
                    if ((product.forbiddenWords || []).length) {
                        productInstructions += `\n- FORBIDDEN: NEVER use these terms: ${product.forbiddenWords.join(', ')}`;
                    }
                    productInstructions += `\n\nThe enhanced prompt must follow these product requirements exactly.`;
                }

                console.log('Enhance: currentImageBase64 exists?', !!state.currentImageBase64, 'length:', state.currentImageBase64?.length);
                if (state.currentImageBase64) {
                    console.log('Enhance: Adding image to request, mime:', state.currentImageMimeType);
                    // Include the uploaded image so AI can understand what's in it
                    parts.push({
                        inlineData: {
                            mimeType: state.currentImageMimeType,
                            data: state.currentImageBase64
                        }
                    });
                    parts.push({
                        text: `I have uploaded an image. First, analyze what's in the image (the subject, objects, style, colors, etc.). Then enhance this image editing prompt to be more detailed and effective, making sure it accurately refers to what's actually in the image. Keep the enhanced prompt concise (1-2 sentences).${productInstructions} Original prompt: "${prompt}". Return ONLY the enhanced prompt, nothing else.`
                    });
                } else {
                    // No image - just enhance the text prompt
                    parts.push({
                        text: `Enhance this image editing prompt to be more detailed and effective. Keep it concise (1-2 sentences).${productInstructions} Original: "${prompt}". Return ONLY the enhanced prompt, nothing else.`
                    });
                }

                // Build request body with model config
                const requestBody = {
                    contents: [{ parts }]
                };

                // Add thinking config if the model supports it
                if (modelConfig.thinking) {
                    requestBody.generationConfig = {
                        thinkingConfig: {
                            thinkingBudget: modelConfig.thinking === 'minimal' ? 1024 :
                                           modelConfig.thinking === 'low' ? 4096 :
                                           modelConfig.thinking === 'medium' ? 8192 :
                                           modelConfig.thinking === 'high' ? 16384 : 4096
                        }
                    };
                }

                const response = await fetch(`${modelConfig.endpoint}?key=${encodeURIComponent(apiKey)}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody)
                });
                const data = await response.json();

                // Handle response (thinking models may have multiple parts)
                let enhanced = '';
                if (data.candidates?.[0]?.content?.parts) {
                    for (const part of data.candidates[0].content.parts) {
                        if (part.text) {
                            enhanced = part.text;
                        }
                    }
                }
                if (enhanced) promptInput.value = enhanced.replace(/^["']|["']$/g, '');
            } catch (e) {
                console.error('Enhance error:', e);
            } finally {
                enhanceBtn.disabled = false;
                enhanceBtn.textContent = ' Enhance';
            }
        });

        // ========== MEGA PROMPT (Editor) ==========
        const megaPromptEditorBtn = $('megaPromptEditorBtn');
        const editorModelSelect = $('editorModelSelect');
        let editorCurrentMegaPrompt = null;

        megaPromptEditorBtn.addEventListener('click', async () => {
            const idea = promptInput.value.trim();
            const apiKey = apiKeyInput.value.trim();

            // Get product from editor dropdown directly, not global state
            const editorProductSelect = $('editorProductSelect');
            const selectedProductId = editorProductSelect?.value ? parseInt(editorProductSelect.value) : null;
            const product = selectedProductId ? state.products.find(p => p.id === selectedProductId) : null;

            if (!idea) { alert('Enter a prompt first'); return; }
            if (!apiKey) { alert('Enter API key first'); return; }

            megaPromptEditorBtn.disabled = true;
            megaPromptEditorBtn.innerHTML = ' Generating...';

            // Get selected model from editor dropdown
            const selectedModel = editorModelSelect.value;
            const modelConfig = promptGenModels[selectedModel] || promptGenModels['pro'];

            // Check if product has a reference image
            const hasProductImage = product && product.referenceImage;
            const hasUploadedImage = state.currentImageBase64;

            // Build the user message with context
            let userMessage = `INPUT: "${idea}"`;

            if (product) {
                userMessage += `\n\nPRODUCT PROFILE REQUIREMENTS:
- Product Name: ${product.name}
- Description: ${product.description || 'Not specified'}`;
                if ((product.goldenPhrases || []).length) {
                    userMessage += `\n- MANDATORY PHRASES (you MUST weave these naturally into the prompt): "${product.goldenPhrases.join('", "')}"`;
                }
                if ((product.forbiddenWords || []).length) {
                    userMessage += `\n- FORBIDDEN TERMS (NEVER use these words): ${product.forbiddenWords.join(', ')}`;
                }
                userMessage += `\n\nCRITICAL: The generated Mega Prompt must strictly follow these product requirements.`;
            }

            // Add aspect ratio constraint
            const aspectRatioDescriptions = {
                '1:1': 'Square (1:1) - ideal for social media posts',
                '16:9': 'Widescreen (16:9) - ideal for presentations, YouTube',
                '9:16': 'Vertical (9:16) - ideal for mobile, stories, reels',
                '4:3': 'Landscape (4:3) - traditional photography',
                '3:4': 'Portrait (3:4) - portraits, Pinterest',
                '4:5': 'Portrait (4:5) - ideal for Instagram posts',
                '3:2': 'Landscape (3:2) - DSLR photography',
                '2:3': 'Portrait (2:3) - magazine covers, posters'
            };
            userMessage += `\n\nREQUIRED ASPECT RATIO: ${aspectRatioDescriptions[state.selectedAspectRatio] || 'Square (1:1)'}
Important: The Tech Specs section MUST use this exact aspect ratio.`;

            userMessage += `\n\nPlease analyze this input and generate a comprehensive Mega Prompt using the Structured Contextual Expansion framework.`;

            // Build request parts
            const parts = [];

            // Include image - either from current upload or from product reference
            // Don't add both if they're the same (when product was selected, image was loaded into state)
            let imageAdded = false;

            if (hasUploadedImage && state.currentImageBase64) {
                console.log('Mega Prompt: Adding uploaded image, mime:', state.currentImageMimeType, 'length:', state.currentImageBase64?.length);
                // Validate base64 data
                if (state.currentImageBase64.length > 100) {
                    parts.push({
                        inlineData: {
                            mimeType: state.currentImageMimeType || 'image/jpeg',
                            data: state.currentImageBase64
                        }
                    });
                    userMessage += `\n\n[An image has been provided - analyze its contents and incorporate accurate visual details]`;
                    imageAdded = true;
                } else {
                    console.error('Mega Prompt: Invalid base64 data, length too short');
                }
            }

            // Only add product reference image if we haven't already added an image
            // (When product is selected, its image is loaded into state.currentImageBase64)
            if (hasProductImage && !imageAdded) {
                console.log('Mega Prompt: Fetching product reference image...');
                const productImageData = await getImageDataFromSource(product.referenceImage);
                if (productImageData && productImageData.base64Data?.length > 100) {
                    console.log('Mega Prompt: Adding product image, mime:', productImageData.mimeType, 'length:', productImageData.base64Data?.length);
                    parts.push({
                        inlineData: {
                            mimeType: productImageData.mimeType,
                            data: productImageData.base64Data
                        }
                    });
                    userMessage += `\n\n[A reference image of the product is attached - use it to inform accurate visual details]`;
                } else {
                    console.error('Mega Prompt: Failed to get product image data');
                }
            }

            parts.push({ text: userMessage });

            // Build request body (same as prompt generator)
            const requestBody = {
                contents: [
                    {
                        role: 'user',
                        parts: [{ text: MEGA_PROMPT_SYSTEM }]
                    },
                    {
                        role: 'model',
                        parts: [{ text: 'I understand. I will analyze inputs using Structured Contextual Expansion and output comprehensive prompts using the exact Markdown format specified: Situation, Task, Objective, Visual Knowledge, Negative Constraints, and Tech Specs. I will be specific, infer missing details, and provide actionable guidance.' }]
                    },
                    {
                        role: 'user',
                        parts: parts
                    }
                ],
                generationConfig: {
                    temperature: 0.8,
                    maxOutputTokens: 4096
                }
            };

            // Add thinking_config if using a thinking model
            if (modelConfig.thinking) {
                requestBody.generationConfig.thinking_config = {
                    thinking_budget: modelConfig.thinking
                };
            }

            try {
                const response = await fetch(modelConfig.endpoint + '?key=' + apiKey, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody)
                });

                const data = await response.json();

                if (data.error) {
                    throw new Error(data.error.message || 'API error');
                }

                const text = data.candidates?.[0]?.content?.parts?.[0]?.text || '';

                if (!text) {
                    throw new Error('No response generated');
                }

                // Store and display the mega prompt
                editorCurrentMegaPrompt = text;
                displayEditorMegaPrompt(text);
                showStatus('Mega Prompt generated!', 'success');

            } catch (e) {
                console.error('Mega prompt error:', e);
                showStatus('Error: ' + e.message, 'error');
            } finally {
                megaPromptEditorBtn.disabled = false;
                megaPromptEditorBtn.innerHTML = ' Mega Prompt';
            }
        });

        function displayEditorMegaPrompt(text) {
            const container = $('editorMegaOutput');
            if (!container) return;

            const sections = parseMegaPrompt(text);

            container.innerHTML = `
                <div class="editor-mega-output-header">
                    <h4>Structured Mega Prompt</h4>
                    <div class="editor-mega-output-actions">
                        <button class="use-btn" onclick="useEditorMegaPrompt()">Use as Prompt</button>
                        <button onclick="copyEditorMegaPrompt()">Copy All</button>
                        <button onclick="copyEditorMegaPromptCompiled()">Copy Compiled</button>
                    </div>
                </div>

                ${sections.situation ? `
                <div class="editor-mega-section">
                    <h5 class="situation">Situation</h5>
                    <p>${escapeHtml(sections.situation)}</p>
                </div>` : ''}

                ${sections.task ? `
                <div class="editor-mega-section">
                    <h5 class="task">Task</h5>
                    <p>${escapeHtml(sections.task)}</p>
                </div>` : ''}

                ${sections.objective ? `
                <div class="editor-mega-section">
                    <h5 class="objective">Objective</h5>
                    <p>${escapeHtml(sections.objective)}</p>
                </div>` : ''}

                ${sections.visual ? `
                <div class="editor-mega-section">
                    <h5 class="visual">Visual Knowledge</h5>
                    <ul>${sections.visual.split('\n').map(line => line.replace(/^[-*]\s*/, '').trim()).filter(l => l).map(item => `<li>${escapeHtml(item)}</li>`).join('')}</ul>
                </div>` : ''}

                ${sections.negative ? `
                <div class="editor-mega-section">
                    <h5 class="negative">Negative Constraints</h5>
                    <ul>${sections.negative.split('\n').map(line => line.replace(/^[-*]\s*/, '').trim()).filter(l => l).map(item => `<li>${escapeHtml(item)}</li>`).join('')}</ul>
                </div>` : ''}

                ${sections.tech ? `
                <div class="editor-mega-section">
                    <h5 class="tech">Tech Specs</h5>
                    <ul>${sections.tech.split('\n').map(line => line.replace(/^[-*]\s*/, '').trim()).filter(l => l).map(item => `<li>${escapeHtml(item)}</li>`).join('')}</ul>
                </div>` : ''}
            `;

            container.classList.add('show');
        }

        function useEditorMegaPrompt() {
            if (editorCurrentMegaPrompt) {
                promptInput.value = editorCurrentMegaPrompt;
                autoResizePromptInput();
                showStatus('Mega Prompt loaded!', 'success');
            }
        }

        function copyEditorMegaPrompt() {
            if (editorCurrentMegaPrompt) {
                navigator.clipboard.writeText(editorCurrentMegaPrompt).then(() => {
                    showStatus('Full Mega Prompt copied!', 'success');
                });
            }
        }

        function copyEditorMegaPromptCompiled() {
            if (!editorCurrentMegaPrompt) return;

            const sections = parseMegaPrompt(editorCurrentMegaPrompt);
            let compiled = '';

            if (sections.task) compiled += sections.task.replace(/\n/g, ' ').trim();
            if (sections.visual) {
                const visualItems = sections.visual.split('\n')
                    .map(line => line.replace(/^[-*]\s*/, '').replace(/\*\*[^*]+\*\*:\s*/g, '').trim())
                    .filter(line => line.length > 0);
                compiled += ' ' + visualItems.join(', ');
            }
            if (sections.situation) compiled += ' Context: ' + sections.situation.replace(/\n/g, ' ').trim();
            if (sections.objective) compiled += ' Goal: ' + sections.objective.replace(/\n/g, ' ').trim();

            navigator.clipboard.writeText(compiled.trim()).then(() => {
                showStatus('Compiled prompt copied!', 'success');
            });
        }

        // ========== STATUS ==========
        function showStatus(message, type) {
            statusDiv.className = 'status ' + type;
            statusDiv.innerHTML = type === 'loading' ? `<span class="loader"></span>${message}` : message;
        }

        // ========== DISPLAY RESULTS ==========
        function displayResult(images) {
            state.generatedImages = images;

            const headerHtml = `
                <div class="result-header">
                    <span class="result-header-title">Generated ${images.length === 1 ? 'Image' : 'Images'}</span>
                    <button class="result-clear-btn" onclick="clearGeneratedImages()">Clear</button>
                </div>
            `;

            if (images.length === 1) {
                const img = images[0];
                resultArea.innerHTML = headerHtml + `
                    <img src="${img.src}" alt="Result" id="resultImage" onclick="openLightbox(state.generatedImages, 0, 'results')" style="cursor: zoom-in;">
                    <div style="display: flex; gap: 8px; margin-top: 14px; flex-wrap: wrap; justify-content: center;">
                        <button class="action-btn download" onclick="openExport(0)">Export</button>
                        <button class="action-btn chain" onclick="useAsInput(0)">Edit Again</button>
                        <button class="action-btn" onclick="openLassoModal(0)" style="background: linear-gradient(135deg, #7c3aed, #ec4899);"> Select Area</button>
                        <button class="action-btn favorite" onclick="saveToGallery(0)">Save</button>
                        <button class="action-btn ideas" onclick="getIdeas(0)">Ideas</button>
                    </div>
                `;
            } else {
                let html = headerHtml + '<div class="results-grid">';
                images.forEach((img, i) => {
                    html += `
                        <div class="result-item">
                            <img src="${img.src}" alt="Result ${i+1}" onclick="openLightbox(state.generatedImages, ${i}, 'results')" style="cursor: zoom-in;">
                            <div class="result-item-actions">
                                <button class="download-btn" onclick="event.stopPropagation(); openExport(${i})"></button>
                                <button class="chain-btn" onclick="event.stopPropagation(); useAsInput(${i})"></button>
                                <button class="chain-btn" onclick="event.stopPropagation(); openLassoModal(${i})" style="background: linear-gradient(135deg, #7c3aed, #ec4899);"></button>
                                <button class="fav-btn" onclick="event.stopPropagation(); saveToGallery(${i})"></button>
                                <button class="ideas-btn" onclick="event.stopPropagation(); getIdeas(${i})"></button>
                            </div>
                        </div>
                    `;
                });
                html += '</div>';
                resultArea.innerHTML = html;
            }
        }

        function clearGeneratedImages() {
            state.generatedImages = [];
            resultArea.innerHTML = `
                <div class="result-placeholder">
                    <span></span>
                    Your creation will appear here
                </div>
            `;
        }

        // ========== EDIT CHAIN ==========
        function useAsInput(index) {
            const img = state.generatedImages[index];
            if (img) {
                state.currentImage = img.src;
                state.currentImageBase64 = img.src.split(',')[1];
                state.currentImageMimeType = img.mimeType || 'image/png';
                displayUploadedImage(img.src);
                showStatus('Image loaded for further editing!', 'success');
            }
        }

        // ========== COMPARE (BEFORE/AFTER) ==========
        function openCompare(index) {
            if (!state.originalImage) {
                alert('No original image to compare');
                return;
            }
            const after = state.generatedImages[index];
            $('compareBefore').src = state.originalImage;
            $('compareAfter').src = after.src;
            $('ideasModal').classList.remove('active');
            $('compareModal').classList.add('active');
            initComparisonSlider();
        }

        function initComparisonSlider() {
            const container = $('comparisonContainer');
            const slider = $('comparisonSlider');
            const before = container.querySelector('.comparison-before');
            let isDragging = false;

            function updateSlider(x) {
                const rect = container.getBoundingClientRect();
                let pos = (x - rect.left) / rect.width * 100;
                pos = Math.max(0, Math.min(100, pos));
                slider.style.left = pos + '%';
                before.style.width = pos + '%';
            }

            slider.addEventListener('mousedown', () => isDragging = true);
            document.addEventListener('mouseup', () => isDragging = false);
            document.addEventListener('mousemove', e => { if (isDragging) updateSlider(e.clientX); });

            slider.addEventListener('touchstart', () => isDragging = true);
            document.addEventListener('touchend', () => isDragging = false);
            document.addEventListener('touchmove', e => { if (isDragging) updateSlider(e.touches[0].clientX); });
        }

        // ========== EXPORT ==========
        function openExport(index) {
            state.exportImageSrc = state.generatedImages[index]?.src;
            if (!state.exportImageSrc) return;
            $('exportModal').classList.add('active');
        }

        document.querySelectorAll('.export-format-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.export-format-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                state.exportFormat = btn.dataset.format;
                $('qualityGroup').style.display = state.exportFormat === 'png' ? 'none' : 'block';
            });
        });

        $('qualitySlider').addEventListener('input', e => {
            state.exportQuality = parseInt(e.target.value);
            $('qualityValue').textContent = state.exportQuality;
        });

        $('exportBtn').addEventListener('click', () => {
            const img = new Image();
            img.onload = () => {
                const canvas = document.createElement('canvas');
                canvas.width = img.width;
                canvas.height = img.height;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0);

                let mimeType = 'image/png';
                if (state.exportFormat === 'jpg') mimeType = 'image/jpeg';
                if (state.exportFormat === 'webp') mimeType = 'image/webp';

                const quality = state.exportFormat === 'png' ? 1 : state.exportQuality / 100;
                const dataUrl = canvas.toDataURL(mimeType, quality);

                const link = document.createElement('a');
                link.href = dataUrl;
                link.download = `knappshot-${Date.now()}.${state.exportFormat}`;
                link.click();
            };
            img.src = state.exportImageSrc;
            closeModal('exportModal');
        });

        // ========== QUEUE SYSTEM ==========
        const queuePanel = $('queuePanel');
        const queueList = $('queueList');
        const queueEmpty = $('queueEmpty');
        const queueCount = $('queueCount');
        const queueProgressBar = $('queueProgressBar');
        const queueProgressText = $('queueProgressText');
        const queueProgressPercent = $('queueProgressPercent');
        const queueProgressFill = $('queueProgressFill');

        function toggleQueuePanel() {
            queuePanel.classList.toggle('collapsed');
        }

        function showQueuePanel() {
            queuePanel.classList.remove('hidden');
        }

        function hideQueuePanel() {
            queuePanel.classList.add('hidden');
        }

        function addToQueue(imageBase64, imageMimeType, prompt) {
            const item = {
                id: Date.now().toString() + Math.random().toString(36).substr(2, 9),
                imageBase64,
                imageMimeType,
                prompt,
                status: 'pending',
                addedAt: Date.now(),
                startedAt: null,
                completedAt: null,
                estimatedComplete: null,
                result: null,
                error: null
            };
            state.queue.push(item);
            updateQueueUI();
            return item.id;
        }

        function removeFromQueue(id) {
            const index = state.queue.findIndex(item => item.id === id);
            if (index !== -1 && state.queue[index].status === 'pending') {
                state.queue.splice(index, 1);
                updateQueueUI();
            }
        }

        function moveQueueItem(id, direction) {
            const index = state.queue.findIndex(item => item.id === id);
            if (index === -1 || state.queue[index].status !== 'pending') return;

            const newIndex = direction === 'up' ? index - 1 : index + 1;
            if (newIndex < 0 || newIndex >= state.queue.length) return;
            if (state.queue[newIndex].status !== 'pending') return;

            [state.queue[index], state.queue[newIndex]] = [state.queue[newIndex], state.queue[index]];
            updateQueueUI();
        }

        function updateQueueUI() {
            const pendingItems = state.queue.filter(i => i.status === 'pending' || i.status === 'processing');
            queueCount.textContent = pendingItems.length;

            if (state.queue.length === 0) {
                queueEmpty.style.display = 'block';
                queueList.innerHTML = '';
                queueProgressBar.style.display = 'none';
            } else {
                queueEmpty.style.display = 'none';
                renderQueueList();
                updateQueueProgress();
            }
        }

        function renderQueueList() {
            queueList.innerHTML = state.queue.map((item, index) => {
                const statusClass = item.status;
                const pendingIndex = state.queue.filter((i, idx) => idx < index && i.status === 'pending').length;
                const eta = item.status === 'pending' ? formatETA(calculateETA(pendingIndex + 1)) : '';

                let statusHtml = '';
                if (item.status === 'pending') {
                    statusHtml = `<span class="queue-status pending">Pending</span>`;
                } else if (item.status === 'processing') {
                    statusHtml = `<span class="queue-status processing"><span class="queue-status-spinner"></span> Processing</span>`;
                } else if (item.status === 'completed') {
                    statusHtml = `<span class="queue-status completed">Done</span>`;
                } else if (item.status === 'failed') {
                    statusHtml = `<span class="queue-status failed">Failed</span>`;
                }

                const canModify = item.status === 'pending';

                return `
                    <div class="queue-item ${statusClass}" data-id="${item.id}">
                        <img class="queue-item-thumb" src="data:${item.imageMimeType};base64,${item.imageBase64}" alt="Queue item">
                        <div class="queue-item-info">
                            <div class="queue-item-prompt">${item.prompt || 'No prompt'}</div>
                            <div class="queue-item-meta">
                                ${statusHtml}
                                ${eta ? `<span class="queue-eta countdown" data-eta="${calculateETA(pendingIndex + 1)}">${eta}</span>` : ''}
                            </div>
                        </div>
                        <div class="queue-item-actions">
                            ${canModify ? `
                                <button class="queue-action-btn" onclick="moveQueueItem('${item.id}', 'up')" title="Move up"></button>
                                <button class="queue-action-btn" onclick="moveQueueItem('${item.id}', 'down')" title="Move down"></button>
                                <button class="queue-action-btn remove" onclick="removeFromQueue('${item.id}')" title="Remove"></button>
                            ` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function updateQueueProgress() {
            const total = state.queue.length;
            const completed = state.queue.filter(i => i.status === 'completed' || i.status === 'failed').length;
            const processing = state.queue.filter(i => i.status === 'processing').length;

            if (state.isProcessing || processing > 0) {
                queueProgressBar.style.display = 'block';
                const percent = Math.round((completed / total) * 100);
                queueProgressText.textContent = `Processing ${completed + 1} of ${total}`;
                queueProgressPercent.textContent = `${percent}%`;
                queueProgressFill.style.width = `${percent}%`;
            } else if (completed === total && total > 0) {
                queueProgressBar.style.display = 'block';
                queueProgressText.textContent = `Completed ${total} of ${total}`;
                queueProgressPercent.textContent = '100%';
                queueProgressFill.style.width = '100%';
            } else {
                queueProgressBar.style.display = 'none';
            }
        }

        function calculateETA(queuePosition) {
            const itemsAhead = queuePosition;
            const estimatedMs = itemsAhead * state.avgProcessingTime;
            return Date.now() + estimatedMs;
        }

        function formatETA(etaTimestamp) {
            const remaining = Math.max(0, etaTimestamp - Date.now());
            const seconds = Math.floor(remaining / 1000);
            const minutes = Math.floor(seconds / 60);
            const secs = seconds % 60;

            if (minutes > 0) {
                return `~${minutes}:${secs.toString().padStart(2, '0')}`;
            }
            return `~${secs}s`;
        }

        function updateAvgProcessingTime(actualTime) {
            state.avgProcessingTime = Math.round((state.avgProcessingTime * 0.7) + (actualTime * 0.3));
            state.queueHistory.push(actualTime);
            if (state.queueHistory.length > 20) state.queueHistory.shift();
        }

        function startQueueTimer() {
            if (state.queueTimerInterval) return;
            state.queueTimerInterval = setInterval(() => {
                const etaElements = document.querySelectorAll('.queue-eta.countdown');
                etaElements.forEach(el => {
                    const eta = parseInt(el.dataset.eta);
                    if (eta) {
                        el.textContent = formatETA(eta);
                    }
                });
            }, 1000);
        }

        function stopQueueTimer() {
            if (state.queueTimerInterval) {
                clearInterval(state.queueTimerInterval);
                state.queueTimerInterval = null;
            }
        }

        async function processQueue() {
            if (state.isProcessing || state.queue.length === 0) return;

            const pendingItems = state.queue.filter(i => i.status === 'pending');
            if (pendingItems.length === 0) return;

            state.isProcessing = true;
            startQueueTimer();
            showQueuePanel();

            const endpoint = apiEndpointInput.value;
            const apiKey = apiKeyInput.value;
            const systemInstructions = $('systemInstructions').value.trim();

            for (const item of state.queue) {
                if (item.status !== 'pending') continue;

                item.status = 'processing';
                item.startedAt = Date.now();
                state.currentQueueItem = item;
                updateQueueUI();

                try {
                    const aspectMap = {
                        '1:1': 'square (1:1)',
                        '16:9': 'widescreen (16:9)',
                        '9:16': 'portrait (9:16)',
                        '4:3': 'landscape (4:3)',
                        '3:4': 'portrait (3:4)',
                        '4:5': 'portrait (4:5)',
                        '3:2': 'landscape (3:2)',
                        '2:3': 'portrait (2:3)'
                    };
                    const resolutionMap = {
                        '1K': '1024x1024 pixels',
                        '2K': '2048x2048 pixels',
                        '4K': '4096x4096 pixels'
                    };

                    let fullPrompt = '';
                    if (systemInstructions) {
                        fullPrompt = `[System Instructions: ${systemInstructions}]\n\n`;
                    }

                    // Add @ mention context only if mentions are used in the prompt
                    const hasMentions = item.prompt.includes('@main-image') || item.prompt.includes('@reference');
                    if (hasMentions) {
                        let mentionContext = '[Image References: ';
                        const contextParts = [];
                        if (item.prompt.includes('@main-image')) {
                            contextParts.push('@main-image refers to the first/main uploaded image');
                        }
                        if (item.prompt.includes('@reference')) {
                            contextParts.push('@reference refers to the style reference image (second image)');
                        }
                        mentionContext += contextParts.join('; ') + ']\n\n';
                        fullPrompt += mentionContext;
                    }

                    fullPrompt += item.prompt;
                    fullPrompt += `\n\nAspect ratio: ${aspectMap[state.selectedAspectRatio] || 'square (1:1)'}`;
                    fullPrompt += `\nResolution: ${resolutionMap[state.selectedResolution] || '1024x1024 pixels'}`;

                    const parts = [
                        { inlineData: { mimeType: item.imageMimeType, data: item.imageBase64 } },
                        { text: fullPrompt }
                    ];

                    if (state.referenceImageBase64) {
                        parts.splice(1, 0, {
                            inlineData: {
                                mimeType: state.currentImageMimeType || 'image/jpeg',
                                data: state.referenceImageBase64
                            }
                        });
                    }

                    const response = await fetch(`${endpoint}?key=${apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{ parts }],
                            generationConfig: { responseModalities: ['IMAGE', 'TEXT'] }
                        })
                    });

                    if (!response.ok) {
                        throw new Error(`API error: ${response.status}`);
                    }

                    const data = await response.json();
                    const candidate = data.candidates?.[0];
                    const imagePart = candidate?.content?.parts?.find(p => p.inlineData?.mimeType?.startsWith('image/'));

                    if (imagePart) {
                        item.result = `data:${imagePart.inlineData.mimeType};base64,${imagePart.inlineData.data}`;
                        item.status = 'completed';

                        // Add to review
                        addToReview(item.result, item.prompt, `data:${item.imageMimeType};base64,${item.imageBase64}`);
                    } else {
                        throw new Error('No image in response');
                    }

                } catch (error) {
                    console.error('Queue processing error:', error);
                    item.status = 'failed';
                    item.error = error.message;
                }

                item.completedAt = Date.now();
                const processingTime = item.completedAt - item.startedAt;
                updateAvgProcessingTime(processingTime);
                updateQueueUI();
            }

            state.isProcessing = false;
            state.currentQueueItem = null;
            stopQueueTimer();
            updateQueueUI();

            // Clear completed items after a delay
            setTimeout(() => {
                state.queue = state.queue.filter(i => i.status !== 'completed');
                updateQueueUI();
            }, 3000);

            // Notify user and switch to review tab if we have items
            const completedCount = state.queue.filter(i => i.status === 'completed').length;
            const failedCount = state.queue.filter(i => i.status === 'failed').length;

            if (completedCount > 0) {
                addNotification(
                    'batch_complete',
                    'Batch Complete',
                    `${completedCount} new image${completedCount !== 1 ? 's' : ''} ready for review${failedCount > 0 ? ` (${failedCount} failed)` : ''}`,
                    'View in Review'
                );
                pulseReviewBadge();
            } else if (failedCount > 0) {
                addNotification(
                    'error',
                    'Batch Failed',
                    `All ${failedCount} generation${failedCount !== 1 ? 's' : ''} failed. Please check your API key and try again.`,
                    null
                );
            }
        }

        // ========== REVIEW SYSTEM ==========
        const reviewGrid = $('reviewGrid');
        const reviewEmpty = $('reviewEmpty');
        const reviewTabBadge = $('reviewTabBadge');
        const reviewCountText = $('reviewCountText');
        const reviewSelectionBar = $('reviewSelectionBar');
        const reviewSelectionCount = $('reviewSelectionCount');
        const approveAllBtn = $('approveAllBtn');
        const clearReviewBtn = $('clearReviewBtn');

        function addToReview(imageSrc, prompt, originalImage = null) {
            const item = {
                id: Date.now().toString() + Math.random().toString(36).substr(2, 9),
                src: imageSrc,
                prompt: prompt || '',
                generatedAt: Date.now(),
                originalImage: originalImage,
                selected: false
            };
            state.reviewItems.unshift(item);
            saveReviewItems();
            updateReviewUI();
        }

        function saveReviewItems() {
            Storage.setIfOffline('reviewItems', state.reviewItems);
        }

        function updateReviewUI() {
            const count = state.reviewItems.length;

            // Update badge
            reviewTabBadge.textContent = count;
            reviewTabBadge.classList.toggle('empty', count === 0);

            // Update count text
            reviewCountText.textContent = `${count} image${count !== 1 ? 's' : ''} pending review`;

            // Update buttons
            approveAllBtn.disabled = count === 0;
            clearReviewBtn.disabled = count === 0;

            // Show/hide empty state
            if (count === 0) {
                reviewEmpty.style.display = 'block';
                reviewGrid.innerHTML = '';
            } else {
                reviewEmpty.style.display = 'none';
                renderReviewGrid();
            }

            updateReviewSelectionBar();
        }

        function renderReviewGrid() {
            reviewGrid.innerHTML = state.reviewItems.map(item => {
                const date = new Date(item.generatedAt);
                const dateStr = date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});

                return `
                    <div class="review-item ${item.selected ? 'selected' : ''}" data-id="${item.id}">
                        <div class="review-item-checkbox" onclick="toggleReviewItemSelection('${item.id}')">${item.selected ? '' : ''}</div>
                        <img class="review-item-image" src="${item.src}" alt="Review item" onclick="openReviewLightbox('${item.id}')">
                        <div class="review-item-overlay">
                            <div class="review-item-prompt">${item.prompt || 'No prompt'}</div>
                            <div class="review-item-date">${dateStr}</div>
                            <div class="review-item-actions">
                                <button class="review-item-btn approve" onclick="approveReviewItem('${item.id}')"> Add</button>
                                ${item.originalImage ? `<button class="review-item-btn compare" onclick="compareReviewItem('${item.id}')"></button>` : ''}
                                <button class="review-item-btn reject" onclick="rejectReviewItem('${item.id}')"></button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function toggleReviewItemSelection(id) {
            const item = state.reviewItems.find(i => i.id === id);
            if (item) {
                item.selected = !item.selected;
                updateReviewUI();
            }
        }

        function toggleReviewSelectMode() {
            state.reviewSelectMode = !state.reviewSelectMode;
            const btn = $('reviewSelectModeBtn');
            btn.textContent = state.reviewSelectMode ? 'Cancel' : 'Select';

            if (!state.reviewSelectMode) {
                state.reviewItems.forEach(i => i.selected = false);
            }
            updateReviewUI();
        }

        function updateReviewSelectionBar() {
            const selectedCount = state.reviewItems.filter(i => i.selected).length;
            reviewSelectionCount.textContent = `${selectedCount} selected`;
            reviewSelectionBar.classList.toggle('show', selectedCount > 0 && state.reviewSelectMode);
        }

        function selectAllReview() {
            state.reviewItems.forEach(i => i.selected = true);
            updateReviewUI();
        }

        async function approveReviewItem(id) {
            const item = state.reviewItems.find(i => i.id === id);
            if (!item) return;

            const galleryItem = {
                id: Date.now().toString(),
                src: item.src,
                prompt: item.prompt,
                date: new Date().toISOString(),
                favorite: false
            };

            if (currentUser) {
                showSyncIndicator('Saving to cloud...');
                const cloudId = await saveImageToCloud(galleryItem);
                if (cloudId) {
                    galleryItem.id = cloudId;
                    state.gallery.unshift(galleryItem);
                    showSyncIndicator('Saved to cloud!', false);
                }
            } else {
                state.gallery.unshift(galleryItem);
                if (state.gallery.length > 50) state.gallery.pop();
                Storage.setIfOffline('gallery', state.gallery);
            }

            state.reviewItems = state.reviewItems.filter(i => i.id !== id);
            saveReviewItems();
            updateReviewUI();
            renderGallery();
            showStatus('Added to gallery!', 'success');
        }

        function rejectReviewItem(id) {
            state.reviewItems = state.reviewItems.filter(i => i.id !== id);
            saveReviewItems();
            updateReviewUI();
        }

        async function approveAllReview() {
            if (state.reviewItems.length === 0) return;

            for (const item of [...state.reviewItems]) {
                await approveReviewItem(item.id);
            }
            showStatus(`Added ${state.reviewItems.length} images to gallery!`, 'success');
        }

        async function approveSelectedReview() {
            const selected = state.reviewItems.filter(i => i.selected);
            if (selected.length === 0) return;

            for (const item of selected) {
                await approveReviewItem(item.id);
            }
            state.reviewSelectMode = false;
            $('reviewSelectModeBtn').textContent = 'Select';
            showStatus(`Added ${selected.length} images to gallery!`, 'success');
        }

        function rejectSelectedReview() {
            state.reviewItems = state.reviewItems.filter(i => !i.selected);
            saveReviewItems();
            state.reviewSelectMode = false;
            $('reviewSelectModeBtn').textContent = 'Select';
            updateReviewUI();
        }

        function clearReview() {
            if (!confirm('Discard all images in review? This cannot be undone.')) return;
            state.reviewItems = [];
            saveReviewItems();
            updateReviewUI();
        }

        function openReviewLightbox(id) {
            const item = state.reviewItems.find(i => i.id === id);
            if (item) {
                openLightbox(item.src);
            }
        }

        function compareReviewItem(id) {
            const item = state.reviewItems.find(i => i.id === id);
            if (item && item.originalImage) {
                openCompare(item.originalImage, item.src);
            }
        }

        function pulseReviewBadge() {
            reviewTabBadge.classList.add('pulse');
            setTimeout(() => reviewTabBadge.classList.remove('pulse'), 4000);
        }

        // Initialize review UI on load
        updateReviewUI();

        // ========== NOTIFICATION SYSTEM ==========
        let notifications = Storage.get('notifications', []);
        let notificationClickHandler = null;

        function initNotificationUI() {
            const notificationBtn = $('notificationBtn');
            const notificationDropdown = $('notificationDropdown');

            if (notificationBtn && notificationDropdown) {
                // Remove old handler if exists
                if (notificationClickHandler) {
                    notificationBtn.removeEventListener('click', notificationClickHandler);
                }

                // Create new handler
                notificationClickHandler = (e) => {
                    e.stopPropagation();
                    notificationDropdown.classList.toggle('show');
                };

                notificationBtn.addEventListener('click', notificationClickHandler);
            }

            updateNotificationUI();
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', (e) => {
            const notificationDropdown = $('notificationDropdown');
            const notificationBtn = $('notificationBtn');
            if (notificationDropdown && notificationBtn &&
                !notificationDropdown.contains(e.target) && !notificationBtn.contains(e.target)) {
                notificationDropdown.classList.remove('show');
            }
        });

        function addNotification(type, title, message, actionText = null, actionCallback = null) {
            const notification = {
                id: Date.now().toString(),
                type,
                title,
                message,
                actionText,
                time: Date.now(),
                read: false
            };
            notifications.unshift(notification);
            if (notifications.length > 20) notifications.pop();
            Storage.set('notifications', notifications);
            updateNotificationUI();

            // Store callback if provided
            if (actionCallback) {
                notification.actionCallback = actionCallback;
            }
        }

        function updateNotificationUI() {
            const notificationBadge = $('notificationBadge');
            const notificationList = $('notificationList');
            const notificationEmpty = $('notificationEmpty');

            if (!notificationBadge || !notificationList) return;

            const unreadCount = notifications.filter(n => !n.read).length;

            // Update badge
            notificationBadge.textContent = unreadCount;
            notificationBadge.classList.toggle('hidden', unreadCount === 0);

            // Render list
            if (notifications.length === 0) {
                if (notificationEmpty) notificationEmpty.style.display = 'block';
                notificationList.innerHTML = `
                    <div class="notification-empty" id="notificationEmpty">
                        <div class="notification-empty-icon"></div>
                        <div>No notifications yet</div>
                    </div>
                `;
            } else {
                if (notificationEmpty) notificationEmpty.style.display = 'none';
                notificationList.innerHTML = notifications.map(n => {
                    const timeAgo = formatTimeAgo(n.time);
                    const icon = n.type === 'batch_complete' ? '' : n.type === 'error' ? '' : '';

                    return `
                        <div class="notification-item ${n.read ? '' : 'unread'}" data-id="${n.id}" onclick="handleNotificationClick('${n.id}')">
                            <div class="notification-item-header">
                                <span class="notification-icon">${icon}</span>
                                <span class="notification-title">${n.title}</span>
                            </div>
                            <div class="notification-message">${n.message}</div>
                            <div class="notification-time">${timeAgo}</div>
                            ${n.actionText ? `<span class="notification-action">${n.actionText}</span>` : ''}
                        </div>
                    `;
                }).join('');
            }
        }

        function handleNotificationClick(id) {
            const notification = notifications.find(n => n.id === id);
            if (!notification) return;

            // Mark as read
            notification.read = true;
            Storage.set('notifications', notifications);
            updateNotificationUI();

            // If it's a batch complete notification, switch to review tab
            if (notification.type === 'batch_complete') {
                notificationDropdown.classList.remove('show');
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                document.querySelector('.tab[data-tab="review"]').classList.add('active');
                $('tab-review').classList.add('active');
                updateReviewUI();
            }
        }

        function clearAllNotifications() {
            notifications = [];
            Storage.set('notifications', notifications);
            updateNotificationUI();
        }

        function formatTimeAgo(timestamp) {
            const seconds = Math.floor((Date.now() - timestamp) / 1000);

            if (seconds < 60) return 'Just now';
            if (seconds < 3600) return `${Math.floor(seconds / 60)}m ago`;
            if (seconds < 86400) return `${Math.floor(seconds / 3600)}h ago`;
            return `${Math.floor(seconds / 86400)}d ago`;
        }

        // Initialize notification UI
        initNotificationUI();

        // ========== GALLERY ==========
        async function saveToGallery(index) {
            const img = state.generatedImages[index];
            if (!img) return;

            const item = {
                id: Date.now().toString(),
                src: img.src,
                prompt: promptInput.value,
                date: new Date().toISOString(),
                favorite: false
            };

            if (currentUser) {
                // Save to cloud
                showSyncIndicator('Saving to cloud...');
                const cloudId = await saveImageToCloud(item);
                if (cloudId) {
                    item.id = cloudId;
                    state.gallery.unshift(item);
                    showSyncIndicator('Saved to cloud!', false);
                    showStatus('Saved to gallery!', 'success');
                } else {
                    showStatus('Error saving to cloud', 'error');
                }
            } else {
                // Save to local storage
                state.gallery.unshift(item);
                if (state.gallery.length > 50) state.gallery.pop();
                Storage.setIfOffline('gallery', state.gallery);
                showStatus('Saved to gallery!', 'success');
            }
        }

        // Gallery selection state
        let gallerySelectMode = false;
        let selectedGalleryIds = new Set();
        let currentCollectionAction = null;
        let editingCollectionId = null;

        // ========== COLLECTIONS FUNCTIONS ==========
        function renderCollections() {
            const list = $('collectionsList');
            const allCount = state.gallery.length;

            let html = `
                <button class="collection-chip ${state.activeCollection === null ? 'active' : ''}"
                        data-collection="all"
                        onclick="filterByCollection(null)"
                        ondragover="handleCollectionDragOver(event)"
                        ondragleave="handleCollectionDragLeave(event)"
                        ondrop="handleCollectionDrop(event, null)">
                    All <span class="collection-count">${allCount}</span>
                </button>
            `;

            state.collections.forEach(col => {
                const count = state.gallery.filter(item => item.collectionId === col.id).length;
                html += `
                    <button class="collection-chip ${state.activeCollection === col.id ? 'active' : ''}"
                            data-collection="${col.id}"
                            onclick="filterByCollection('${col.id}')"
                            oncontextmenu="event.preventDefault(); showCollectionContextMenu(event, '${col.id}')"
                            ondragover="handleCollectionDragOver(event)"
                            ondragleave="handleCollectionDragLeave(event)"
                            ondrop="handleCollectionDrop(event, '${col.id}')">
                        ${col.name} <span class="collection-count">${count}</span>
                    </button>
                `;
            });

            list.innerHTML = html;
        }

        function filterByCollection(collectionId) {
            state.activeCollection = collectionId;
            renderCollections();
            const activeFilter = document.querySelector('.filter-btn.active')?.dataset.filter || 'all';
            renderGallery(activeFilter);
        }

        function openCollectionModal(action = 'create', collectionId = null) {
            currentCollectionAction = action;
            editingCollectionId = collectionId;

            const modal = $('collectionModal');
            const title = $('collectionModalTitle');
            const input = $('collectionNameInput');
            const confirmBtn = $('collectionModalConfirm');
            const body = $('collectionModalBody');

            if (action === 'create') {
                title.textContent = 'Create Collection';
                confirmBtn.textContent = 'Create';
                confirmBtn.className = 'collection-modal-btn confirm';
                input.value = '';
                body.innerHTML = `<input type="text" class="collection-input" id="collectionNameInput" placeholder="Collection name...">`;
            } else if (action === 'rename') {
                const col = state.collections.find(c => c.id === collectionId);
                title.textContent = 'Rename Collection';
                confirmBtn.textContent = 'Save';
                confirmBtn.className = 'collection-modal-btn confirm';
                body.innerHTML = `<input type="text" class="collection-input" id="collectionNameInput" placeholder="Collection name..." value="${col?.name || ''}">`;
            } else if (action === 'delete') {
                const col = state.collections.find(c => c.id === collectionId);
                title.textContent = 'Delete Collection';
                confirmBtn.textContent = 'Delete';
                confirmBtn.className = 'collection-modal-btn danger';
                body.innerHTML = `<p style="color: var(--text-secondary); margin-bottom: 16px;">Are you sure you want to delete "${col?.name}"? Images in this collection will be moved to "All".</p>`;
            } else if (action === 'manage') {
                title.textContent = 'Manage Collections';
                confirmBtn.style.display = 'none';
                body.innerHTML = renderManageCollectionsContent();
            }

            modal.classList.add('active');

            setTimeout(() => {
                const newInput = $('collectionNameInput');
                if (newInput) newInput.focus();
            }, 100);
        }

        function renderManageCollectionsContent() {
            if (state.collections.length === 0) {
                return '<p style="color: var(--text-tertiary); text-align: center; padding: 20px;">No collections yet. Create one using the + button.</p>';
            }

            let html = '<div class="existing-collections">';
            state.collections.forEach(col => {
                const count = state.gallery.filter(item => item.collectionId === col.id).length;
                html += `
                    <div class="existing-collection-item">
                        <div class="existing-collection-info">
                            <span class="existing-collection-name">${col.name}</span>
                            <span class="existing-collection-count">${count} images</span>
                        </div>
                        <div class="existing-collection-actions">
                            <button onclick="openCollectionModal('rename', '${col.id}')" title="Rename"></button>
                            <button class="delete" onclick="openCollectionModal('delete', '${col.id}')" title="Delete"></button>
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            return html;
        }

        function closeCollectionModal() {
            $('collectionModal').classList.remove('active');
            currentCollectionAction = null;
            editingCollectionId = null;
            $('collectionModalConfirm').style.display = '';
        }

        function confirmCollectionAction() {
            if (currentCollectionAction === 'create') {
                const name = $('collectionNameInput')?.value.trim();
                if (!name) return;

                const newCollection = {
                    id: 'col_' + Date.now(),
                    name: name,
                    createdAt: Date.now()
                };

                state.collections.push(newCollection);
                Storage.setIfOffline('collections', state.collections);
                scheduleCloudSync();
                renderCollections();
                closeCollectionModal();
            } else if (currentCollectionAction === 'rename') {
                const name = $('collectionNameInput')?.value.trim();
                if (!name || !editingCollectionId) return;

                const col = state.collections.find(c => c.id === editingCollectionId);
                if (col) {
                    col.name = name;
                    Storage.setIfOffline('collections', state.collections);
                    scheduleCloudSync();
                    renderCollections();
                }
                closeCollectionModal();
            } else if (currentCollectionAction === 'delete') {
                if (!editingCollectionId) return;

                // Move images from deleted collection to no collection
                const affectedItems = [];
                state.gallery.forEach(item => {
                    if (item.collectionId === editingCollectionId) {
                        delete item.collectionId;
                        affectedItems.push(item);
                    }
                });
                Storage.setIfOffline('gallery', state.gallery);

                // Sync collectionId removal to cloud for each affected image
                affectedItems.forEach(item => {
                    updateImageInCloud(item.id, { collectionId: null });
                });

                state.collections = state.collections.filter(c => c.id !== editingCollectionId);
                Storage.setIfOffline('collections', state.collections);

                if (state.activeCollection === editingCollectionId) {
                    state.activeCollection = null;
                }

                scheduleCloudSync();
                renderCollections();
                const activeFilter = document.querySelector('.filter-btn.active')?.dataset.filter || 'all';
                renderGallery(activeFilter);
                closeCollectionModal();
            }
        }

        function showCollectionContextMenu(event, collectionId) {
            // For now, just open manage modal - could expand to custom context menu later
            openCollectionModal('manage');
        }

        // Move to collection functions
        let moveTargetImageId = null;
        let moveTargetMultiple = false;

        function openMoveToCollectionModal(imageId = null, multiple = false) {
            moveTargetImageId = imageId;
            moveTargetMultiple = multiple;

            const list = $('moveToCollectionList');
            let html = `
                <button class="move-collection-option" onclick="moveToCollection(null)">
                     None (Remove from collection)
                </button>
                <div class="move-collection-divider"></div>
            `;

            state.collections.forEach(col => {
                const isCurrent = !multiple && imageId &&
                    state.gallery.find(i => i.id === imageId)?.collectionId === col.id;
                html += `
                    <button class="move-collection-option ${isCurrent ? 'current' : ''}"
                            onclick="moveToCollection('${col.id}')">
                         ${col.name} ${isCurrent ? '(current)' : ''}
                    </button>
                `;
            });

            if (state.collections.length === 0) {
                html += '<p style="color: var(--text-tertiary); padding: 16px; text-align: center;">No collections yet. Create one first.</p>';
            }

            list.innerHTML = html;
            $('moveToCollectionModal').classList.add('active');
        }

        function closeMoveToCollectionModal() {
            $('moveToCollectionModal').classList.remove('active');
            moveTargetImageId = null;
            moveTargetMultiple = false;
        }

        // ========== DRAG AND DROP FOR COLLECTIONS ==========
        let draggedImageId = null;

        function handleGalleryDragStart(event, imageId) {
            draggedImageId = imageId;
            event.target.classList.add('dragging');
            event.dataTransfer.effectAllowed = 'move';
            event.dataTransfer.setData('text/plain', imageId);
        }

        function handleGalleryDragEnd(event) {
            event.target.classList.remove('dragging');
            draggedImageId = null;
            // Remove drag-over from all collection chips
            document.querySelectorAll('.collection-chip.drag-over').forEach(chip => {
                chip.classList.remove('drag-over');
            });
        }

        function handleCollectionDragOver(event) {
            event.preventDefault();
            event.dataTransfer.dropEffect = 'move';
            event.currentTarget.classList.add('drag-over');
        }

        function handleCollectionDragLeave(event) {
            event.currentTarget.classList.remove('drag-over');
        }

        function handleCollectionDrop(event, collectionId) {
            event.preventDefault();
            event.currentTarget.classList.remove('drag-over');

            const imageId = event.dataTransfer.getData('text/plain') || draggedImageId;
            if (!imageId) return;

            // Find and update the image
            const item = state.gallery.find(i => i.id === imageId);
            if (item) {
                if (collectionId) {
                    item.collectionId = collectionId;
                    const col = state.collections.find(c => c.id === collectionId);
                    showStatus(`Moved to "${col?.name || 'collection'}"`, 'success');
                } else {
                    delete item.collectionId;
                    showStatus('Removed from collection', 'success');
                }

                Storage.setIfOffline('gallery', state.gallery);
                scheduleCloudSync();
                // Sync collectionId to cloud for this specific image
                updateImageInCloud(item.id, { collectionId: item.collectionId || null });
                renderCollections();
                const activeFilter = document.querySelector('.filter-btn.active')?.dataset.filter || 'all';
                renderGallery(activeFilter);
            }

            draggedImageId = null;
        }

        function moveToCollection(collectionId) {
            const itemsToSync = [];

            if (moveTargetMultiple && selectedGalleryIds.size > 0) {
                // Move multiple selected items
                selectedGalleryIds.forEach(id => {
                    const item = state.gallery.find(i => i.id === id);
                    if (item) {
                        if (collectionId) {
                            item.collectionId = collectionId;
                        } else {
                            delete item.collectionId;
                        }
                        itemsToSync.push(item);
                    }
                });
            } else if (moveTargetImageId) {
                // Move single item
                const item = state.gallery.find(i => i.id === moveTargetImageId);
                if (item) {
                    if (collectionId) {
                        item.collectionId = collectionId;
                    } else {
                        delete item.collectionId;
                    }
                    itemsToSync.push(item);
                }
            }

            Storage.setIfOffline('gallery', state.gallery);
            scheduleCloudSync();

            // Sync collectionId to cloud for each moved item
            itemsToSync.forEach(item => {
                updateImageInCloud(item.id, { collectionId: item.collectionId || null });
            });

            renderCollections();
            const activeFilter = document.querySelector('.filter-btn.active')?.dataset.filter || 'all';
            renderGallery(activeFilter);
            closeMoveToCollectionModal();
        }

        // Event listener for add collection button
        document.addEventListener('DOMContentLoaded', () => {
            $('addCollectionBtn')?.addEventListener('click', () => openCollectionModal('create'));
        });

        function renderGallery(filter = 'all') {
            const grid = $('galleryGrid');
            let items = state.gallery;

            // Filter by favorites
            if (filter === 'favorites') items = items.filter(i => i.favorite);

            // Filter by collection
            if (state.activeCollection) {
                items = items.filter(i => i.collectionId === state.activeCollection);
            }

            if (items.length === 0) {
                let emptyMsg = 'No images yet. Start creating!';
                if (filter === 'favorites') emptyMsg = 'No favorites yet';
                else if (state.activeCollection) {
                    const col = state.collections.find(c => c.id === state.activeCollection);
                    emptyMsg = `No images in "${col?.name || 'this collection'}" yet`;
                }
                grid.innerHTML = `<div class="gallery-empty"><span></span>${emptyMsg}</div>`;
                updateSelectionUI();
                return;
            }

            // Store current filtered items for lightbox navigation
            state.currentGalleryItems = items;

            grid.innerHTML = items.map((item, i) => {
                const collectionName = item.collectionId ?
                    state.collections.find(c => c.id === item.collectionId)?.name : null;
                const realIndex = state.gallery.findIndex(g => g.id === item.id);

                return `
                <div class="gallery-item ${item.favorite ? 'favorited' : ''} ${selectedGalleryIds.has(item.id) ? 'selected' : ''}"
                     data-id="${item.id}"
                     draggable="true"
                     ondragstart="handleGalleryDragStart(event, '${item.id}')"
                     ondragend="handleGalleryDragEnd(event)"
                     onclick="${gallerySelectMode ? `toggleGallerySelect('${item.id}')` : `openGalleryLightbox(${i})`}"
                     style="cursor: ${gallerySelectMode ? 'pointer' : 'zoom-in'};">
                    <div class="select-checkbox" onclick="event.stopPropagation(); toggleGallerySelect('${item.id}')"></div>
                    <img src="${item.src}" alt="Gallery item">
                    <button class="gallery-item-delete" onclick="event.stopPropagation(); deleteFromGallery(${realIndex})" title="Delete"></button>
                    <div class="gallery-item-fav" onclick="event.stopPropagation(); toggleFavorite(event, ${realIndex})">${item.favorite ? '' : ''}</div>
                    ${collectionName ? `<div class="gallery-item-collection"> ${collectionName}</div>` : ''}
                    <div class="gallery-item-overlay">
                        <div class="gallery-item-info">
                            <div class="gallery-item-prompt">${item.prompt || 'No prompt'}</div>
                            <div class="gallery-item-date">${new Date(item.date).toLocaleDateString()}</div>
                        </div>
                    </div>
                </div>
            `}).join('');

            updateSelectionUI();
        }

        function toggleSelectMode() {
            gallerySelectMode = !gallerySelectMode;
            const grid = $('galleryGrid');

            if (gallerySelectMode) {
                grid.classList.add('select-mode');
                $('selectModeBtn').classList.add('active');
                $('selectModeBtn').textContent = 'Cancel';
                $('selectAllBtn').style.display = 'inline-block';
                $('selectionCount').style.display = 'inline-block';
                $('moveToCollectionBtn').style.display = 'inline-block';
                $('deleteSelectedBtn').style.display = 'inline-block';
                $('exportSelectedBtn').style.display = 'inline-block';
            } else {
                grid.classList.remove('select-mode');
                $('selectModeBtn').classList.remove('active');
                $('selectModeBtn').textContent = 'Select';
                $('selectAllBtn').style.display = 'none';
                $('selectionCount').style.display = 'none';
                $('moveToCollectionBtn').style.display = 'none';
                $('deleteSelectedBtn').style.display = 'none';
                $('exportSelectedBtn').style.display = 'none';
                selectedGalleryIds.clear();
            }

            const activeFilter = document.querySelector('.filter-btn.active')?.dataset.filter || 'all';
            renderGallery(activeFilter);
        }

        function toggleGallerySelect(id) {
            if (selectedGalleryIds.has(id)) {
                selectedGalleryIds.delete(id);
            } else {
                selectedGalleryIds.add(id);
            }

            // Update just the item's class without full re-render
            const item = document.querySelector(`.gallery-item[data-id="${id}"]`);
            if (item) {
                item.classList.toggle('selected', selectedGalleryIds.has(id));
            }

            updateSelectionUI();
        }

        function selectAllGallery() {
            const allSelected = state.currentGalleryItems.every(item => selectedGalleryIds.has(item.id));

            if (allSelected) {
                // Deselect all
                selectedGalleryIds.clear();
                $('selectAllBtn').textContent = 'Select All';
            } else {
                // Select all visible items
                state.currentGalleryItems.forEach(item => selectedGalleryIds.add(item.id));
                $('selectAllBtn').textContent = 'Deselect All';
            }

            const activeFilter = document.querySelector('.filter-btn.active')?.dataset.filter || 'all';
            renderGallery(activeFilter);
        }

        function updateSelectionUI() {
            const count = selectedGalleryIds.size;
            $('selectionCount').textContent = `${count} selected`;
            $('exportSelectedBtn').disabled = count === 0;
            $('deleteSelectedBtn').disabled = count === 0;
            $('moveToCollectionBtn').disabled = count === 0;

            // Update select all button text
            if (state.currentGalleryItems && state.currentGalleryItems.length > 0) {
                const allSelected = state.currentGalleryItems.every(item => selectedGalleryIds.has(item.id));
                $('selectAllBtn').textContent = allSelected ? 'Deselect All' : 'Select All';
            }
        }

        function openGalleryLightbox(index) {
            const images = state.currentGalleryItems.map(item => ({ src: item.src }));
            openLightbox(images, index, 'gallery');
        }

        async function loadFromGallery(index) {
            const item = state.gallery[index];
            if (item) {
                state.currentImage = item.src;
                state.originalImage = item.src;
                promptInput.value = item.prompt || '';
                displayUploadedImage(item.src);
                document.querySelector('[data-tab="editor"]').click();

                // Handle base64 extraction properly for both data URLs and Firebase URLs
                if (item.src.startsWith('data:')) {
                    const mimeMatch = item.src.match(/^data:([^;]+);/);
                    state.currentImageMimeType = mimeMatch ? mimeMatch[1] : 'image/jpeg';
                    state.currentImageBase64 = item.src.split(',')[1];
                    console.log('loadFromGallery: Data URL, base64 length:', state.currentImageBase64?.length);
                } else {
                    // Firebase URL - convert to base64
                    console.log('loadFromGallery: Firebase URL detected, converting to base64...');
                    showStatus('Loading image...', 'info');
                    const imageData = await getImageDataFromSource(item.src);
                    if (imageData) {
                        state.currentImageMimeType = imageData.mimeType;
                        state.currentImageBase64 = imageData.base64Data;
                        console.log('loadFromGallery: Converted to base64, length:', state.currentImageBase64?.length);
                        showStatus('Image loaded!', 'success');
                    } else {
                        console.error('loadFromGallery: Failed to convert Firebase URL to base64');
                        state.currentImageMimeType = 'image/jpeg';
                        state.currentImageBase64 = null;
                        showStatus('Warning: Could not process image for editing', 'error');
                    }
                }
            }
        }

        async function toggleFavorite(e, index) {
            e.stopPropagation();
            const item = state.gallery[index];
            item.favorite = !item.favorite;

            if (currentUser) {
                await updateImageInCloud(item.id, { favorite: item.favorite });
            } else {
                Storage.setIfOffline('gallery', state.gallery);
            }
            renderGallery();
        }

        async function deleteFromGallery(filteredIndex) {
            // Get the actual item from currentGalleryItems (which may be filtered)
            const item = state.currentGalleryItems[filteredIndex];
            if (!item) return;

            // Find this item in the full gallery array by ID
            const actualIndex = state.gallery.findIndex(g => g.id === item.id);
            if (actualIndex === -1) return;

            // Confirm deletion
            if (!confirm('Delete this image from gallery?')) return;

            // Remove from gallery
            state.gallery.splice(actualIndex, 1);

            if (currentUser) {
                // Delete from cloud
                showSyncIndicator('Deleting...');
                await deleteImageFromCloud(item.id);
                showSyncIndicator('Deleted!', false);
            } else {
                Storage.setIfOffline('gallery', state.gallery);
            }

            // Re-render with current filter
            const activeFilter = document.querySelector('.filter-btn.active')?.dataset.filter || 'all';
            renderGallery(activeFilter);

            showStatus('Image deleted from gallery', 'success');
        }

        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                renderGallery(btn.dataset.filter);
            });
        });

        // Gallery toolbar event listeners
        $('selectModeBtn').addEventListener('click', toggleSelectMode);
        $('selectAllBtn').addEventListener('click', selectAllGallery);
        $('exportSelectedBtn').addEventListener('click', openBatchExportModal);
        $('deleteSelectedBtn').addEventListener('click', deleteSelectedGalleryItems);

        async function deleteSelectedGalleryItems() {
            const count = selectedGalleryIds.size;
            if (count === 0) return;

            const confirmMsg = count === 1
                ? 'Are you sure you want to delete this image?'
                : `Are you sure you want to delete ${count} images?`;

            if (!confirm(confirmMsg)) return;

            if (currentUser) {
                showSyncIndicator(`Deleting ${count} images...`);
                // Delete from cloud
                const idsToDelete = [...selectedGalleryIds];
                for (const id of idsToDelete) {
                    await deleteImageFromCloud(id);
                }
                showSyncIndicator('Deleted!', false);
            }

            // Remove selected items from gallery
            state.gallery = state.gallery.filter(item => !selectedGalleryIds.has(item.id));
            if (!currentUser) {
                Storage.setIfOffline('gallery', state.gallery);
            }

            // Clear selection
            selectedGalleryIds.clear();

            // Exit select mode
            toggleSelectMode();

            // Re-render gallery
            const activeFilter = document.querySelector('.filter-btn.active')?.dataset.filter || 'all';
            renderGallery(activeFilter);

            showStatus(`Deleted ${count} image${count !== 1 ? 's' : ''}`, 'success');
        }

        // Batch export modal
        function openBatchExportModal() {
            const count = selectedGalleryIds.size;
            $('batchExportPreview').textContent = `${count} image${count !== 1 ? 's' : ''} selected`;
            $('batchExportModal').classList.add('active');
        }

        $('batchExportFormat').addEventListener('change', (e) => {
            // Hide quality slider for PNG (lossless)
            $('batchQualitySection').style.display = e.target.value === 'png' ? 'none' : 'block';
        });

        $('batchExportQuality').addEventListener('input', (e) => {
            $('batchQualityValue').textContent = e.target.value + '%';
        });

        $('batchExportBtn').addEventListener('click', exportSelectedAsZip);

        async function exportSelectedAsZip() {
            const format = $('batchExportFormat').value;
            const quality = parseInt($('batchExportQuality').value) / 100;
            const count = selectedGalleryIds.size;

            if (count === 0) return;

            $('batchExportBtn').disabled = true;
            $('batchExportBtn').textContent = 'Preparing...';

            try {
                const zip = new JSZip();
                const selectedItems = state.gallery.filter(item => selectedGalleryIds.has(item.id));

                let processed = 0;

                for (const item of selectedItems) {
                    processed++;
                    $('batchExportBtn').textContent = `Processing ${processed}/${count}...`;

                    // Convert image to desired format
                    const blob = await convertImageToBlob(item.src, format, quality);
                    const filename = `knappshot-${item.id}.${format === 'jpeg' ? 'jpg' : format}`;
                    zip.file(filename, blob);
                }

                $('batchExportBtn').textContent = 'Creating ZIP...';

                const zipBlob = await zip.generateAsync({
                    type: 'blob',
                    compression: 'DEFLATE',
                    compressionOptions: { level: 6 }
                });

                // Download the ZIP
                const link = document.createElement('a');
                link.href = URL.createObjectURL(zipBlob);
                link.download = `knappshot-export-${Date.now()}.zip`;
                link.click();
                URL.revokeObjectURL(link.href);

                closeModal('batchExportModal');
                showStatus(`Exported ${count} images!`, 'success');

                // Exit select mode after export
                toggleSelectMode();

            } catch (error) {
                console.error('Export error:', error);
                showStatus('Export failed: ' + error.message, 'error');
            } finally {
                $('batchExportBtn').disabled = false;
                $('batchExportBtn').textContent = 'Download ZIP';
            }
        }

        function convertImageToBlob(imageSrc, format, quality) {
            return new Promise((resolve, reject) => {
                const img = new Image();

                // Set crossOrigin for Firebase URLs to allow canvas access
                if (!imageSrc.startsWith('data:')) {
                    img.crossOrigin = 'anonymous';
                }

                img.onload = () => {
                    try {
                        const canvas = document.createElement('canvas');
                        canvas.width = img.naturalWidth || img.width;
                        canvas.height = img.naturalHeight || img.height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0);

                        let mimeType = 'image/png';
                        if (format === 'jpeg') mimeType = 'image/jpeg';
                        if (format === 'webp') mimeType = 'image/webp';

                        canvas.toBlob(
                            (blob) => {
                                if (blob) {
                                    resolve(blob);
                                } else {
                                    reject(new Error('Failed to create blob'));
                                }
                            },
                            mimeType,
                            format === 'png' ? 1 : quality
                        );
                    } catch (err) {
                        reject(err);
                    }
                };
                img.onerror = () => reject(new Error('Failed to load image'));

                // Add cache buster for Firebase URLs to avoid stale responses
                if (!imageSrc.startsWith('data:')) {
                    img.src = imageSrc + (imageSrc.includes('?') ? '&' : '?') + 't=' + Date.now();
                } else {
                    img.src = imageSrc;
                }
            });
        }

        // ========== PROMPT LIBRARY ==========
        function savePrompt() {
            const text = promptInput.value.trim();
            if (!text) return;

            if (!state.prompts.find(p => p.text === text)) {
                state.prompts.unshift({ id: Date.now(), text, date: new Date().toISOString() });
                if (state.prompts.length > 30) state.prompts.pop();
                Storage.setIfOffline('prompts', state.prompts);
            }
        }

        function renderPrompts() {
            const list = $('promptList');
            if (state.prompts.length === 0) {
                list.innerHTML = '<div class="prompt-empty"><span></span>No saved prompts yet</div>';
                return;
            }

            list.innerHTML = state.prompts.map((p, i) => `
                <div class="prompt-item" onclick="usePrompt(${i})">
                    <div class="prompt-item-text">${p.text}</div>
                    <div class="prompt-item-meta">
                        <div class="prompt-item-date">${new Date(p.date).toLocaleDateString()}</div>
                        <div class="prompt-item-actions">
                            <button onclick="event.stopPropagation(); usePrompt(${i})">Use</button>
                            <button class="delete" onclick="event.stopPropagation(); deletePrompt(${i})">Delete</button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function usePrompt(index) {
            promptInput.value = state.prompts[index].text;
            document.querySelector('[data-tab="editor"]').click();
        }

        function deletePrompt(index) {
            state.prompts.splice(index, 1);
            Storage.setIfOffline('prompts', state.prompts);
            renderPrompts();
        }

        // ========== SYSTEM INSTRUCTIONS ==========
        function saveSystemInstructions() {
            const instructions = systemInstructionsInput.value.trim();
            Storage.set('systemInstructions', instructions);

            // Sync to cloud if signed in
            if (currentUser) {
                saveSettingsToCloud({ systemInstructions: instructions });
            }

            const statusEl = $('systemStatus');
            statusEl.className = 'system-status success';
            statusEl.textContent = instructions ? 'System instructions saved!' : 'System instructions cleared!';
            setTimeout(() => { statusEl.className = 'system-status'; }, 3000);
        }

        function clearSystemInstructions() {
            systemInstructionsInput.value = '';
            Storage.set('systemInstructions', '');

            // Sync to cloud if signed in
            if (currentUser) {
                saveSettingsToCloud({ systemInstructions: '' });
            }

            const statusEl = $('systemStatus');
            statusEl.className = 'system-status success';
            statusEl.textContent = 'System instructions cleared!';
            setTimeout(() => { statusEl.className = 'system-status'; }, 3000);
        }

        // ========== IDEAS ==========
        async function getIdeas(index) {
            const apiKey = apiKeyInput.value.trim();
            if (!apiKey) { alert('Enter API key first'); return; }

            const img = state.generatedImages[index];
            if (!img) return;

            $('ideasModal').classList.add('active');
            $('ideasContainer').innerHTML = '<div class="ideas-loading"><span class="loader"></span><p>Analyzing with Gemini...</p></div>';

            try {
                const response = await fetch(`${GEMINI_FLASH}?key=${encodeURIComponent(apiKey)}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{
                            parts: [
                                { inlineData: { mimeType: img.mimeType || 'image/png', data: img.src.split(',')[1] } },
                                { text: 'Suggest 3 creative prompt ideas for further edits. Return JSON: {"ideas":[{"title":"...", "prompt":"..."}]}. Only JSON.' }
                            ]
                        }],
                        generationConfig: { temperature: 0.8 }
                    })
                });

                const data = await response.json();
                const text = data.candidates?.[0]?.content?.parts?.[0]?.text || '';
                const match = text.match(/\{[\s\S]*\}/);
                const ideas = match ? JSON.parse(match[0]).ideas : [];

                $('ideasContainer').innerHTML = ideas.map(idea => `
                    <div class="idea-card">
                        <h4>${idea.title}</h4>
                        <p>${idea.prompt}</p>
                        <button class="use-idea-btn" onclick="promptInput.value='${idea.prompt.replace(/'/g, "\\'")}'; closeModal('ideasModal');">Use This</button>
                    </div>
                `).join('') || '<p style="color:#888">No ideas generated</p>';
            } catch (e) {
                $('ideasContainer').innerHTML = '<p style="color:#fca5a5">Failed to get ideas</p>';
            }
        }

        // ========== MODALS ==========
        function closeModal(id) {
            $(id).classList.remove('active');
        }

        document.querySelectorAll('.modal').forEach(modal => {
            modal.addEventListener('click', e => {
                if (e.target === modal) closeModal(modal.id);
            });
        });

        // ========== MAIN GENERATION ==========
        submitBtn.addEventListener('click', async () => {
            const apiEndpoint = apiEndpointInput.value.trim();
            const apiKey = apiKeyInput.value.trim();
            const prompt = promptInput.value.trim();

            if (!apiEndpoint) { showStatus('Enter API endpoint', 'error'); return; }
            if (!apiKey) { showStatus('Enter API key', 'error'); return; }
            if (!prompt) { showStatus('Enter a prompt', 'error'); return; }

            const imagesToProcess = state.mode === 'batch' ? state.batchImages :
                (state.currentImageBase64 ? [{ base64: state.currentImageBase64, mimeType: state.currentImageMimeType }] : []);

            console.log('Generate: Mode:', state.mode);
            console.log('Generate: currentImageBase64 exists?', !!state.currentImageBase64, 'length:', state.currentImageBase64?.length);
            console.log('Generate: imagesToProcess count:', imagesToProcess.length);

            // Allow text-to-image generation without an input image (single mode only)
            const isTextToImage = imagesToProcess.length === 0 && state.mode === 'single';

            // Batch mode still requires images
            if (state.mode === 'batch' && imagesToProcess.length === 0) {
                showStatus('Upload images first for batch mode', 'error');
                return;
            }

            savePrompt();

            // BATCH MODE: Use queue system
            if (state.mode === 'batch' && imagesToProcess.length > 0) {
                // Add all images to queue
                for (const imgData of imagesToProcess) {
                    for (let gen = 0; gen < state.selectedGenerationCount; gen++) {
                        addToQueue(imgData.base64, imgData.mimeType, prompt);
                    }
                }

                showQueuePanel();
                showStatus(`Added ${imagesToProcess.length * state.selectedGenerationCount} items to queue`, 'success');

                // Start processing the queue
                processQueue();
                return;
            }

            // SINGLE MODE: Process immediately (existing behavior)
            submitBtn.disabled = true;
            showStatus('Processing...', 'loading');

            // Show loading indicator in result area
            resultArea.innerHTML = `
                <div class="result-loading">
                    <div class="result-loading-spinner"></div>
                    <div class="result-loading-text">Generating your image...</div>
                    <div class="result-loading-subtext">This may take a moment</div>
                </div>
            `;

            const aspectMap = { '1:1': 'square (1:1)', '16:9': 'widescreen (16:9)', '9:16': 'portrait (9:16)', '4:3': 'landscape (4:3)', '3:4': 'portrait (3:4)', '4:5': 'portrait (4:5)', '3:2': 'landscape (3:2)', '2:3': 'portrait (2:3)' };
            const resMap = { '1K': '1024px', '2K': '2048px', '4K': '4096px' };

            // Build full prompt with system instructions
            const systemInstructions = systemInstructionsInput.value.trim();
            let fullPrompt = '';
            if (systemInstructions) {
                fullPrompt = `[System Instructions: ${systemInstructions}] `;
            }

            // Add @ mention context only if mentions are used in the prompt
            const hasMentions = prompt.includes('@main-image') || prompt.includes('@reference');
            if (hasMentions) {
                let mentionContext = '[Image References: ';
                const contextParts = [];
                if (prompt.includes('@main-image')) {
                    contextParts.push('@main-image refers to the first/main uploaded image');
                }
                if (prompt.includes('@reference')) {
                    contextParts.push('@reference refers to the style reference image (second image)');
                }
                mentionContext += contextParts.join('; ') + '] ';
                fullPrompt += mentionContext;
            }

            fullPrompt += prompt;
            if (state.referenceImageBase64 && !hasMentions) fullPrompt += '. Match the style of the reference image provided.';
            fullPrompt += `. Output in ${aspectMap[state.selectedAspectRatio]} at ${resMap[state.selectedResolution]}.`;

            const allImages = [];

            try {
                // TEXT-TO-IMAGE MODE: Generate without input image
                if (isTextToImage) {
                    for (let gen = 0; gen < state.selectedGenerationCount; gen++) {
                        if (state.selectedGenerationCount > 1) {
                            showStatus(`Generating image ${gen + 1}/${state.selectedGenerationCount}...`, 'loading');
                        }

                        const parts = [];
                        if (state.referenceImageBase64) {
                            parts.push({ inlineData: { mimeType: 'image/jpeg', data: state.referenceImageBase64 } });
                        }
                        parts.push({ text: fullPrompt });

                        const response = await fetch(`${apiEndpoint}?key=${encodeURIComponent(apiKey)}`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                contents: [{ parts }],
                                generationConfig: { responseModalities: ['IMAGE', 'TEXT'] }
                            })
                        });

                        if (!response.ok) throw new Error(`API Error: ${response.status}`);

                        const data = await response.json();
                        if (data.candidates) {
                            for (const candidate of data.candidates) {
                                for (const part of candidate.content?.parts || []) {
                                    if (part.inlineData) {
                                        const mimeType = part.inlineData.mimeType || 'image/png';
                                        allImages.push({ src: `data:${mimeType};base64,${part.inlineData.data}`, mimeType });
                                    }
                                }
                            }
                        }
                    }
                } else {
                    // IMAGE-TO-IMAGE MODE: Edit existing images
                    for (let imgIndex = 0; imgIndex < imagesToProcess.length; imgIndex++) {
                        const imgData = imagesToProcess[imgIndex];

                        for (let gen = 0; gen < state.selectedGenerationCount; gen++) {
                            if (imagesToProcess.length > 1 || state.selectedGenerationCount > 1) {
                                showStatus(`Processing ${imgIndex + 1}/${imagesToProcess.length}, generation ${gen + 1}/${state.selectedGenerationCount}...`, 'loading');
                            }

                            const parts = [
                                { inlineData: { mimeType: imgData.mimeType, data: imgData.base64 } }
                            ];
                            if (state.referenceImageBase64) {
                                parts.push({ inlineData: { mimeType: 'image/jpeg', data: state.referenceImageBase64 } });
                            }
                            parts.push({ text: fullPrompt });

                            const response = await fetch(`${apiEndpoint}?key=${encodeURIComponent(apiKey)}`, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({
                                    contents: [{ parts }],
                                    generationConfig: { responseModalities: ['IMAGE', 'TEXT'] }
                                })
                            });

                            if (!response.ok) throw new Error(`API Error: ${response.status}`);

                            const data = await response.json();
                            if (data.candidates) {
                                for (const candidate of data.candidates) {
                                    for (const part of candidate.content?.parts || []) {
                                        if (part.inlineData) {
                                            const mimeType = part.inlineData.mimeType || 'image/png';
                                            allImages.push({ src: `data:${mimeType};base64,${part.inlineData.data}`, mimeType });
                                        }
                                    }
                                }
                            }
                        }
                    }
                }

                if (allImages.length > 0) {
                    displayResult(allImages);
                    showStatus(`Generated ${allImages.length} image${allImages.length > 1 ? 's' : ''}!`, 'success');
                } else {
                    showStatus('No images returned', 'error');
                    resetResultArea();
                }
            } catch (e) {
                console.error(e);
                showStatus(e.message, 'error');
                resetResultArea();
            } finally {
                submitBtn.disabled = false;
            }
        });

        // ========== KEYBOARD SHORTCUTS ==========
        document.addEventListener('keydown', e => {
            if ((e.metaKey || e.ctrlKey) && e.key === 'Enter') {
                e.preventDefault();
                submitBtn.click();
            }
            // Lightbox keyboard controls
            if ($('lightbox').classList.contains('active')) {
                if (e.key === 'Escape') closeLightbox();
                if (e.key === 'ArrowLeft') lightboxNav(-1);
                if (e.key === 'ArrowRight') lightboxNav(1);
            }
            // Collection modal escape
            if (e.key === 'Escape') {
                if ($('collectionModal').classList.contains('active')) closeCollectionModal();
                if ($('moveToCollectionModal').classList.contains('active')) closeMoveToCollectionModal();
            }
        });

        // ========== LIGHTBOX ==========
        let lightboxImages = [];
        let lightboxIndex = 0;
        let lightboxSource = 'results'; // 'results' or 'gallery'

        function openLightbox(images, index, source = 'results') {
            lightboxImages = images;
            lightboxIndex = index;
            lightboxSource = source;
            updateLightbox();
            $('lightbox').classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        // Preview a single image in lightbox
        function previewImage(src, e) {
            if (e) e.stopPropagation();
            if (!src) return;
            openLightbox([{ src }], 0, 'preview');
        }

        function closeLightbox() {
            $('lightbox').classList.remove('active');
            document.body.style.overflow = '';
        }

        function updateLightbox() {
            const img = lightboxImages[lightboxIndex];
            if (!img) return;

            $('lightboxImage').src = img.src || img;

            // Update counter
            if (lightboxImages.length > 1) {
                $('lightboxCounter').textContent = `${lightboxIndex + 1} / ${lightboxImages.length}`;
                $('lightboxCounter').style.display = 'block';
                $('lbPrev').style.display = 'flex';
                $('lbNext').style.display = 'flex';
            } else {
                $('lightboxCounter').style.display = 'none';
                $('lbPrev').style.display = 'none';
                $('lbNext').style.display = 'none';
            }

            // Update nav buttons
            $('lbPrev').disabled = lightboxIndex === 0;
            $('lbNext').disabled = lightboxIndex === lightboxImages.length - 1;
        }

        function lightboxNav(dir) {
            const newIndex = lightboxIndex + dir;
            if (newIndex >= 0 && newIndex < lightboxImages.length) {
                lightboxIndex = newIndex;
                updateLightbox();
            }
        }

        async function downloadLightboxImage() {
            const img = lightboxImages[lightboxIndex];
            const src = img.src || img;
            const filename = `knappshot-${Date.now()}.png`;

            showStatus('Preparing download...', 'info');

            try {
                // For data URLs, convert to blob and download directly
                if (src.startsWith('data:')) {
                    const response = await fetch(src);
                    const blob = await response.blob();
                    triggerDownload(blob, filename);
                    return;
                }

                // For external URLs (like Firebase Storage), fetch as blob and download
                const response = await fetch(src);
                if (!response.ok) {
                    throw new Error('Failed to fetch image');
                }
                const blob = await response.blob();
                triggerDownload(blob, filename);
                showStatus('Download started!', 'success');

            } catch (error) {
                console.error('Download error:', error);
                showStatus('Right-click the image and select "Save Image As..."', 'error');
            }
        }

        // Helper function to trigger download from blob
        function triggerDownload(blob, filename) {
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = filename;
            link.style.display = 'none';
            document.body.appendChild(link);
            link.click();

            // Cleanup after a short delay
            setTimeout(() => {
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
            }, 100);

            showStatus('Download started!', 'success');
        }

        async function editFromLightbox() {
            const img = lightboxImages[lightboxIndex];
            const src = img.src || img;

            state.currentImage = src;
            state.originalImage = src;

            // If from gallery, also load the prompt
            if (lightboxSource === 'gallery' && state.currentGalleryItems[lightboxIndex]) {
                promptInput.value = state.currentGalleryItems[lightboxIndex].prompt || '';
            }

            displayUploadedImage(src);
            closeLightbox();
            document.querySelector('[data-tab="editor"]').click();

            // Handle base64 extraction properly for both data URLs and Firebase URLs
            if (src.startsWith('data:')) {
                const mimeMatch = src.match(/^data:([^;]+);/);
                state.currentImageMimeType = mimeMatch ? mimeMatch[1] : 'image/png';
                state.currentImageBase64 = src.split(',')[1];
                console.log('editFromLightbox: Data URL, base64 length:', state.currentImageBase64?.length);
                showStatus('Image loaded for editing!', 'success');
            } else {
                // Firebase URL - convert to base64
                console.log('editFromLightbox: Firebase URL detected, converting to base64...');
                showStatus('Loading image...', 'info');
                const imageData = await getImageDataFromSource(src);
                if (imageData) {
                    state.currentImageMimeType = imageData.mimeType;
                    state.currentImageBase64 = imageData.base64Data;
                    console.log('editFromLightbox: Converted to base64, length:', state.currentImageBase64?.length);
                    showStatus('Image loaded for editing!', 'success');
                } else {
                    console.error('editFromLightbox: Failed to convert Firebase URL to base64');
                    state.currentImageMimeType = 'image/jpeg';
                    state.currentImageBase64 = null;
                    showStatus('Warning: Could not process image for editing', 'error');
                }
            }
        }

        // Close lightbox when clicking outside image
        $('lightbox').addEventListener('click', e => {
            if (e.target === $('lightbox') || e.target.classList.contains('lightbox-image-container')) {
                closeLightbox();
            }
        });

        // ========== TUTORIAL SYSTEM ==========
        const tutorialSteps = [
            {
                target: '#uploadArea',
                title: 'Upload Your Images',
                icon: '',
                description: 'Start by dragging and dropping your images here, or click to browse your files. This is where you\'ll add the photos you want to edit.',
                position: 'right',
                action: () => document.querySelector('[data-tab="editor"]')?.click()
            },
            {
                target: '.prompt-section',
                title: 'Describe Your Edit',
                icon: '',
                description: 'Tell the AI what changes you want to make. Be descriptive! Use <strong>Enhance</strong> for quick improvements or <strong>Mega Enhance</strong> for detailed, professional prompts.',
                position: 'top',
                action: () => document.querySelector('[data-tab="editor"]')?.click()
            },
            {
                target: '#modeButtons',
                title: 'Single vs Batch Mode',
                icon: '',
                description: '<strong>Single Mode:</strong> Edit one image at a time with immediate results.<br><br><strong>Batch Mode:</strong> Upload and process multiple images at once. Great for editing product photos in bulk!',
                position: 'top',
                action: () => document.querySelector('[data-tab="editor"]')?.click()
            },
            {
                target: '[data-tab="products"]',
                title: 'Product Profiles',
                icon: '',
                description: 'Create profiles for your products or brands. Add a <strong>description</strong>, <strong>golden phrases</strong> you love, and <strong>forbidden words</strong> to avoid.<br><br>When you select a product in the Editor, the AI will use this context to generate on-brand prompts every time!',
                position: 'bottom',
                action: () => document.querySelector('[data-tab="products"]')?.click()
            },
            {
                target: '[data-tab="gallery"]',
                title: 'Your Gallery',
                icon: '',
                description: 'All your finished creations are saved here. Organize them into <strong>Collections</strong>, mark favorites, and download anytime.',
                position: 'bottom',
                action: () => document.querySelector('[data-tab="gallery"]')?.click()
            },
            {
                target: '[data-tab="review"]',
                title: 'Review Tab',
                icon: '',
                description: 'When using <strong>Batch Mode</strong>, your generated images appear here first for review. Approve the ones you like to add them to your Gallery, or discard the ones you don\'t want.',
                position: 'bottom',
                action: () => document.querySelector('[data-tab="review"]')?.click()
            },
            {
                target: '[data-tab="breakdown"]',
                title: 'Image Breakdown',
                icon: '',
                description: 'Upload any image to analyze what makes it work. Great for studying successful ads or content!<br><br>You can also link a <strong>Product Profile</strong> to get a rewritten concept tailored specifically for your product.',
                position: 'bottom',
                action: () => document.querySelector('[data-tab="breakdown"]')?.click()
            },
            {
                target: '#loginBtn, .user-info',
                title: 'Cloud Sync',
                icon: '',
                description: 'Sign in to sync your gallery, collections, and settings across all your devices. Your progress is automatically saved when you\'re logged in!',
                position: 'bottom'
            },
            {
                target: null,
                title: 'You\'re All Set!',
                icon: '',
                description: 'You\'re ready to start creating! Remember, you can always click the <strong></strong> button to see this tutorial again.<br><br>Happy editing!',
                position: 'center',
                isLast: true
            }
        ];

        let currentTutorialStep = 0;
        let tutorialActive = false;

        function openTutorialStart() {
            $('tutorialStartModal').classList.add('active');
        }

        function closeTutorialStart() {
            $('tutorialStartModal').classList.remove('active');
        }

        function startTutorial() {
            closeTutorialStart();
            tutorialActive = true;
            currentTutorialStep = 0;

            // Go to editor tab first
            document.querySelector('[data-tab="editor"]')?.click();

            setTimeout(() => showTutorialStep(0), 300);
        }

        function showTutorialStep(stepIndex) {
            if (stepIndex < 0 || stepIndex >= tutorialSteps.length) {
                endTutorial();
                return;
            }

            currentTutorialStep = stepIndex;
            const step = tutorialSteps[stepIndex];
            const highlight = $('tutorialHighlight');
            const tooltip = $('tutorialTooltip');

            // Execute action if exists (like clicking a tab)
            if (step.action) {
                step.action();
            }

            // Small delay after action
            setTimeout(() => {
                let targetEl = null;
                let targetRect = null;

                if (step.target) {
                    targetEl = document.querySelector(step.target);
                    if (targetEl) {
                        targetRect = targetEl.getBoundingClientRect();
                    }
                }

                // Position highlight
                if (targetEl && targetRect) {
                    const padding = 8;
                    highlight.style.display = 'block';
                    highlight.style.top = (targetRect.top - padding + window.scrollY) + 'px';
                    highlight.style.left = (targetRect.left - padding) + 'px';
                    highlight.style.width = (targetRect.width + padding * 2) + 'px';
                    highlight.style.height = (targetRect.height + padding * 2) + 'px';
                } else {
                    highlight.style.display = 'none';
                }

                // Build tooltip content
                const stepDots = tutorialSteps.map((_, i) => {
                    let cls = 'tutorial-step-dot';
                    if (i < stepIndex) cls += ' completed';
                    else if (i === stepIndex) cls += ' active';
                    return `<div class="${cls}"></div>`;
                }).join('');

                tooltip.innerHTML = `
                    <div class="tutorial-step-indicator">${stepDots}</div>
                    <div class="tutorial-title">
                        <span class="tutorial-title-icon">${step.icon}</span>
                        ${step.title}
                    </div>
                    <div class="tutorial-description">${step.description}</div>
                    <div class="tutorial-actions">
                        <button class="tutorial-skip-btn" onclick="endTutorial()">Skip Tutorial</button>
                        <div class="tutorial-nav-btns">
                            ${stepIndex > 0 ? '<button class="tutorial-prev-btn" onclick="prevTutorialStep()">Back</button>' : ''}
                            <button class="tutorial-next-btn" onclick="nextTutorialStep()">
                                ${step.isLast ? 'Finish' : 'Next'}
                            </button>
                        </div>
                    </div>
                `;

                tooltip.style.display = 'block';

                // Position tooltip (fixed positioning - no scrollY needed)
                if (step.position === 'center' || !targetRect) {
                    tooltip.style.top = '50%';
                    tooltip.style.left = '50%';
                    tooltip.style.transform = 'translate(-50%, -50%)';
                } else {
                    tooltip.style.transform = 'none';
                    const tooltipRect = tooltip.getBoundingClientRect();
                    const viewportHeight = window.innerHeight;
                    const viewportWidth = window.innerWidth;

                    let top, left;

                    // Calculate initial position based on preference
                    switch (step.position) {
                        case 'bottom':
                            top = targetRect.bottom + 20;
                            left = targetRect.left + (targetRect.width / 2) - (tooltipRect.width / 2);
                            break;
                        case 'top':
                            top = targetRect.top - tooltipRect.height - 20;
                            left = targetRect.left + (targetRect.width / 2) - (tooltipRect.width / 2);
                            break;
                        case 'right':
                            top = targetRect.top + (targetRect.height / 2) - (tooltipRect.height / 2);
                            left = targetRect.right + 20;
                            break;
                        case 'left':
                            top = targetRect.top + (targetRect.height / 2) - (tooltipRect.height / 2);
                            left = targetRect.left - tooltipRect.width - 20;
                            break;
                    }

                    // Check if tooltip goes off bottom of screen - reposition above or to the side
                    if (top + tooltipRect.height > viewportHeight - 20) {
                        // Try above the target
                        const topAbove = targetRect.top - tooltipRect.height - 20;
                        if (topAbove >= 20) {
                            top = topAbove;
                        } else {
                            // Position to the right of the target instead
                            top = Math.min(targetRect.top, viewportHeight - tooltipRect.height - 20);
                            top = Math.max(20, top);
                            left = targetRect.right + 20;
                            // If that goes off screen too, position to left
                            if (left + tooltipRect.width > viewportWidth - 20) {
                                left = targetRect.left - tooltipRect.width - 20;
                            }
                        }
                    }

                    // Final bounds check
                    top = Math.max(20, Math.min(top, viewportHeight - tooltipRect.height - 20));
                    left = Math.max(20, Math.min(left, viewportWidth - tooltipRect.width - 20));

                    tooltip.style.top = top + 'px';
                    tooltip.style.left = left + 'px';
                }
            }, step.action ? 400 : 50);
        }

        function nextTutorialStep() {
            if (currentTutorialStep >= tutorialSteps.length - 1) {
                endTutorial();
            } else {
                showTutorialStep(currentTutorialStep + 1);
            }
        }

        function prevTutorialStep() {
            if (currentTutorialStep > 0) {
                showTutorialStep(currentTutorialStep - 1);
            }
        }

        function endTutorial() {
            tutorialActive = false;
            $('tutorialHighlight').style.display = 'none';
            $('tutorialTooltip').style.display = 'none';

            // Return to editor tab
            document.querySelector('[data-tab="editor"]')?.click();
        }

        // Tutorial button click handler
        $('tutorialBtn')?.addEventListener('click', openTutorialStart);

        // Show animation for first-time visitors
        function initTutorialAnimation() {
            const hasSeenTutorial = Storage.get('hasSeenTutorial', false);
            const tutorialBtn = $('tutorialBtn');
            if (!hasSeenTutorial && tutorialBtn) {
                tutorialBtn.classList.add('animate');
                // Stop animation after 10 seconds or when clicked
                setTimeout(() => {
                    tutorialBtn?.classList.remove('animate');
                }, 10000);
            }
        }

        // Mark tutorial as seen when started
        const originalStartTutorial = startTutorial;
        startTutorial = function() {
            Storage.set('hasSeenTutorial', true);
            $('tutorialBtn')?.classList.remove('animate');
            originalStartTutorial();
        };

        // Initialize tutorial animation
        initTutorialAnimation();

        // Escape key to cancel tutorial
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && tutorialActive) {
                endTutorial();
            }
            if (e.key === 'Escape' && $('tutorialStartModal').classList.contains('active')) {
                closeTutorialStart();
            }
        });

        // Init
        renderCollections();
        renderGallery();
        renderPrompts();

        // Theme Toggle
        function initTheme() {
            const savedTheme = localStorage.getItem('knappshot-theme');

            if (savedTheme) {
                // Use saved preference
                document.documentElement.setAttribute('data-theme', savedTheme);
            } else {
                // Auto-detect system preference on first visit
                const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                const defaultTheme = prefersDark ? 'dark' : 'light';
                document.documentElement.setAttribute('data-theme', defaultTheme);
            }

            updateThemeIcon(document.documentElement.getAttribute('data-theme'));
        }

        function toggleTheme() {
            const currentTheme = document.documentElement.getAttribute('data-theme') || 'dark';
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            document.documentElement.setAttribute('data-theme', newTheme);
            localStorage.setItem('knappshot-theme', newTheme);
            updateThemeIcon(newTheme);
        }

        function updateThemeIcon(theme) {
            const icon = document.querySelector('.theme-icon');
            if (icon) {
                icon.textContent = theme === 'dark' ? '' : '';
            }
        }

        // Initialize theme on load
        initTheme();

        // Add event listener for theme toggle
        document.getElementById('themeToggle')?.addEventListener('click', toggleTheme);

        // ========== MOBILE MENU ==========
        const mobileMenuBtn = $('mobileMenuBtn');
        const mobileMenu = $('mobileMenu');
        const mobileMenuOverlay = $('mobileMenuOverlay');
        const mobileMenuClose = $('mobileMenuClose');
        const mobileMenuContent = $('mobileMenuContent');

        function openMobileMenu() {
            mobileMenuBtn.classList.add('active');
            mobileMenu.classList.add('active');
            mobileMenuOverlay.classList.add('active');
            document.body.style.overflow = 'hidden';
            updateMobileMenuContent();
        }

        function closeMobileMenu() {
            mobileMenuBtn.classList.remove('active');
            mobileMenu.classList.remove('active');
            mobileMenuOverlay.classList.remove('active');
            document.body.style.overflow = '';
        }

        function updateMobileMenuContent() {
            const user = firebase.auth().currentUser;
            const currentTheme = document.documentElement.getAttribute('data-theme') || 'dark';
            const themeIcon = currentTheme === 'light' ? '' : '';
            const themeText = currentTheme === 'light' ? 'Dark Mode' : 'Light Mode';

            let html = '';

            if (user) {
                html += `
                    <div class="mobile-menu-user">
                        <img src="${user.photoURL || 'https://via.placeholder.com/40'}" alt="Avatar" class="mobile-menu-user-avatar">
                        <div class="mobile-menu-user-info">
                            <div class="mobile-menu-user-name">${user.displayName || 'User'}</div>
                            <div class="mobile-menu-user-email">${user.email || ''}</div>
                        </div>
                    </div>
                `;
            }

            html += `
                <button class="mobile-menu-item" onclick="mobileMenuAction('tour')">
                    <span class="mobile-menu-item-icon"></span>
                    Take a Tour
                </button>
                <button class="mobile-menu-item" onclick="mobileMenuAction('theme')">
                    <span class="mobile-menu-item-icon">${themeIcon}</span>
                    ${themeText}
                </button>
                <button class="mobile-menu-item" onclick="mobileMenuAction('notifications')">
                    <span class="mobile-menu-item-icon"></span>
                    Notifications
                </button>
                <div class="mobile-menu-divider"></div>
            `;

            if (user) {
                html += `
                    <button class="mobile-menu-item" onclick="mobileMenuAction('signout')">
                        <span class="mobile-menu-item-icon"></span>
                        Sign Out
                    </button>
                `;
            } else {
                html += `
                    <button class="mobile-menu-item primary" onclick="mobileMenuAction('signin')">
                        <span class="mobile-menu-item-icon"></span>
                        Sign in with Google
                    </button>
                `;
            }

            mobileMenuContent.innerHTML = html;
        }

        function mobileMenuAction(action) {
            closeMobileMenu();
            setTimeout(() => {
                switch(action) {
                    case 'tour':
                        startTutorial();
                        break;
                    case 'theme':
                        toggleTheme();
                        break;
                    case 'notifications':
                        $('notificationDropdown')?.classList.toggle('show');
                        break;
                    case 'signin':
                        signInWithGoogle();
                        break;
                    case 'signout':
                        signOut();
                        break;
                }
            }, 300);
        }

        mobileMenuBtn?.addEventListener('click', openMobileMenu);
        mobileMenuClose?.addEventListener('click', closeMobileMenu);
        mobileMenuOverlay?.addEventListener('click', closeMobileMenu);

        // Credentials Management
        const credentialsStatus = $('credentialsStatus');

        function showCredentialsStatus(message, isError = false) {
            credentialsStatus.textContent = message;
            credentialsStatus.style.color = isError ? 'var(--color-red-light)' : 'var(--color-green-light)';
            credentialsStatus.classList.add('show');
            setTimeout(() => credentialsStatus.classList.remove('show'), 3000);
        }

        async function saveCredentials() {
            const key = apiKeyInput.value.trim();

            if (!key) {
                showCredentialsStatus('Please enter an API key', true);
                return;
            }

            Storage.set('apiKey', key);
            if (currentUser) {
                await saveSettingsToCloud({ apiKey: key });
                showCredentialsStatus('API key saved to cloud!');
            } else {
                showCredentialsStatus('API key saved locally!');
            }
        }

        function loadCredentials() {
            const key = Storage.get('apiKey', '');

            if (!key) {
                showCredentialsStatus('No saved API key found', true);
                return;
            }

            apiKeyInput.value = key;
            showCredentialsStatus('API key loaded!');
        }

        function clearFields() {
            apiKeyInput.value = '';
            showCredentialsStatus('Field cleared');
        }

        async function deleteSavedCredentials() {
            Storage.set('apiKey', '');
            if (currentUser) {
                await saveSettingsToCloud({ apiKey: '' });
                showCredentialsStatus('API key deleted from cloud');
            } else {
                showCredentialsStatus('Saved API key deleted');
            }
        }

        // Event listeners for credential buttons
        $('saveCredentials')?.addEventListener('click', saveCredentials);
        $('loadCredentials')?.addEventListener('click', loadCredentials);
        $('clearFields')?.addEventListener('click', clearFields);
        $('deleteSaved')?.addEventListener('click', deleteSavedCredentials);

        // Welcome banner for first-time users
        function updateWelcomeBanner() {
            const banner = $('welcomeBanner');
            const hasKey = apiKeyInput.value.trim() !== '';
            const dismissed = Storage.get('welcomeDismissed', false);
            if (!hasKey && !dismissed) {
                banner.classList.add('show');
            } else {
                banner.classList.remove('show');
            }
        }

        $('dismissWelcome')?.addEventListener('click', () => {
            Storage.set('welcomeDismissed', true);
            $('welcomeBanner').classList.remove('show');
        });

        // Update banner when API key changes
        apiKeyInput.addEventListener('input', updateWelcomeBanner);

        // Show banner on load if no API key
        updateWelcomeBanner();

        // ========== PRODUCTS TAB ==========
        // Products state is already initialized in the state object above

        let editingProductId = null;

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function renderProducts() {
            const list = $('productsList');
            if (!list) return;

            if (state.products.length === 0) {
                list.innerHTML = `<div class="products-empty">
                    <span></span>
                    No products yet. Add your first product profile!
                </div>`;
                return;
            }

            list.innerHTML = state.products.map(p => `
                <div class="product-item ${p.id === state.activeProductId ? 'active' : ''}">
                    <div class="product-item-header">
                        <div class="product-item-name">${escapeHtml(p.name)}</div>
                        ${p.id === state.activeProductId ? '<span class="product-item-active-badge">Active</span>' : ''}
                    </div>
                    <div class="product-item-description">${escapeHtml(p.description || '').substring(0, 150)}${(p.description || '').length > 150 ? '...' : ''}</div>
                    <div class="product-item-tags">
                        ${(p.goldenPhrases || []).slice(0, 2).map(phrase =>
                            `<span class="product-tag golden"> ${escapeHtml(phrase.substring(0, 30))}${phrase.length > 30 ? '...' : ''}</span>`
                        ).join('')}
                        ${(p.forbiddenWords || []).slice(0, 3).map(word =>
                            `<span class="product-tag forbidden"> ${escapeHtml(word)}</span>`
                        ).join('')}
                    </div>
                    <div class="product-item-actions">
                        ${p.id !== state.activeProductId ?
                            `<button class="activate" onclick="setActiveProduct(${p.id})">Set Active</button>` :
                            `<button onclick="setActiveProduct(null)">Deactivate</button>`
                        }
                        <button onclick="editProduct(${p.id})">Edit</button>
                        <button onclick="duplicateProduct(${p.id})">Duplicate</button>
                        <button class="delete" onclick="deleteProduct(${p.id})">Delete</button>
                    </div>
                </div>
            `).join('');
        }

        function openProductModal(productId = null) {
            editingProductId = productId;
            const product = productId ? state.products.find(p => p.id === productId) : null;

            $('productModalTitle').textContent = product ? 'Edit Product Profile' : 'Add Product Profile';
            $('productName').value = product?.name || '';
            $('productDescription').value = product?.description || '';
            $('productGoldenPhrases').value = (product?.goldenPhrases || []).join('\n');
            $('productForbiddenWords').value = (product?.forbiddenWords || []).join(', ');

            // Reset image upload
            const uploadArea = $('productImageUpload');
            if (product?.referenceImage) {
                uploadArea.innerHTML = `<img src="${product.referenceImage}" alt="Reference" class="preview-image" style="cursor: zoom-in;" title="Click to preview">`;
            } else {
                uploadArea.innerHTML = '<span>Click to upload reference image</span>';
            }

            $('productModal').classList.add('active');
        }

        async function saveProduct() {
            const name = $('productName').value.trim();
            const description = $('productDescription').value.trim();
            const goldenPhrases = $('productGoldenPhrases').value.split('\n').map(s => s.trim()).filter(Boolean);
            const forbiddenWords = $('productForbiddenWords').value.split(',').map(s => s.trim()).filter(Boolean);

            // Get reference image from upload area (if newly uploaded) or keep existing
            const uploadArea = $('productImageUpload');
            const newImageData = uploadArea.dataset.imageData;

            if (!name) {
                alert('Please enter a product name');
                return;
            }

            // Show saving state
            const saveBtn = $('saveProductBtn');
            const originalBtnText = saveBtn.textContent;
            saveBtn.textContent = 'Saving...';
            saveBtn.disabled = true;

            if (editingProductId) {
                // Update existing
                const index = state.products.findIndex(p => p.id === editingProductId);
                if (index !== -1) {
                    const existingImage = state.products[index].referenceImage;
                    state.products[index] = {
                        ...state.products[index],
                        name,
                        description,
                        goldenPhrases,
                        forbiddenWords,
                        // Use new image if uploaded, otherwise keep existing
                        referenceImage: newImageData || existingImage || null
                    };
                }
            } else {
                // Add new
                state.products.push({
                    id: Date.now(),
                    name,
                    description,
                    goldenPhrases,
                    forbiddenWords,
                    referenceImage: newImageData || null,
                    createdAt: new Date().toISOString()
                });
            }

            const saved = Storage.setIfOffline('products', state.products);
            if (!saved) {
                console.log('Could not save to localStorage, will save to cloud');
            }

            // Sync to cloud if signed in - WAIT for it to complete
            if (currentUser) {
                try {
                    await saveProductsToCloud();
                    console.log('Products saved to cloud successfully');
                } catch (err) {
                    console.error('Failed to save products to cloud:', err);
                    alert('Failed to save product to cloud. Please try again.');
                    // Re-enable button so user can retry
                    saveBtn.textContent = originalBtnText;
                    saveBtn.disabled = false;
                    return;
                }
            }

            // Success - close modal and update UI
            saveBtn.textContent = originalBtnText;
            saveBtn.disabled = false;
            closeModal('productModal');
            renderProducts();
            updateProductSelect();
        }

        function editProduct(id) {
            openProductModal(id);
        }

        function duplicateProduct(id) {
            const original = state.products.find(p => p.id === id);
            if (!original) return;

            const duplicate = {
                id: Date.now(),
                name: `${original.name} (Copy)`,
                description: original.description || '',
                goldenPhrases: [...(original.goldenPhrases || [])],
                forbiddenWords: [...(original.forbiddenWords || [])],
                referenceImage: original.referenceImage || null
            };

            state.products.push(duplicate);

            // Sync to cloud if signed in
            if (currentUser) {
                saveProductsToCloud();
            }

            Storage.setIfOffline('products', state.products);
            renderProducts();
            updateProductSelect();
            showStatus(`Duplicated "${original.name}"`, 'success');
        }

        function deleteProduct(id) {
            if (!confirm('Delete this product profile?')) return;

            state.products = state.products.filter(p => p.id !== id);
            if (state.activeProductId === id) {
                state.activeProductId = null;
                Storage.setIfOffline('activeProductId', null);
            }

            // Sync to cloud if signed in
            if (currentUser) {
                saveProductsToCloud();
            }

            Storage.setIfOffline('products', state.products);
            renderProducts();
            updateProductSelect();
        }

        function setActiveProduct(id) {
            state.activeProductId = id;
            Storage.setIfOffline('activeProductId', id);
            // Sync to cloud if signed in
            if (currentUser) {
                saveSettingsToCloud({ activeProductId: id });
            }
            renderProducts();
            updateProductSelect();
        }

        // Product image upload handler (label handles click natively via for="productImageInput")
        $('productImageInput')?.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (file) {
                const result = await processImageFile(file);
                if (result) {
                    const uploadArea = $('productImageUpload');
                    uploadArea.innerHTML = `<img src="${result.dataUrl}" alt="Reference" class="preview-image" style="cursor: zoom-in;" title="Click to preview">`;
                    // Store temporarily for saving
                    uploadArea.dataset.imageData = result.dataUrl;
                    showStatus('Product image loaded!', 'success');
                }
            }
        });

        // Product event listeners
        $('addProductBtn')?.addEventListener('click', () => openProductModal());
        $('saveProductBtn')?.addEventListener('click', saveProduct);

        // ========== EDITOR PRODUCT IMAGE LOADER ==========
        function updateEditorProductSelect() {
            const select = $('editorProductSelect');
            if (!select) return;

            // Only show products that have a reference image
            const productsWithImages = state.products.filter(p => p.referenceImage);

            select.innerHTML = '<option value="">-- Select a product --</option>' +
                productsWithImages.map(p =>
                    `<option value="${p.id}">${escapeHtml(p.name)}</option>`
                ).join('');

            // Show/hide the loader based on whether there are products with images
            const loader = select.closest('.product-image-loader');
            if (loader) {
                loader.style.display = productsWithImages.length > 0 ? 'block' : 'none';
            }
        }

        $('editorProductSelect')?.addEventListener('change', async (e) => {
            const productId = e.target.value ? parseInt(e.target.value) : null;

            // If cleared, unset the active product for editor
            if (!productId) {
                state.activeProductId = null;
                return;
            }

            const product = state.products.find(p => p.id === productId);
            if (product && product.referenceImage) {
                // Set the active product ID so Mega Prompt and Enhance can use it
                state.activeProductId = productId;

                // Display the image immediately (works with both URL and data URL)
                displayUploadedImage(product.referenceImage);
                state.currentImage = product.referenceImage;
                state.originalImage = product.referenceImage;

                // If it's already a base64 data URL, extract the data directly
                if (product.referenceImage.startsWith('data:')) {
                    const mimeMatch = product.referenceImage.match(/^data:([^;]+);/);
                    state.currentImageMimeType = mimeMatch ? mimeMatch[1] : 'image/jpeg';
                    state.currentImageBase64 = product.referenceImage.split(',')[1];
                    showStatus(`Loaded "${product.name}" - product profile active`, 'success');
                } else {
                    // It's a URL - try to get base64 data in background, but don't block
                    showStatus(`Loaded "${product.name}" - product profile active`, 'success');

                    // Try to pre-cache the image data for API calls
                    getImageDataFromSource(product.referenceImage).then(imageData => {
                        if (imageData) {
                            state.currentImageBase64 = imageData.base64Data;
                            state.currentImageMimeType = imageData.mimeType;
                            console.log('Product image data cached for API calls');
                        } else {
                            console.log('Could not pre-cache image data - will fetch when needed');
                        }
                    });
                }

                // Keep the product selected (don't reset) so user sees which product is active
            }
        });

        // Update editor product select when products change
        const originalRenderProducts = renderProducts;
        renderProducts = function() {
            originalRenderProducts();
            updateEditorProductSelect();
        };

        // Initialize editor product select
        updateEditorProductSelect();

        // ========== PROMPT GENERATOR TAB ==========
        let promptGenSettings = {
            count: 3,
            style: ''  // Empty = "Not sure" (optional)
        };

        function updateProductSelect() {
            const select = $('promptgenProductSelect');
            if (!select) return;

            select.innerHTML = '<option value="">-- No product selected --</option>' +
                state.products.map(p =>
                    `<option value="${p.id}" ${p.id === state.activeProductId ? 'selected' : ''}>${escapeHtml(p.name)}</option>`
                ).join('');

            updateProductPreview();
        }

        function updateProductPreview() {
            const preview = $('activeProductPreview');
            if (!preview) return;

            const product = state.products.find(p => p.id === state.activeProductId);

            if (product) {
                preview.innerHTML = `
                    <strong>${escapeHtml(product.name)}</strong><br>
                    <small>Golden phrases: ${(product.goldenPhrases || []).length} | Forbidden words: ${(product.forbiddenWords || []).length}</small>
                `;
                preview.classList.add('show');
            } else {
                preview.classList.remove('show');
            }
        }

        // Model configuration mapping
        const promptGenModels = {
            'pro': {
                endpoint: 'https://generativelanguage.googleapis.com/v1beta/models/gemini-3-pro-preview:generateContent',
                thinking: null
            },
            'pro-thinking-low': {
                endpoint: 'https://generativelanguage.googleapis.com/v1beta/models/gemini-3-pro-preview:generateContent',
                thinking: 'low'
            },
            'pro-thinking-high': {
                endpoint: 'https://generativelanguage.googleapis.com/v1beta/models/gemini-3-pro-preview:generateContent',
                thinking: 'high'
            },
            'flash': {
                endpoint: 'https://generativelanguage.googleapis.com/v1beta/models/gemini-3-flash-preview:generateContent',
                thinking: null
            },
            'flash-thinking-minimal': {
                endpoint: 'https://generativelanguage.googleapis.com/v1beta/models/gemini-3-flash-preview:generateContent',
                thinking: 'minimal'
            },
            'flash-thinking-low': {
                endpoint: 'https://generativelanguage.googleapis.com/v1beta/models/gemini-3-flash-preview:generateContent',
                thinking: 'low'
            },
            'flash-thinking-medium': {
                endpoint: 'https://generativelanguage.googleapis.com/v1beta/models/gemini-3-flash-preview:generateContent',
                thinking: 'medium'
            },
            'flash-thinking-high': {
                endpoint: 'https://generativelanguage.googleapis.com/v1beta/models/gemini-3-flash-preview:generateContent',
                thinking: 'high'
            }
        };

        async function generatePrompts() {
            const idea = $('promptgenIdea').value.trim();
            const product = state.products.find(p => p.id === state.activeProductId);

            if (!idea) {
                showPromptgenStatus('Please describe your idea', 'error');
                return;
            }

            const apiKey = $('apiKey').value.trim();

            if (!apiKey) {
                showPromptgenStatus('Please configure your API key in the Editor tab', 'error');
                return;
            }

            // Get selected model
            const selectedModel = $('promptgenModelSelect').value;
            const modelConfig = promptGenModels[selectedModel] || promptGenModels['pro'];

            showPromptgenStatus('Generating prompts...', 'loading');
            $('generatePromptsBtn').disabled = true;

            // Check if product has a reference image
            const hasProductImage = product && product.referenceImage;

            // Build the prompt for Gemini - MEGA PROMPT MODE
            let systemContext = `You are an elite prompt engineer specializing in AI image generation. Your task is to transform simple ideas into comprehensive, highly-detailed "mega prompts" that produce stunning, professional-quality results.

CRITICAL: Each prompt MUST be 500-800 characters long. This is non-negotiable.

Your mega prompts must deeply analyze the user's intent and expand upon it with:
- VISUAL COMPOSITION: Camera angle, framing, depth of field, focal length (e.g., "shot with 85mm lens at f/1.8"), perspective
- LIGHTING MASTERY: Light source direction, quality (soft/hard), color temperature, shadows, highlights, rim lighting, ambient fill
- ATMOSPHERE & MOOD: Emotional tone, time of day, weather/environmental conditions, overall vibe
- SURFACE & TEXTURE: Material properties, reflections, refractions, surface finishes, tactile qualities
- COLOR PALETTE: Dominant colors, complementary accents, color grading style, contrast levels
- ENVIRONMENT & CONTEXT: Background elements, setting details, spatial relationships, depth layers
- STYLE REFERENCES: Photography style (editorial, commercial, artistic), post-processing aesthetic

Think deeply about what the user REALLY wants to achieve. Read between the lines. Anticipate their vision and elevate it.`;

            if (hasProductImage) {
                systemContext += `\n\nREFERENCE IMAGE PROVIDED - CRITICAL ANALYSIS REQUIRED:
Study the attached product image meticulously:
- Exact physical characteristics: shape, proportions, materials, colors, textures, finishes
- Unique identifying features, branding elements, surface details
- How light currently interacts with the product surfaces
- Any reflective, matte, glossy, or translucent properties

Your mega prompts MUST accurately represent THIS exact product with photorealistic precision.`;
            }

            if (product) {
                systemContext += `\n\nPRODUCT INTELLIGENCE:
- Product: ${product.name}
- Description: ${product.description || 'Not specified'}
${(product.goldenPhrases || []).length ? `- MANDATORY PHRASES (weave naturally into EVERY prompt): "${product.goldenPhrases.join('", "')}"` : ''}
${(product.forbiddenWords || []).length ? `- FORBIDDEN TERMS (never use): ${product.forbiddenWords.join(', ')}` : ''}`;
            }

            if (promptGenSettings.style) {
                const styleGuides = {
                    'product': 'Focus on clean, commercial product photography - studio lighting, neutral backgrounds, sharp focus on product details, e-commerce ready aesthetic',
                    'lifestyle': 'Focus on contextual, aspirational scenes - product in natural use, environmental storytelling, emotional connection, real-world settings',
                    'artistic': 'Focus on creative, avant-garde compositions - experimental lighting, dramatic angles, abstract elements, gallery-worthy aesthetic'
                };
                systemContext += `\n\nSTYLE DIRECTION: ${promptGenSettings.style.toUpperCase()}
${styleGuides[promptGenSettings.style] || ''}`;
            }

            systemContext += `\n\nUSER'S VISION: "${idea}"

Now, deeply contemplate this idea. What is the user truly envisioning? What would make this image extraordinary?

Generate exactly ${promptGenSettings.count} MEGA PROMPTS. Each must be:
- 500-800 characters (this is REQUIRED - count carefully)
- A single, flowing paragraph (no line breaks within the prompt)
- Rich with specific, evocative details
- Professional and technically precise
${hasProductImage ? '- Accurately reflecting the actual product from the reference image' : ''}

Return ONLY the numbered prompts (1-${promptGenSettings.count}), each on its own line. No explanations, no headers, just the mega prompts.`;

            // Build request parts - include image if product has one
            const parts = [];

            if (hasProductImage) {
                // Add the product reference image for visual analysis
                const productImageData = await getImageDataFromSource(product.referenceImage);
                if (productImageData) {
                    parts.push({
                        inlineData: {
                            mimeType: productImageData.mimeType,
                            data: productImageData.base64Data
                        }
                    });
                }
            }

            // Add the text prompt
            parts.push({ text: systemContext });

            // Build request body - increased tokens for mega prompts
            const requestBody = {
                contents: [{ parts: parts }],
                generationConfig: {
                    temperature: 0.9,
                    maxOutputTokens: 4096
                }
            };

            // Add thinking_config if using a thinking model
            if (modelConfig.thinking) {
                requestBody.generationConfig.thinking_config = {
                    thinking_budget: modelConfig.thinking
                };
            }

            try {
                const response = await fetch(modelConfig.endpoint + '?key=' + apiKey, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody)
                });

                const data = await response.json();

                if (data.error) {
                    throw new Error(data.error.message || 'API error');
                }

                const text = data.candidates?.[0]?.content?.parts?.[0]?.text || '';
                const prompts = parseGeneratedPrompts(text);

                if (prompts.length === 0) {
                    throw new Error('No prompts generated');
                }

                displayGeneratedPrompts(prompts);
                showPromptgenStatus('', '');

            } catch (error) {
                showPromptgenStatus('Error: ' + error.message, 'error');
            } finally {
                $('generatePromptsBtn').disabled = false;
            }
        }

        function parseGeneratedPrompts(text) {
            // Parse numbered prompts from the response
            const lines = text.split('\n').filter(line => line.trim());
            const prompts = [];

            for (const line of lines) {
                // Remove numbering like "1.", "1)", "1:", etc.
                const cleaned = line.replace(/^\d+[\.\)\:]\s*/, '').trim();
                if (cleaned.length > 20) {
                    prompts.push(cleaned);
                }
            }

            return prompts;
        }

        function displayGeneratedPrompts(prompts) {
            const container = $('generatedPrompts');
            if (!container) return;

            // Prepend new prompts to existing ones (newest first)
            state.generatedPrompts = [...prompts, ...state.generatedPrompts];

            container.innerHTML = `
                <div class="generated-prompts-header">Generated Prompts</div>
                ${state.generatedPrompts.map((prompt, i) => `
                    <div class="generated-prompt-item">
                        <div class="generated-prompt-text">${escapeHtml(prompt)}</div>
                        <div class="generated-prompt-actions">
                            <button class="use-btn" onclick="useGeneratedPrompt(${i})">Use This Prompt</button>
                            <button class="copy-btn" onclick="copyPrompt(${i})">Copy</button>
                        </div>
                    </div>
                `).join('')}
            `;
        }

        function useGeneratedPrompt(index) {
            const prompt = state.generatedPrompts[index];
            if (prompt) {
                $('promptInput').value = prompt;
                document.querySelector('[data-tab="editor"]').click();
                showStatus('Prompt loaded! Ready to generate.', 'success');
            }
        }

        function copyPrompt(index) {
            const prompt = state.generatedPrompts[index];
            navigator.clipboard.writeText(prompt).then(() => {
                showPromptgenStatus('Copied to clipboard!', 'success');
                setTimeout(() => showPromptgenStatus('', ''), 2000);
            });
        }

        function showPromptgenStatus(message, type) {
            const status = $('promptgenStatus');
            if (!status) return;
            status.className = 'status' + (type ? ' ' + type : '');
            status.innerHTML = type === 'loading' ? '<span class="loader"></span>' + message : message;
        }

        // ========== MEGA PROMPT FEATURE ==========
        // System prompt for Structured Contextual Expansion
        const MEGA_PROMPT_SYSTEM = `You are an expert Creative Director and Prompt Engineer specializing in AI image generation. Your role is to transform simple user inputs into comprehensive, strategically-structured prompts using Structured Contextual Expansion.

## Your Task
Analyze the user's short input and infer the missing artistic, technical, and contextual details that would elevate the image. Think deeply about what they're really trying to achieve.

## Analysis Framework
For any input, consider:
- What is the marketing or creative context?
- What specific visual elements are implied but not stated?
- What emotional response should the image evoke?
- What technical specifications would best serve this vision?
- What common mistakes should be avoided?

## Output Format
You MUST structure your response using these exact Markdown headers:

## Situation
The marketing context, scenario, or use-case for this image. Where will it be used? What campaign or purpose does it serve? (1-2 sentences)

## Task
A direct, clear description of the primary subject and what it should be doing or how it should appear. (1-2 sentences)

## Objective
The emotional or psychological goal of the image. What feeling should viewers experience? What action or perception should it drive? (1-2 sentences)

## Visual Knowledge
A bulleted list of specific technical and artistic details:
- **Lighting**: Type, direction, quality, color temperature
- **Composition**: Framing, rule of thirds, leading lines, negative space
- **Texture & Materials**: Surface qualities, material properties, tactile elements
- **Color Palette**: Dominant colors, accents, mood colors
- **Camera Angle**: POV, height, distance, lens perspective
- **Depth of Field**: Focus area, bokeh quality, sharpness zones
- **Environment**: Background elements, atmospheric conditions, setting details

## Negative Constraints
A bulleted list of what to explicitly AVOID:
- Visual elements that would undermine the goal
- Technical mistakes common in this type of image
- Stylistic choices that conflict with the objective
- Distracting or inappropriate elements

## Tech Specs
- **Aspect Ratio**: Recommended ratio with reasoning (e.g., "16:9 for cinematic feel" or "1:1 for social media")
- **Camera/Lens**: Suggested camera model or lens type that would capture this look (e.g., "Sony A7R IV with 85mm f/1.4" or "iPhone 15 Pro for authentic UGC feel")
- **Style Reference**: Photography style or aesthetic reference (e.g., "Apple product photography" or "National Geographic editorial")

## Important Rules
1. Be specific and actionable - avoid vague descriptors
2. Infer details the user likely wants but didn't specify
3. Consider the end use-case to inform all decisions
4. Balance artistic vision with practical execution
5. Each section should add unique, non-redundant information`;

        async function generateMegaPrompt() {
            const idea = $('promptgenIdea').value.trim();
            const product = state.products.find(p => p.id === state.activeProductId);

            if (!idea) {
                showPromptgenStatus('Please describe your idea', 'error');
                return;
            }

            const apiKey = $('apiKey').value.trim();

            if (!apiKey) {
                showPromptgenStatus('Please configure your API key in the Editor tab', 'error');
                return;
            }

            // Get selected model
            const selectedModel = $('promptgenModelSelect').value;
            const modelConfig = promptGenModels[selectedModel] || promptGenModels['pro'];

            showPromptgenStatus('Generating Mega Prompt...', 'loading');
            $('generateMegaPromptBtn').disabled = true;
            $('generatePromptsBtn').disabled = true;

            // Check if product has a reference image
            const hasProductImage = product && product.referenceImage;

            // Build the user message with context
            let userMessage = `INPUT: "${idea}"`;

            if (product) {
                userMessage += `\n\nPRODUCT PROFILE REQUIREMENTS:
- Product Name: ${product.name}
- Description: ${product.description || 'Not specified'}`;
                if ((product.goldenPhrases || []).length) {
                    userMessage += `\n- MANDATORY PHRASES (you MUST weave these naturally into the prompt): "${product.goldenPhrases.join('", "')}"`;
                }
                if ((product.forbiddenWords || []).length) {
                    userMessage += `\n- FORBIDDEN TERMS (NEVER use these words): ${product.forbiddenWords.join(', ')}`;
                }
                userMessage += `\n\nCRITICAL: The generated Mega Prompt must strictly follow these product requirements.`;
            }

            if (promptGenSettings.style) {
                const styleDescriptions = {
                    'product': 'Clean, commercial product photography style',
                    'lifestyle': 'Contextual, aspirational lifestyle imagery',
                    'artistic': 'Creative, avant-garde artistic composition'
                };
                userMessage += `\n\nSTYLE PREFERENCE: ${styleDescriptions[promptGenSettings.style] || promptGenSettings.style}`;
            }

            userMessage += `\n\nPlease analyze this input and generate a comprehensive Mega Prompt using the Structured Contextual Expansion framework.`;

            // Build request parts
            const parts = [];

            if (hasProductImage) {
                const productImageData = await getImageDataFromSource(product.referenceImage);
                if (productImageData) {
                    parts.push({
                        inlineData: {
                            mimeType: productImageData.mimeType,
                            data: productImageData.base64Data
                        }
                    });
                    userMessage += `\n\n[A reference image of the product is attached - use it to inform accurate visual details]`;
                }
            }

            parts.push({ text: userMessage });

            // Build request body
            const requestBody = {
                contents: [
                    {
                        role: 'user',
                        parts: [{ text: MEGA_PROMPT_SYSTEM }]
                    },
                    {
                        role: 'model',
                        parts: [{ text: 'I understand. I will analyze inputs using Structured Contextual Expansion and output comprehensive prompts using the exact Markdown format specified: Situation, Task, Objective, Visual Knowledge, Negative Constraints, and Tech Specs. I will be specific, infer missing details, and provide actionable guidance.' }]
                    },
                    {
                        role: 'user',
                        parts: parts
                    }
                ],
                generationConfig: {
                    temperature: 0.8,
                    maxOutputTokens: 4096
                }
            };

            // Add thinking_config if using a thinking model
            if (modelConfig.thinking) {
                requestBody.generationConfig.thinking_config = {
                    thinking_budget: modelConfig.thinking
                };
            }

            try {
                const response = await fetch(modelConfig.endpoint + '?key=' + apiKey, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody)
                });

                const data = await response.json();

                if (data.error) {
                    throw new Error(data.error.message || 'API error');
                }

                const text = data.candidates?.[0]?.content?.parts?.[0]?.text || '';

                if (!text) {
                    throw new Error('No response generated');
                }

                // Store and display the mega prompt
                state.currentMegaPrompt = text;
                displayMegaPrompt(text);
                showPromptgenStatus('', '');

            } catch (error) {
                showPromptgenStatus('Error: ' + error.message, 'error');
            } finally {
                $('generateMegaPromptBtn').disabled = false;
                $('generatePromptsBtn').disabled = false;
            }
        }

        function parseMegaPrompt(text) {
            const sections = {
                situation: '',
                task: '',
                objective: '',
                visual: '',
                negative: '',
                tech: ''
            };

            // Extract each section using regex
            const situationMatch = text.match(/## Situation\s*\n([\s\S]*?)(?=## Task|$)/i);
            const taskMatch = text.match(/## Task\s*\n([\s\S]*?)(?=## Objective|$)/i);
            const objectiveMatch = text.match(/## Objective\s*\n([\s\S]*?)(?=## Visual Knowledge|$)/i);
            const visualMatch = text.match(/## Visual Knowledge\s*\n([\s\S]*?)(?=## Negative Constraints|$)/i);
            const negativeMatch = text.match(/## Negative Constraints\s*\n([\s\S]*?)(?=## Tech Specs|$)/i);
            const techMatch = text.match(/## Tech Specs\s*\n([\s\S]*?)$/i);

            if (situationMatch) sections.situation = situationMatch[1].trim();
            if (taskMatch) sections.task = taskMatch[1].trim();
            if (objectiveMatch) sections.objective = objectiveMatch[1].trim();
            if (visualMatch) sections.visual = visualMatch[1].trim();
            if (negativeMatch) sections.negative = negativeMatch[1].trim();
            if (techMatch) sections.tech = techMatch[1].trim();

            return sections;
        }

        function formatSectionContent(content, isList = false) {
            if (isList) {
                // Format as bullet list
                const items = content.split('\n')
                    .map(line => line.replace(/^[-*]\s*/, '').trim())
                    .filter(line => line.length > 0);
                return `<ul>${items.map(item => `<li>${escapeHtml(item)}</li>`).join('')}</ul>`;
            }
            return `<p>${escapeHtml(content)}</p>`;
        }

        function displayMegaPrompt(text) {
            const container = $('megaPromptOutput');
            if (!container) return;

            const sections = parseMegaPrompt(text);

            container.innerHTML = `
                <div class="mega-prompt-output-header">
                    <h4>Structured Mega Prompt</h4>
                    <div class="mega-prompt-actions">
                        <button class="use-mega-btn" onclick="useMegaPrompt()">Use as Prompt</button>
                        <button onclick="copyMegaPrompt()">Copy All</button>
                        <button onclick="copyMegaPromptCompiled()">Copy Compiled</button>
                    </div>
                </div>

                ${sections.situation ? `
                <div class="mega-prompt-section">
                    <h5 class="situation">Situation</h5>
                    ${formatSectionContent(sections.situation)}
                </div>` : ''}

                ${sections.task ? `
                <div class="mega-prompt-section">
                    <h5 class="task">Task</h5>
                    ${formatSectionContent(sections.task)}
                </div>` : ''}

                ${sections.objective ? `
                <div class="mega-prompt-section">
                    <h5 class="objective">Objective</h5>
                    ${formatSectionContent(sections.objective)}
                </div>` : ''}

                ${sections.visual ? `
                <div class="mega-prompt-section">
                    <h5 class="visual">Visual Knowledge</h5>
                    ${formatSectionContent(sections.visual, true)}
                </div>` : ''}

                ${sections.negative ? `
                <div class="mega-prompt-section">
                    <h5 class="negative">Negative Constraints</h5>
                    ${formatSectionContent(sections.negative, true)}
                </div>` : ''}

                ${sections.tech ? `
                <div class="mega-prompt-section">
                    <h5 class="tech">Tech Specs</h5>
                    ${formatSectionContent(sections.tech, true)}
                </div>` : ''}
            `;

            container.classList.add('show');
        }

        function compileMegaPromptToSinglePrompt() {
            if (!state.currentMegaPrompt) return '';

            const sections = parseMegaPrompt(state.currentMegaPrompt);

            // Compile into a flowing prompt
            let compiled = '';

            if (sections.task) {
                compiled += sections.task.replace(/\n/g, ' ').trim();
            }

            if (sections.visual) {
                const visualItems = sections.visual.split('\n')
                    .map(line => line.replace(/^[-*]\s*/, '').replace(/\*\*[^*]+\*\*:\s*/g, '').trim())
                    .filter(line => line.length > 0);
                compiled += ' ' + visualItems.join(', ');
            }

            if (sections.situation) {
                compiled += ' Context: ' + sections.situation.replace(/\n/g, ' ').trim();
            }

            if (sections.objective) {
                compiled += ' Goal: ' + sections.objective.replace(/\n/g, ' ').trim();
            }

            return compiled.trim();
        }

        function useMegaPrompt() {
            // Use the full structured mega prompt to preserve formatting
            if (state.currentMegaPrompt) {
                $('promptInput').value = state.currentMegaPrompt;
                document.querySelector('[data-tab="editor"]').click();
                showStatus('Mega Prompt loaded! Ready to generate.', 'success');
                // Auto-resize the textarea to fit content
                autoResizePromptInput();
            }
        }

        function copyMegaPrompt() {
            if (state.currentMegaPrompt) {
                navigator.clipboard.writeText(state.currentMegaPrompt).then(() => {
                    showPromptgenStatus('Full Mega Prompt copied!', 'success');
                    setTimeout(() => showPromptgenStatus('', ''), 2000);
                });
            }
        }

        function copyMegaPromptCompiled() {
            const compiled = compileMegaPromptToSinglePrompt();
            if (compiled) {
                navigator.clipboard.writeText(compiled).then(() => {
                    showPromptgenStatus('Compiled prompt copied!', 'success');
                    setTimeout(() => showPromptgenStatus('', ''), 2000);
                });
            }
        }

        // Prompt Generator event listeners
        $('promptgenProductSelect')?.addEventListener('change', (e) => {
            state.activeProductId = e.target.value ? parseInt(e.target.value) : null;
            Storage.setIfOffline('activeProductId', state.activeProductId);
            // Sync to cloud if signed in
            if (currentUser) {
                saveSettingsToCloud({ activeProductId: state.activeProductId });
            }
            updateProductPreview();
            renderProducts();
        });

        $('generatePromptsBtn')?.addEventListener('click', generatePrompts);
        $('generateMegaPromptBtn')?.addEventListener('click', generateMegaPrompt);

        // Option button handlers for prompt count
        document.querySelectorAll('#promptCountButtons .option-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('#promptCountButtons .option-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                promptGenSettings.count = parseInt(btn.dataset.value);
            });
        });

        // Option button handlers for style focus
        document.querySelectorAll('#styleFocusButtons .option-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('#styleFocusButtons .option-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                promptGenSettings.style = btn.dataset.value;
            });
        });

        // Initialize Products and Prompt Generator on page load
        renderProducts();
        updateProductSelect();

        // ========== IMAGE BREAKDOWN TAB ==========
        let breakdownImageData = null;

        // Update breakdown product select
        function updateBreakdownProductSelect() {
            const select = $('breakdownProductSelect');
            if (!select) return;

            select.innerHTML = '<option value="">-- Just describe the image --</option>' +
                state.products.map(p =>
                    `<option value="${p.id}">${escapeHtml(p.name)}</option>`
                ).join('');
        }

        // Initialize breakdown product select when products change
        const originalRenderProductsForBreakdown = renderProducts;
        renderProducts = function() {
            originalRenderProductsForBreakdown();
            updateBreakdownProductSelect();
        };
        updateBreakdownProductSelect();

        // File upload handling
        const breakdownUploadArea = $('breakdownUploadArea');
        const breakdownFileInput = $('breakdownFileInput');
        const breakdownImagePreview = $('breakdownImagePreview');
        const breakdownPreviewImg = $('breakdownPreviewImg');
        const breakdownRemoveBtn = $('breakdownRemoveBtn');
        const analyzeImageBtn = $('analyzeImageBtn');

        breakdownUploadArea?.addEventListener('click', () => breakdownFileInput?.click());

        breakdownUploadArea?.addEventListener('dragover', (e) => {
            e.preventDefault();
            breakdownUploadArea.classList.add('dragover');
        });

        breakdownUploadArea?.addEventListener('dragleave', () => {
            breakdownUploadArea.classList.remove('dragover');
        });

        breakdownUploadArea?.addEventListener('drop', async (e) => {
            e.preventDefault();
            breakdownUploadArea.classList.remove('dragover');
            const file = e.dataTransfer.files[0];
            if (file && (file.type.startsWith('image/') || isHeicFile(file))) {
                await handleBreakdownImage(file);
            }
        });

        breakdownFileInput?.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (file) {
                await handleBreakdownImage(file);
            }
        });

        async function handleBreakdownImage(file) {
            // Process file (convert HEIC if needed)
            const result = await processImageFile(file);
            if (!result) {
                showStatus('Failed to load image', 'error');
                return;
            }

            breakdownPreviewImg.src = result.dataUrl;
            breakdownImagePreview.classList.add('show');
            breakdownUploadArea.style.display = 'none';
            analyzeImageBtn.disabled = false;

            // Store image data for API call
            breakdownImageData = {
                base64Data: result.base64,
                mimeType: result.mimeType
            };
        }

        breakdownRemoveBtn?.addEventListener('click', () => {
            breakdownPreviewImg.src = '';
            breakdownImagePreview.classList.remove('show');
            breakdownUploadArea.style.display = '';
            analyzeImageBtn.disabled = true;
            breakdownImageData = null;
            breakdownFileInput.value = '';
            $('breakdownOutput')?.classList.remove('show');
            $('breakdownRewrite')?.classList.remove('show');
        });

        // Analyze button click
        analyzeImageBtn?.addEventListener('click', async () => {
            if (!breakdownImageData) return;

            const modelSelect = $('breakdownModelSelect');
            const productSelect = $('breakdownProductSelect');
            const statusEl = $('breakdownStatus');
            const outputEl = $('breakdownOutput');
            const outputContent = $('breakdownOutputContent');
            const rewriteEl = $('breakdownRewrite');
            const rewriteContent = $('breakdownRewriteContent');

            const selectedModel = modelSelect?.value || 'pro';
            const selectedProductId = productSelect?.value;
            const selectedProduct = selectedProductId ? state.products.find(p => String(p.id) === String(selectedProductId)) : null;

            // Get model config
            const modelConfig = promptGenModels[selectedModel];
            if (!modelConfig) {
                statusEl.textContent = 'Invalid model selected';
                statusEl.className = 'status error';
                return;
            }

            const apiKey = Storage.get('apiKey', '');
            if (!apiKey) {
                statusEl.textContent = 'Please set your Gemini API key in the Editor tab';
                statusEl.className = 'status error';
                return;
            }

            // Show loading state
            analyzeImageBtn.disabled = true;
            analyzeImageBtn.innerHTML = '<span class="loader"></span> Analyzing...';
            statusEl.textContent = 'Analyzing image...';
            statusEl.className = 'status';
            outputEl.classList.remove('show');
            rewriteEl.classList.remove('show');

            try {
                // Build the analysis prompt - different if product is selected
                let analysisPrompt;

                if (selectedProduct) {
                    // Product-focused analysis - single prompt that analyzes AND creates product version
                    analysisPrompt = `Analyze this image and create a prompt to recreate it with a specific product.

STEP 1 - Briefly analyze these aspects of the image:
- Composition and framing
- Lighting (direction, quality, color temperature)
- Color palette and mood
- Background/environment
- Overall style and atmosphere

STEP 2 - Create an image generation prompt that recreates this EXACT visual concept but featuring this product:

**PRODUCT:** ${selectedProduct.name}
**Description:** ${selectedProduct.description || 'N/A'}
${(selectedProduct.goldenPhrases || []).length ? `**Include these phrases:** "${selectedProduct.goldenPhrases.join('", "')}"` : ''}
${(selectedProduct.forbiddenWords || []).length ? `**Never use:** ${selectedProduct.forbiddenWords.join(', ')}` : ''}

Your response should have two sections:
## Image Analysis
(Brief analysis of the original image)

## Product Prompt
(A detailed 400-600 character prompt ready for image generation that features "${selectedProduct.name}" as the main subject, using the same composition, lighting, colors, and mood as the original)`;
                } else {
                    // Generic analysis - no product
                    analysisPrompt = `Analyze this image in comprehensive detail. Describe:

1. **Subject/Main Focus**: What is the primary subject? Describe it precisely.
2. **Composition**: How is the image composed? Rule of thirds? Centered? Leading lines?
3. **Lighting**: What type of lighting is used? Direction, quality (hard/soft), color temperature.
4. **Color Palette**: What are the dominant colors? What mood do they create?
5. **Background/Environment**: Describe the setting or backdrop.
6. **Mood/Atmosphere**: What feeling does this image evoke?
7. **Style**: Is it minimalist, dramatic, warm, clinical, lifestyle, editorial, etc.?
8. **Technical Details**: Apparent camera angle, depth of field, any post-processing effects.

Be specific and detailed. This analysis will be used to recreate similar concepts.`;
                }

                const parts = [
                    {
                        inlineData: {
                            mimeType: breakdownImageData.mimeType,
                            data: breakdownImageData.base64Data
                        }
                    },
                    { text: analysisPrompt }
                ];

                // Build request body
                const requestBody = {
                    contents: [{ role: 'user', parts }],
                    generationConfig: {
                        temperature: 0.7,
                        maxOutputTokens: 8192
                    }
                };

                // Add thinking config if needed
                if (modelConfig.thinking) {
                    requestBody.generationConfig.thinkingConfig = {
                        thinkingBudget: modelConfig.thinking === 'minimal' ? 1024 :
                                       modelConfig.thinking === 'low' ? 4096 :
                                       modelConfig.thinking === 'medium' ? 8192 :
                                       modelConfig.thinking === 'high' ? 16384 : 4096
                    };
                }

                const response = await fetch(`${modelConfig.endpoint}?key=${encodeURIComponent(apiKey)}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error?.message || 'API request failed');
                }

                const data = await response.json();
                let analysisText = '';

                // Extract text from response (handle thinking models)
                if (data.candidates?.[0]?.content?.parts) {
                    for (const part of data.candidates[0].content.parts) {
                        if (part.text) {
                            analysisText = part.text;
                        }
                    }
                }

                if (!analysisText) {
                    throw new Error('No analysis generated');
                }

                // Display the analysis
                outputContent.textContent = analysisText;
                outputEl.classList.add('show');

                // If a product was selected, extract the Product Prompt section for easy copying
                if (selectedProduct) {
                    // Try to extract the Product Prompt section
                    const promptMatch = analysisText.match(/##\s*Product Prompt\s*\n([\s\S]*?)(?:$|##)/i);
                    if (promptMatch && promptMatch[1]) {
                        rewriteContent.textContent = promptMatch[1].trim();
                        rewriteEl.classList.add('show');
                    } else {
                        // If no specific section found, try to find any prompt-like content after analysis
                        const lines = analysisText.split('\n');
                        let promptStart = -1;
                        for (let i = 0; i < lines.length; i++) {
                            if (lines[i].toLowerCase().includes('product prompt') ||
                                lines[i].toLowerCase().includes('image generation prompt') ||
                                lines[i].toLowerCase().includes('prompt:')) {
                                promptStart = i + 1;
                                break;
                            }
                        }
                        if (promptStart > 0 && promptStart < lines.length) {
                            const promptText = lines.slice(promptStart).join('\n').trim();
                            if (promptText) {
                                rewriteContent.textContent = promptText;
                                rewriteEl.classList.add('show');
                            }
                        }
                    }
                    statusEl.textContent = 'Analysis and product prompt complete!';
                } else {
                    statusEl.textContent = 'Analysis complete!';
                }
                statusEl.className = 'status success';

            } catch (error) {
                console.error('Breakdown error:', error);
                statusEl.textContent = `Error: ${error.message}`;
                statusEl.className = 'status error';
            } finally {
                analyzeImageBtn.disabled = false;
                analyzeImageBtn.innerHTML = '<span>Analyze Image</span>';
            }
        });

        // Copy buttons
        $('copyBreakdownBtn')?.addEventListener('click', async () => {
            const content = $('breakdownOutputContent')?.textContent;
            if (content) {
                await navigator.clipboard.writeText(content);
                const btn = $('copyBreakdownBtn');
                btn.textContent = 'Copied!';
                btn.classList.add('copied');
                setTimeout(() => {
                    btn.textContent = 'Copy';
                    btn.classList.remove('copied');
                }, 2000);
            }
        });

        $('copyRewriteBtn')?.addEventListener('click', async () => {
            const content = $('breakdownRewriteContent')?.textContent;
            if (content) {
                await navigator.clipboard.writeText(content);
                const btn = $('copyRewriteBtn');
                btn.textContent = 'Copied!';
                btn.classList.add('copied');
                setTimeout(() => {
                    btn.textContent = 'Copy';
                    btn.classList.remove('copied');
                }, 2000);
            }
        });

        // Use in Editor button (for product rewrite)
        $('useRewriteBtn')?.addEventListener('click', () => {
            const content = $('breakdownRewriteContent')?.textContent;
            if (content) {
                // Switch to editor tab
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(tc => tc.classList.remove('active'));
                document.querySelector('.tab[data-tab="editor"]')?.classList.add('active');
                $('tab-editor')?.classList.add('active');

                // Set the prompt
                const promptInput = $('promptInput');
                if (promptInput) {
                    promptInput.value = content.trim();
                    promptInput.focus();
                }
            }
        });

        // Use in Editor button (for image analysis)
        $('useAnalysisBtn')?.addEventListener('click', () => {
            const content = $('breakdownOutputContent')?.textContent;
            if (content) {
                // Switch to editor tab
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(tc => tc.classList.remove('active'));
                document.querySelector('.tab[data-tab="editor"]')?.classList.add('active');
                $('tab-editor')?.classList.add('active');

                // Set the prompt
                const promptInput = $('promptInput');
                if (promptInput) {
                    promptInput.value = content.trim();
                    promptInput.focus();
                }
            }
        });

        // ========== LASSO SELECTION TOOL ==========
        const lassoModal = $('lassoModal');
        const lassoCanvas = $('lassoCanvas');
        const lassoImage = $('lassoImage');
        const lassoCanvasContainer = $('lassoCanvasContainer');
        const lassoPromptInput = $('lassoPromptInput');
        const lassoApplyBtn = $('lassoApplyBtn');
        const lassoBrushSize = $('lassoBrushSize');
        const lassoBrushSizeValue = $('lassoBrushSizeValue');

        let lassoCtx = null;
        let lassoState = {
            isDrawing: false,
            tool: 'brush',
            brushSize: 30,
            imageIndex: 0,
            imageSrc: null,
            hasSelection: false
        };

        function openLassoModal(index) {
            const img = state.generatedImages[index];
            if (!img) return;

            lassoState.imageIndex = index;
            lassoState.imageSrc = img.src;
            lassoState.hasSelection = false;

            lassoImage.src = img.src;
            lassoPromptInput.value = '';
            lassoApplyBtn.disabled = true;

            lassoModal.classList.add('active');

            // Wait for image to load before setting up canvas
            lassoImage.onload = () => {
                setupLassoCanvas();
            };

            // If already loaded
            if (lassoImage.complete) {
                setupLassoCanvas();
            }
        }

        function setupLassoCanvas() {
            const rect = lassoImage.getBoundingClientRect();
            lassoCanvas.width = lassoImage.naturalWidth;
            lassoCanvas.height = lassoImage.naturalHeight;
            lassoCanvas.style.width = rect.width + 'px';
            lassoCanvas.style.height = rect.height + 'px';

            lassoCtx = lassoCanvas.getContext('2d');
            lassoCtx.clearRect(0, 0, lassoCanvas.width, lassoCanvas.height);
        }

        function closeLassoModal() {
            lassoModal.classList.remove('active');
            lassoState.hasSelection = false;
        }

        function setLassoTool(tool) {
            lassoState.tool = tool;
            $('lassoBrushBtn').classList.toggle('active', tool === 'brush');
            $('lassoEraserBtn').classList.toggle('active', tool === 'eraser');
        }

        function clearLassoSelection() {
            if (lassoCtx) {
                lassoCtx.clearRect(0, 0, lassoCanvas.width, lassoCanvas.height);
                lassoState.hasSelection = false;
                updateLassoApplyButton();
            }
        }

        function updateLassoApplyButton() {
            const hasPrompt = lassoPromptInput.value.trim().length > 0;
            lassoApplyBtn.disabled = !lassoState.hasSelection || !hasPrompt;
        }

        // Canvas drawing events
        lassoCanvas.addEventListener('mousedown', startLassoDraw);
        lassoCanvas.addEventListener('mousemove', drawLasso);
        lassoCanvas.addEventListener('mouseup', stopLassoDraw);
        lassoCanvas.addEventListener('mouseleave', stopLassoDraw);

        // Touch support
        lassoCanvas.addEventListener('touchstart', (e) => { e.preventDefault(); startLassoDraw(e.touches[0]); });
        lassoCanvas.addEventListener('touchmove', (e) => { e.preventDefault(); drawLasso(e.touches[0]); });
        lassoCanvas.addEventListener('touchend', stopLassoDraw);

        function getCanvasCoords(e) {
            const rect = lassoCanvas.getBoundingClientRect();
            const scaleX = lassoCanvas.width / rect.width;
            const scaleY = lassoCanvas.height / rect.height;
            return {
                x: (e.clientX - rect.left) * scaleX,
                y: (e.clientY - rect.top) * scaleY
            };
        }

        function startLassoDraw(e) {
            lassoState.isDrawing = true;
            const coords = getCanvasCoords(e);
            lassoCtx.beginPath();
            lassoCtx.moveTo(coords.x, coords.y);
        }

        function drawLasso(e) {
            if (!lassoState.isDrawing) return;

            const coords = getCanvasCoords(e);
            const size = lassoState.brushSize * (lassoCanvas.width / lassoCanvas.getBoundingClientRect().width);

            lassoCtx.lineCap = 'round';
            lassoCtx.lineJoin = 'round';
            lassoCtx.lineWidth = size;

            if (lassoState.tool === 'brush') {
                lassoCtx.globalCompositeOperation = 'source-over';
                lassoCtx.strokeStyle = 'rgba(124, 58, 237, 0.5)';
            } else {
                lassoCtx.globalCompositeOperation = 'destination-out';
                lassoCtx.strokeStyle = 'rgba(0, 0, 0, 1)';
            }

            lassoCtx.lineTo(coords.x, coords.y);
            lassoCtx.stroke();
            lassoCtx.beginPath();
            lassoCtx.moveTo(coords.x, coords.y);

            lassoState.hasSelection = true;
            updateLassoApplyButton();
        }

        function stopLassoDraw() {
            lassoState.isDrawing = false;
            lassoCtx.beginPath();
        }

        // Brush size slider
        lassoBrushSize.addEventListener('input', (e) => {
            lassoState.brushSize = parseInt(e.target.value);
            lassoBrushSizeValue.textContent = e.target.value;
        });

        // Prompt input
        lassoPromptInput.addEventListener('input', updateLassoApplyButton);

        // Apply the lasso edit
        async function applyLassoEdit() {
            const prompt = lassoPromptInput.value.trim();
            if (!prompt || !lassoState.hasSelection) return;

            const apiKey = apiKeyInput.value.trim();
            const apiEndpoint = apiEndpointInput.value.trim();
            if (!apiKey || !apiEndpoint) {
                alert('Please configure your API key first');
                return;
            }

            lassoApplyBtn.disabled = true;
            lassoApplyBtn.textContent = 'Processing...';

            try {
                // Get the original image data
                const imgSrc = lassoState.imageSrc;
                const base64 = imgSrc.split(',')[1];
                const mimeType = imgSrc.split(';')[0].split(':')[1] || 'image/png';

                // Create a bright RED mask overlay (much more visible)
                const maskCanvas = document.createElement('canvas');
                maskCanvas.width = lassoCanvas.width;
                maskCanvas.height = lassoCanvas.height;
                const maskCtx = maskCanvas.getContext('2d');

                // Get the selection data and convert to bright red
                const selectionData = lassoCtx.getImageData(0, 0, lassoCanvas.width, lassoCanvas.height);
                const pixelData = selectionData.data;

                // Convert any painted pixels to bright red
                for (let i = 0; i < pixelData.length; i += 4) {
                    if (pixelData[i + 3] > 0) { // If pixel has any alpha (was painted)
                        pixelData[i] = 255;     // Red
                        pixelData[i + 1] = 0;   // Green
                        pixelData[i + 2] = 0;   // Blue
                        pixelData[i + 3] = 200; // Strong alpha
                    }
                }
                maskCtx.putImageData(selectionData, 0, 0);

                // Create composite with the bright red mask
                const compositeCanvas = document.createElement('canvas');
                compositeCanvas.width = lassoCanvas.width;
                compositeCanvas.height = lassoCanvas.height;
                const compositeCtx = compositeCanvas.getContext('2d');

                // Draw original image
                compositeCtx.drawImage(lassoImage, 0, 0);

                // Draw the bright red mask on top
                compositeCtx.drawImage(maskCanvas, 0, 0);

                // Get composite as base64
                const compositeDataUrl = compositeCanvas.toDataURL('image/png');
                const compositeBase64 = compositeDataUrl.split(',')[1];

                // Create a black and white mask (white = area to edit)
                const bwMaskCanvas = document.createElement('canvas');
                bwMaskCanvas.width = lassoCanvas.width;
                bwMaskCanvas.height = lassoCanvas.height;
                const bwMaskCtx = bwMaskCanvas.getContext('2d');

                // Fill with black background
                bwMaskCtx.fillStyle = 'black';
                bwMaskCtx.fillRect(0, 0, bwMaskCanvas.width, bwMaskCanvas.height);

                // Draw selection as white
                const bwImageData = bwMaskCtx.getImageData(0, 0, bwMaskCanvas.width, bwMaskCanvas.height);
                const origSelectionData = lassoCtx.getImageData(0, 0, lassoCanvas.width, lassoCanvas.height);
                for (let i = 0; i < origSelectionData.data.length; i += 4) {
                    if (origSelectionData.data[i + 3] > 0) {
                        bwImageData.data[i] = 255;     // R
                        bwImageData.data[i + 1] = 255; // G
                        bwImageData.data[i + 2] = 255; // B
                        bwImageData.data[i + 3] = 255; // A
                    }
                }
                bwMaskCtx.putImageData(bwImageData, 0, 0);

                // Get original image base64 (clean, no overlay)
                const originalBase64 = lassoState.imageSrc.split(',')[1];
                const originalMimeType = lassoState.imageSrc.split(';')[0].split(':')[1] || 'image/png';

                // Get mask as base64
                const maskDataUrl = bwMaskCanvas.toDataURL('image/png');
                const maskBase64 = maskDataUrl.split(',')[1];

                // Build prompt - send original image + mask separately
                const fullPrompt = `I'm providing two images:

IMAGE 1 (First image): The original photo to edit
IMAGE 2 (Second image): A black and white MASK where WHITE areas show exactly what to modify

YOUR TASK: ${prompt}

INSTRUCTIONS:
- Edit ONLY the areas marked in WHITE in the mask image
- Apply this edit to those white areas: "${prompt}"
- Keep ALL black areas of the mask COMPLETELY UNCHANGED
- The output should be a clean, natural-looking photo with the edit seamlessly applied
- Do NOT include any mask overlay or markings in the output

Generate the edited version of the first image.`;

                const parts = [
                    { inlineData: { mimeType: originalMimeType, data: originalBase64 } },
                    { inlineData: { mimeType: 'image/png', data: maskBase64 } },
                    { text: fullPrompt }
                ];

                const response = await fetch(`${apiEndpoint}?key=${encodeURIComponent(apiKey)}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts }],
                        generationConfig: { responseModalities: ['IMAGE', 'TEXT'] }
                    })
                });

                if (!response.ok) throw new Error(`API Error: ${response.status}`);

                const data = await response.json();
                let resultImage = null;

                if (data.candidates) {
                    for (const candidate of data.candidates) {
                        for (const part of candidate.content?.parts || []) {
                            if (part.inlineData) {
                                const resultMimeType = part.inlineData.mimeType || 'image/png';
                                resultImage = `data:${resultMimeType};base64,${part.inlineData.data}`;
                                break;
                            }
                        }
                        if (resultImage) break;
                    }
                }

                if (resultImage) {
                    // Add to generated images
                    state.generatedImages.push({ src: resultImage, mimeType: 'image/png' });
                    displayResult(state.generatedImages);
                    closeLassoModal();
                    showStatus('Area edit complete!', 'success');
                } else {
                    throw new Error('No image in response');
                }

            } catch (error) {
                console.error('Lasso edit error:', error);
                showStatus('Error applying edit: ' + error.message, 'error');
            } finally {
                lassoApplyBtn.disabled = false;
                lassoApplyBtn.textContent = 'Apply Edit';
            }
        }

        // Close on escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && lassoModal.classList.contains('active')) {
                closeLassoModal();
            }
        });
    </script>
</body>
</html>
